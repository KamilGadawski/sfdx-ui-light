<template>
    <template lwc:if={hasError}>
        <slds-information-block class="slds-p-around_x-small" title={error_title} variant="error">
            <p>{error_message}</p>
        </slds-information-block>
    </template>
    <div class="assistant-container slds-fill-height slds-is-relative">
        <!-- Prompt Result -->
        <section role="log" class="slds-chat slds-fill-height">
            <div class="slds-grid slds-wrap slds-grid_align-center">
                <div
                    class="slds-col slds-size_1-of-1 slds-medium-size_10-of-12 slds-large-size_10-of-12">
                    <ul class="slds-chat-list">
                        <template for:each={formattedMessages} for:item="item">
                            <assistant-message
                                key={item.id}
                                item={item}
                                dialog-id={dialogId}
                                onretry={handleRetryMessage}></assistant-message>
                        </template>
                        <template lwc:if={isLoading}>
                            <li class="slds-chat-listitem slds-chat-listitem_inbound">
                                <div class="slds-chat-message">
                                    <div class="slds-chat-message__body">
                                        <div
                                            class="slds-chat-message__text slds-chat-message__text_inbound slds-chat-loading">
                                            <span
                                                class="slds-icon-typing slds-is-animated"
                                                title="Analyzing your request">
                                                <span class="slds-icon-typing__dot"></span>
                                                <span class="slds-icon-typing__dot"></span>
                                                <span class="slds-icon-typing__dot"></span>
                                                <span class="slds-assistive-text">
                                                    Analyzing your request
                                                </span>
                                            </span>
                                            <span aria-hidden="true">Analyzing your request</span>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </template>
                    </ul>
                </div>
            </div>
        </section>
        <!-- Prompt Entry -->
        <div class="slds-publisher slds-is-active slds-p-left_small slds-p-right_small slds-p-bottom_x-small">
            <div class="slds-grid slds-wrap slds-grid_align-center">
                <div class="slds-col slds-size_1-of-1 slds-medium-size_2-of-3 slds-large-size_1-of-2">
                    <div class="chat-input-container file-upload-container" ondragover={handleDragOver} ondragleave={handleDragLeave} ondrop={handleDrop}>
                        <div class="chat-input-pills-row">
                            <template lwc:if={hasFiles}>
                                <template for:each={filePills} for:item="pill">
                                    <div key={pill.file.name} class="chat-pill" tabindex="0" aria-label={pill.file.name}>
                                        <template lwc:if={pill.isImage}>
                                            <img src={pill.preview} alt="Image preview" class="chat-pill-thumbnail" />
                                            <span>Image</span>
                                        </template>
                                        <template lwc:else>
                                            <span class="chat-pill-icon">ðŸ“Ž</span>
                                            <span>{pill.file.name}</span>
                                        </template>
                                        <button class="chat-pill-remove" title="Remove file" aria-label="Remove file" data-filename={pill.file.name} onclick={removeSelectedFile} tabindex="0">Ã—</button>
                                    </div>
                                </template>
                            </template>
                        </div>
                        <textarea
                            class="chat-textarea"
                            placeholder="Write a promptâ€¦"
                            onkeydown={handleKeyDown}
                            onkeyup={handleInputChange}
                            onpaste={handleInputChange}
                            disabled={isLoading}
                            aria-label="Prompt input"
                        ></textarea>
                        <div class="chat-input-actions-row">
                            <div class="chat-input-actions-left">
                                <template lwc:if={isAudioAssistantDisplayed}>
                                    <assistant-audio-recorder
                                        openai-key={openaiKey}
                                        onchange={handleSpeechChange}
                                    ></assistant-audio-recorder>
                                </template>
                            </div>
                            <div class="chat-input-actions-right">
                                <!-- <button class="chat-btn" title="Attach File" aria-label="Attach File" onclick={triggerFileInput} tabindex="0" disabled={isLoading}>
                                    <lightning-icon icon-name="utility:attach" size="x-small" alternative-text="Attach File"></lightning-icon>
                                </button> -->
                                <button class="chat-btn" title="Clear" aria-label="Clear" onclick={handleClearClick} tabindex="0" disabled={isClearButtonDisabled}>
                                    <lightning-icon icon-name="utility:delete" size="x-small" alternative-text="Clear"></lightning-icon>
                                </button>
                                <button class="chat-btn" title="Send" aria-label="Send" onclick={handleSendClick} tabindex="0" disabled={isSendButtonDisabled}>
                                    <lightning-icon icon-name="utility:send" size="x-small" alternative-text="Send"></lightning-icon>
                                </button>
                                <!-- <template lwc:if={isLoading}>
                                    <button class="chat-btn" title="Stop" aria-label="Stop" onclick={handleStopClick} tabindex="0">
                                        <lightning-icon icon-name="utility:stop" size="x-small" alternative-text="Stop"></lightning-icon>
                                    </button>
                                </template>
                                <template lwc:else>
                                    <button class="chat-btn" title="Send" aria-label="Send" onclick={handleSendClick} tabindex="0">
                                        <lightning-icon icon-name="utility:send" size="x-small" alternative-text="Send"></lightning-icon>
                                    </button>
                                </template> -->
                            </div>
                            <input type="file" class="file-input" onchange={handleFileChange} aria-label="File input" tabindex="-1" multiple />
                        </div>
                        <template lwc:if={dragActive}>
                            <div class="file-upload-drag-overlay">Drop images or PDFs here</div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>
