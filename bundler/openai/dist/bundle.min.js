!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("OpenAIAgentsBundle",[],t):"object"==typeof exports?exports.OpenAIAgentsBundle=t():e.OpenAIAgentsBundle=t()}(this,()=>(()=>{var e={585:e=>{var t=1e3,n=60*t,s=60*n,r=24*s,a=7*r;function i(e,t,n,s){var r=t>=1.5*n;return Math.round(e/n)+" "+s+(r?"s":"")}e.exports=function(e,o){o=o||{};var c,u,l=typeof e;if("string"===l&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var i=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(i){var o=parseFloat(i[1]);switch((i[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*o;case"weeks":case"week":case"w":return o*a;case"days":case"day":case"d":return o*r;case"hours":case"hour":case"hrs":case"hr":case"h":return o*s;case"minutes":case"minute":case"mins":case"min":case"m":return o*n;case"seconds":case"second":case"secs":case"sec":case"s":return o*t;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return o;default:return}}}}(e);if("number"===l&&isFinite(e))return o.long?(c=e,(u=Math.abs(c))>=r?i(c,u,r,"day"):u>=s?i(c,u,s,"hour"):u>=n?i(c,u,n,"minute"):u>=t?i(c,u,t,"second"):c+" ms"):function(e){var a=Math.abs(e);return a>=r?Math.round(e/r)+"d":a>=s?Math.round(e/s)+"h":a>=n?Math.round(e/n)+"m":a>=t?Math.round(e/t)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},736:(e,t,n)=>{e.exports=function(e){function t(e){let n,r,a,i=null;function o(...e){if(!o.enabled)return;const s=o,r=Number(new Date),a=r-(n||r);s.diff=a,s.prev=n,s.curr=r,n=r,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let i=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(n,r)=>{if("%%"===n)return"%";i++;const a=t.formatters[r];if("function"==typeof a){const t=e[i];n=a.call(s,t),e.splice(i,1),i--}return n}),t.formatArgs.call(s,e),(s.log||t.log).apply(s,e)}return o.namespace=e,o.useColors=t.useColors(),o.color=t.selectColor(e),o.extend=s,o.destroy=t.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==i?i:(r!==t.namespaces&&(r=t.namespaces,a=t.enabled(e)),a),set:e=>{i=e}}),"function"==typeof t.init&&t.init(o),o}function s(e,n){const s=t(this.namespace+(void 0===n?":":n)+e);return s.log=this.log,s}function r(e,t){let n=0,s=0,r=-1,a=0;for(;n<e.length;)if(s<t.length&&(t[s]===e[n]||"*"===t[s]))"*"===t[s]?(r=s,a=n,s++):(n++,s++);else{if(-1===r)return!1;s=r+1,a++,n=a}for(;s<t.length&&"*"===t[s];)s++;return s===t.length}return t.debug=t,t.default=t,t.coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){const e=[...t.names,...t.skips.map(e=>"-"+e)].join(",");return t.enable(""),e},t.enable=function(e){t.save(e),t.namespaces=e,t.names=[],t.skips=[];const n=("string"==typeof e?e:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const e of n)"-"===e[0]?t.skips.push(e.slice(1)):t.names.push(e)},t.enabled=function(e){for(const n of t.skips)if(r(e,n))return!1;for(const n of t.names)if(r(e,n))return!0;return!1},t.humanize=n(585),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach(n=>{t[n]=e[n]}),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let n=0;for(let t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return t.colors[Math.abs(n)%t.colors.length]},t.enable(t.load()),t}},833:(e,t,n)=>{t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;t.splice(1,0,n,"color: inherit");let s=0,r=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(s++,"%c"===e&&(r=s))}),t.splice(r,0,n)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")||t.storage.getItem("DEBUG")}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let e;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&(e=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(e[1],10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=n(736)(t);const{formatters:s}=e.exports;s.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}},t={};function n(s){var r=t[s];if(void 0!==r)return r.exports;var a=t[s]={exports:{}};return e[s](a,a.exports,n),a.exports}n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};return(()=>{"use strict";n.r(s),n.d(s,{Agents:()=>i,AgentsCore:()=>t,AgentsOpenAI:()=>r});var e={};n.r(e),n.d(e,{AssistantContent:()=>ti,AssistantMessageItem:()=>si,AudioContent:()=>Ha,ComputerCallResultItem:()=>pi,ComputerToolOutput:()=>Qa,ComputerUseCallItem:()=>di,FunctionCallItem:()=>ui,FunctionCallResultItem:()=>li,HostedToolCallItem:()=>ci,ImageContent:()=>Va,InputFile:()=>Ka,InputImage:()=>Ga,InputText:()=>Wa,ItemBase:()=>Ba,MessageItem:()=>oi,ModelItem:()=>_i,OutputModelItem:()=>gi,OutputText:()=>za,ReasoningItem:()=>mi,Refusal:()=>Ja,SharedBase:()=>Ua,StreamEvent:()=>Si,StreamEventGenericItem:()=>xi,StreamEventResponseCompleted:()=>bi,StreamEventResponseStarted:()=>wi,StreamEventTextStream:()=>vi,ToolCallItem:()=>hi,ToolOutputImage:()=>Ya,ToolOutputText:()=>Xa,UnknownItem:()=>fi,UsageData:()=>yi,UserContent:()=>ri,UserMessageItem:()=>ai,computerActions:()=>ei});var t={};n.r(t),n.d(t,{Agent:()=>Co,AgentHooks:()=>Ea,AgentsError:()=>Jt,BatchTraceProcessor:()=>Fr,ConsoleSpanExporter:()=>Lr,GuardrailExecutionError:()=>Ht,Handoff:()=>ja,InputGuardrailTripwireTriggered:()=>Xt,MCPServerStdio:()=>pr,MCPServerStreamableHttp:()=>hr,MaxTurnsExceededError:()=>Wt,ModelBehaviorError:()=>Gt,NoopSpan:()=>Xr,NoopTrace:()=>Qr,OutputGuardrailTripwireTriggered:()=>Yt,RunAgentUpdatedStreamEvent:()=>Bi,RunContext:()=>Ii,RunHandoffCallItem:()=>ji,RunItemStreamEvent:()=>Ui,RunMessageOutputItem:()=>Ni,RunRawModelStreamEvent:()=>qi,RunReasoningItem:()=>Di,RunResult:()=>Ai,RunState:()=>yo,RunToolApprovalItem:()=>Zi,RunToolCallItem:()=>Pi,RunToolCallOutputItem:()=>$i,Runner:()=>ko,RuntimeEventEmitter:()=>br,Span:()=>Vr,StreamedRunResult:()=>Ci,SystemError:()=>zt,ToolCallError:()=>Vt,Trace:()=>Yr,TraceProvider:()=>ea,Usage:()=>ki,UserError:()=>Kt,addTraceProcessor:()=>Ta,assistant:()=>Eo,computerTool:()=>mn,createAgentSpan:()=>ia,createCustomSpan:()=>ma,createFunctionSpan:()=>ca,createGenerationSpan:()=>pa,createGuardrailSpan:()=>ga,createHandoffSpan:()=>la,createMCPListToolsSpan:()=>ka,createResponseSpan:()=>ra,createSpeechGroupSpan:()=>xa,createSpeechSpan:()=>wa,createTranscriptionSpan:()=>ya,defineOutputGuardrail:()=>$a,extractAllTextOutput:()=>Li,generateGroupId:()=>Hr,generateSpanId:()=>Kr,generateTraceId:()=>Gr,getAllMcpTools:()=>_r,getCurrentSpan:()=>Er,getCurrentTrace:()=>Rr,getGlobalTraceProvider:()=>na,getHandoff:()=>Za,getLogger:()=>ln,getOrCreateTrace:()=>$r,getTransferMessage:()=>Da,handoff:()=>Ma,hostedMcpTool:()=>fn,invalidateServerToolsCache:()=>fr,protocol:()=>e,resetCurrentSpan:()=>jr,run:()=>Ao,setCurrentSpan:()=>Dr,setDefaultModelProvider:()=>Fa,setTraceProcessors:()=>Aa,setTracingDisabled:()=>Ca,startTraceExportLoop:()=>Oa,system:()=>Ro,tool:()=>_n,user:()=>Oo,withAgentSpan:()=>oa,withCustomSpan:()=>fa,withFunctionSpan:()=>ua,withGenerationSpan:()=>ha,withGuardrailSpan:()=>_a,withHandoffSpan:()=>da,withMCPListToolsSpan:()=>Ia,withResponseSpan:()=>aa,withSpeechGroupSpan:()=>Sa,withSpeechSpan:()=>ba,withTrace:()=>Pr,withTranscriptionSpan:()=>va});var r={};n.r(r),n.d(r,{OpenAIChatCompletionsModel:()=>pp,OpenAIProvider:()=>hp,OpenAIResponsesModel:()=>rp,OpenAITracingExporter:()=>mp,codeInterpreterTool:()=>Wd,fileSearchTool:()=>zd,imageGenerationTool:()=>Gd,setDefaultOpenAIClient:()=>jd,setDefaultOpenAIKey:()=>Md,setDefaultOpenAITracingExporter:()=>fp,setOpenAIAPI:()=>Dd,setTracingExportApiKey:()=>$d,webSearchTool:()=>Jd});var a={};n.r(a),n.d(a,{DEFAULT_OPENAI_REALTIME_MODEL:()=>Th,DEFAULT_OPENAI_REALTIME_SESSION_CONFIG:()=>Ah,ModelBehaviorError:()=>Gt,OpenAIRealtimeBase:()=>Ch,OpenAIRealtimeWebRTC:()=>Oh,OpenAIRealtimeWebSocket:()=>Eh,OutputGuardrailTripwireTriggered:()=>Yt,RealtimeAgent:()=>kp,RealtimeSession:()=>Nh,UserError:()=>Kt,tool:()=>_n,utils:()=>Ph});var i={};async function o(e){try{return[null,await e()]}catch(e){return[e,null]}}function c(e){return"object"==typeof e&&null!==e&&("name"in e&&"AbortError"===e.name||"message"in e&&String(e.message).includes("FetchRequestCanceledException"))}n.r(i),n.d(i,{Agent:()=>Co,AgentHooks:()=>Ea,AgentsError:()=>Jt,BatchTraceProcessor:()=>Fr,ConsoleSpanExporter:()=>Lr,GuardrailExecutionError:()=>Ht,Handoff:()=>ja,InputGuardrailTripwireTriggered:()=>Xt,MCPServerStdio:()=>pr,MCPServerStreamableHttp:()=>hr,MaxTurnsExceededError:()=>Wt,ModelBehaviorError:()=>Gt,NoopSpan:()=>Xr,NoopTrace:()=>Qr,OpenAIChatCompletionsModel:()=>pp,OpenAIProvider:()=>hp,OpenAIResponsesModel:()=>rp,OpenAITracingExporter:()=>mp,OutputGuardrailTripwireTriggered:()=>Yt,RunAgentUpdatedStreamEvent:()=>Bi,RunContext:()=>Ii,RunHandoffCallItem:()=>ji,RunItemStreamEvent:()=>Ui,RunMessageOutputItem:()=>Ni,RunRawModelStreamEvent:()=>qi,RunReasoningItem:()=>Di,RunResult:()=>Ai,RunState:()=>yo,RunToolApprovalItem:()=>Zi,RunToolCallItem:()=>Pi,RunToolCallOutputItem:()=>$i,Runner:()=>ko,RuntimeEventEmitter:()=>br,Span:()=>Vr,StreamedRunResult:()=>Ci,SystemError:()=>zt,ToolCallError:()=>Vt,Trace:()=>Yr,TraceProvider:()=>ea,Usage:()=>ki,UserError:()=>Kt,addTraceProcessor:()=>Ta,assistant:()=>Eo,codeInterpreterTool:()=>Wd,computerTool:()=>mn,createAgentSpan:()=>ia,createCustomSpan:()=>ma,createFunctionSpan:()=>ca,createGenerationSpan:()=>pa,createGuardrailSpan:()=>ga,createHandoffSpan:()=>la,createMCPListToolsSpan:()=>ka,createResponseSpan:()=>ra,createSpeechGroupSpan:()=>xa,createSpeechSpan:()=>wa,createTranscriptionSpan:()=>ya,defineOutputGuardrail:()=>$a,extractAllTextOutput:()=>Li,fileSearchTool:()=>zd,generateGroupId:()=>Hr,generateSpanId:()=>Kr,generateTraceId:()=>Gr,getAllMcpTools:()=>_r,getCurrentSpan:()=>Er,getCurrentTrace:()=>Rr,getGlobalTraceProvider:()=>na,getHandoff:()=>Za,getLogger:()=>ln,getOrCreateTrace:()=>$r,getTransferMessage:()=>Da,handoff:()=>Ma,hostedMcpTool:()=>fn,imageGenerationTool:()=>Gd,invalidateServerToolsCache:()=>fr,protocol:()=>e,realtime:()=>a,resetCurrentSpan:()=>jr,run:()=>Ao,setCurrentSpan:()=>Dr,setDefaultModelProvider:()=>Fa,setDefaultOpenAIClient:()=>jd,setDefaultOpenAIKey:()=>Md,setDefaultOpenAITracingExporter:()=>fp,setOpenAIAPI:()=>Dd,setTraceProcessors:()=>Aa,setTracingDisabled:()=>Ca,setTracingExportApiKey:()=>$d,startTraceExportLoop:()=>Oa,system:()=>Ro,tool:()=>_n,user:()=>Oo,webSearchTool:()=>Jd,withAgentSpan:()=>oa,withCustomSpan:()=>fa,withFunctionSpan:()=>ua,withGenerationSpan:()=>ha,withGuardrailSpan:()=>_a,withHandoffSpan:()=>da,withMCPListToolsSpan:()=>Ia,withResponseSpan:()=>aa,withSpeechGroupSpan:()=>Sa,withSpeechSpan:()=>ba,withTrace:()=>Pr,withTranscriptionSpan:()=>va});const u=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e){try{if("[object Error]"===Object.prototype.toString.call(e)){const t=new Error(e.message,e.cause?{cause:e.cause}:{});return e.stack&&(t.stack=e.stack),e.cause&&!t.cause&&(t.cause=e.cause),e.name&&(t.name=e.name),t}}catch{}try{return new Error(JSON.stringify(e))}catch{}}return new Error(e)};class l extends Error{}class d extends l{constructor(e,t,n,s){super(`${d.makeMessage(e,t,n)}`),this.status=e,this.headers=s,this.requestID=s?.get("x-request-id"),this.error=t;const r=t;this.code=r?.code,this.param=r?.param,this.type=r?.type}static makeMessage(e,t,n){const s=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,n,s){if(!e||!s)return new h({message:n,cause:u(t)});const r=t?.error;return 400===e?new f(e,r,n,s):401===e?new g(e,r,n,s):403===e?new _(e,r,n,s):404===e?new y(e,r,n,s):409===e?new v(e,r,n,s):422===e?new w(e,r,n,s):429===e?new b(e,r,n,s):e>=500?new x(e,r,n,s):new d(e,r,n,s)}}class p extends d{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class h extends d{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class m extends h{constructor({message:e}={}){super({message:e??"Request timed out."})}}class f extends d{}class g extends d{}class _ extends d{}class y extends d{}class v extends d{}class w extends d{}class b extends d{}class x extends d{}class S extends l{constructor(){super("Could not parse response content as the length limit was reached")}}class k extends l{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class I extends Error{constructor(e){super(e)}}function T(e){return"auto-parseable-response-format"===e?.$brand}function A(e){return"auto-parseable-tool"===e?.$brand}function C(e,t){const n=e.choices.map(e=>{if("length"===e.finish_reason)throw new S;if("content_filter"===e.finish_reason)throw new k;return{...e,message:{...e.message,...e.message.tool_calls?{tool_calls:e.message.tool_calls?.map(e=>function(e,t){const n=e.tools?.find(e=>e.function?.name===t.function.name);return{...t,function:{...t.function,parsed_arguments:A(n)?n.$parseRaw(t.function.arguments):n?.function.strict?JSON.parse(t.function.arguments):null}}}(t,e))??void 0}:void 0,parsed:e.message.content&&!e.message.refusal?O(t,e.message.content):null}}});return{...e,choices:n}}function O(e,t){return"json_schema"!==e.response_format?.type?null:"json_schema"===e.response_format?.type?"$parseRaw"in e.response_format?e.response_format.$parseRaw(t):JSON.parse(t):null}function R(e,t){if(!e)return!1;const n=e.tools?.find(e=>e.function?.name===t.function.name);return A(n)||n?.function.strict||!1}function E(e){return!!T(e.response_format)||(e.tools?.some(e=>A(e)||"function"===e.type&&!0===e.function.strict)??!1)}const N=Symbol("Let zodToJsonSchema decide on which parser to use"),P={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},$=e=>"_def"in e?e._def:e;var D,j;!function(e){e.assertEqual=e=>{},e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const n of e)t[n]=n;return t},e.getValidEnumValues=t=>{const n=e.objectKeys(t).filter(e=>"number"!=typeof t[t[e]]),s={};for(const e of n)s[e]=t[e];return e.objectValues(s)},e.objectValues=t=>e.objectKeys(t).map(function(e){return t[e]}),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},e.find=(e,t)=>{for(const n of e)if(t(n))return n},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&Number.isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map(e=>"string"==typeof e?`'${e}'`:e).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(D||(D={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(j||(j={}));const M=D.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Z=e=>{switch(typeof e){case"undefined":return M.undefined;case"string":return M.string;case"number":return Number.isNaN(e)?M.nan:M.number;case"boolean":return M.boolean;case"function":return M.function;case"bigint":return M.bigint;case"symbol":return M.symbol;case"object":return Array.isArray(e)?M.array:null===e?M.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?M.promise:"undefined"!=typeof Map&&e instanceof Map?M.map:"undefined"!=typeof Set&&e instanceof Set?M.set:"undefined"!=typeof Date&&e instanceof Date?M.date:M.object;default:return M.unknown}},L=D.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class F extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(e){return e.message},n={_errors:[]},s=e=>{for(const r of e.issues)if("invalid_union"===r.code)r.unionErrors.map(s);else if("invalid_return_type"===r.code)s(r.returnTypeError);else if("invalid_arguments"===r.code)s(r.argumentsError);else if(0===r.path.length)n._errors.push(t(r));else{let e=n,s=0;for(;s<r.path.length;){const n=r.path[s];s===r.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(t(r))):e[n]=e[n]||{_errors:[]},e=e[n],s++}}};return s(this),n}static assert(e){if(!(e instanceof F))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,D.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},n=[];for(const s of this.issues)s.path.length>0?(t[s.path[0]]=t[s.path[0]]||[],t[s.path[0]].push(e(s))):n.push(e(s));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}F.create=e=>new F(e);const q=(e,t)=>{let n;switch(e.code){case L.invalid_type:n=e.received===M.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case L.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(e.expected,D.jsonStringifyReplacer)}`;break;case L.unrecognized_keys:n=`Unrecognized key(s) in object: ${D.joinValues(e.keys,", ")}`;break;case L.invalid_union:n="Invalid input";break;case L.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${D.joinValues(e.options)}`;break;case L.invalid_enum_value:n=`Invalid enum value. Expected ${D.joinValues(e.options)}, received '${e.received}'`;break;case L.invalid_arguments:n="Invalid function arguments";break;case L.invalid_return_type:n="Invalid function return type";break;case L.invalid_date:n="Invalid date";break;case L.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(n=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(n=`${n} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?n=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?n=`Invalid input: must end with "${e.validation.endsWith}"`:D.assertNever(e.validation):n="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case L.too_small:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case L.too_big:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case L.custom:n="Invalid input";break;case L.invalid_intersection_types:n="Intersection results could not be merged";break;case L.not_multiple_of:n=`Number must be a multiple of ${e.multipleOf}`;break;case L.not_finite:n="Number must be finite";break;default:n=t.defaultError,D.assertNever(e)}return{message:n}};let U=q;function B(e,t){const n=U,s=(e=>{const{data:t,path:n,errorMaps:s,issueData:r}=e,a=[...n,...r.path||[]],i={...r,path:a};if(void 0!==r.message)return{...r,path:a,message:r.message};let o="";const c=s.filter(e=>!!e).slice().reverse();for(const e of c)o=e(i,{data:t,defaultError:o}).message;return{...r,path:a,message:o}})({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,n,n===q?void 0:q].filter(e=>!!e)});e.common.issues.push(s)}class J{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const s of t){if("aborted"===s.status)return z;"dirty"===s.status&&e.dirty(),n.push(s.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const e of t){const t=await e.key,s=await e.value;n.push({key:t,value:s})}return J.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const s of t){const{key:t,value:r}=s;if("aborted"===t.status)return z;if("aborted"===r.status)return z;"dirty"===t.status&&e.dirty(),"dirty"===r.status&&e.dirty(),"__proto__"===t.value||void 0===r.value&&!s.alwaysSet||(n[t.value]=r.value)}return{status:e.value,value:n}}}const z=Object.freeze({status:"aborted"}),W=e=>({status:"dirty",value:e}),G=e=>({status:"valid",value:e}),K=e=>"aborted"===e.status,H=e=>"dirty"===e.status,V=e=>"valid"===e.status,X=e=>"undefined"!=typeof Promise&&e instanceof Promise;var Y;!function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:e?.message}(Y||(Y={}));class Q{constructor(e,t,n,s){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=s}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const ee=(e,t)=>{if(V(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new F(e.common.issues);return this._error=t,this._error}}};function te(e){if(!e)return{};const{errorMap:t,invalid_type_error:n,required_error:s,description:r}=e;if(t&&(n||s))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:r}:{errorMap:(t,r)=>{const{message:a}=e;return"invalid_enum_value"===t.code?{message:a??r.defaultError}:void 0===r.data?{message:a??s??r.defaultError}:"invalid_type"!==t.code?{message:r.defaultError}:{message:a??n??r.defaultError}},description:r}}class ne{get description(){return this._def.description}_getType(e){return Z(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Z(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new J,ctx:{common:e.parent.common,data:e.data,parsedType:Z(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(X(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){const n={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Z(e)},s=this._parseSync({data:e,path:n.path,parent:n});return ee(n,s)}"~validate"(e){const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Z(e)};if(!this["~standard"].async)try{const n=this._parseSync({data:e,path:[],parent:t});return V(n)?{value:n.value}:{issues:t.common.issues}}catch(e){e?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(e=>V(e)?{value:e.value}:{issues:t.common.issues})}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Z(e)},s=this._parse({data:e,path:n.path,parent:n}),r=await(X(s)?s:Promise.resolve(s));return ee(n,r)}refine(e,t){const n=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement((t,s)=>{const r=e(t),a=()=>s.addIssue({code:L.custom,...n(t)});return"undefined"!=typeof Promise&&r instanceof Promise?r.then(e=>!!e||(a(),!1)):!!r||(a(),!1)})}refinement(e,t){return this._refinement((n,s)=>!!e(n)||(s.addIssue("function"==typeof t?t(n,s):t),!1))}_refinement(e){return new et({schema:this,typeName:ut.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return tt.create(this,this._def)}nullable(){return nt.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Le.create(this)}promise(){return Qe.create(this,this._def)}or(e){return Ue.create([this,e],this._def)}and(e){return Je.create(this,e,this._def)}transform(e){return new et({...te(this._def),schema:this,typeName:ut.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new st({...te(this._def),innerType:this,defaultValue:t,typeName:ut.ZodDefault})}brand(){return new it({typeName:ut.ZodBranded,type:this,...te(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new rt({...te(this._def),innerType:this,catchValue:t,typeName:ut.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return ot.create(this,e)}readonly(){return ct.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const se=/^c[^\s-]{8,}$/i,re=/^[0-9a-z]+$/,ae=/^[0-9A-HJKMNP-TV-Z]{26}$/i,ie=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,oe=/^[a-z0-9_-]{21}$/i,ce=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,ue=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,le=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let de;const pe=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,he=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,me=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,fe=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,ge=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,_e=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,ye="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",ve=new RegExp(`^${ye}$`);function we(e){let t="[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),`([01]\\d|2[0-3]):[0-5]\\d(:${t})${e.precision?"+":"?"}`}function be(e){return new RegExp(`^${we(e)}$`)}function xe(e){let t=`${ye}T${we(e)}`;const n=[];return n.push(e.local?"Z?":"Z"),e.offset&&n.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${n.join("|")})`,new RegExp(`^${t}$`)}function Se(e,t){return!("v4"!==t&&t||!pe.test(e))||!("v6"!==t&&t||!me.test(e))}function ke(e,t){if(!ce.test(e))return!1;try{const[n]=e.split("."),s=n.replace(/-/g,"+").replace(/_/g,"/").padEnd(n.length+(4-n.length%4)%4,"="),r=JSON.parse(atob(s));return!("object"!=typeof r||null===r||"typ"in r&&"JWT"!==r?.typ||!r.alg||t&&r.alg!==t)}catch{return!1}}function Ie(e,t){return!("v4"!==t&&t||!he.test(e))||!("v6"!==t&&t||!fe.test(e))}class Te extends ne{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==M.string){const t=this._getOrReturnCtx(e);return B(t,{code:L.invalid_type,expected:M.string,received:t.parsedType}),z}const t=new J;let n;for(const s of this._def.checks)if("min"===s.kind)e.data.length<s.value&&(n=this._getOrReturnCtx(e,n),B(n,{code:L.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("max"===s.kind)e.data.length>s.value&&(n=this._getOrReturnCtx(e,n),B(n,{code:L.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("length"===s.kind){const r=e.data.length>s.value,a=e.data.length<s.value;(r||a)&&(n=this._getOrReturnCtx(e,n),r?B(n,{code:L.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):a&&B(n,{code:L.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),t.dirty())}else if("email"===s.kind)le.test(e.data)||(n=this._getOrReturnCtx(e,n),B(n,{validation:"email",code:L.invalid_string,message:s.message}),t.dirty());else if("emoji"===s.kind)de||(de=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),de.test(e.data)||(n=this._getOrReturnCtx(e,n),B(n,{validation:"emoji",code:L.invalid_string,message:s.message}),t.dirty());else if("uuid"===s.kind)ie.test(e.data)||(n=this._getOrReturnCtx(e,n),B(n,{validation:"uuid",code:L.invalid_string,message:s.message}),t.dirty());else if("nanoid"===s.kind)oe.test(e.data)||(n=this._getOrReturnCtx(e,n),B(n,{validation:"nanoid",code:L.invalid_string,message:s.message}),t.dirty());else if("cuid"===s.kind)se.test(e.data)||(n=this._getOrReturnCtx(e,n),B(n,{validation:"cuid",code:L.invalid_string,message:s.message}),t.dirty());else if("cuid2"===s.kind)re.test(e.data)||(n=this._getOrReturnCtx(e,n),B(n,{validation:"cuid2",code:L.invalid_string,message:s.message}),t.dirty());else if("ulid"===s.kind)ae.test(e.data)||(n=this._getOrReturnCtx(e,n),B(n,{validation:"ulid",code:L.invalid_string,message:s.message}),t.dirty());else if("url"===s.kind)try{new URL(e.data)}catch{n=this._getOrReturnCtx(e,n),B(n,{validation:"url",code:L.invalid_string,message:s.message}),t.dirty()}else"regex"===s.kind?(s.regex.lastIndex=0,s.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),B(n,{validation:"regex",code:L.invalid_string,message:s.message}),t.dirty())):"trim"===s.kind?e.data=e.data.trim():"includes"===s.kind?e.data.includes(s.value,s.position)||(n=this._getOrReturnCtx(e,n),B(n,{code:L.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),t.dirty()):"toLowerCase"===s.kind?e.data=e.data.toLowerCase():"toUpperCase"===s.kind?e.data=e.data.toUpperCase():"startsWith"===s.kind?e.data.startsWith(s.value)||(n=this._getOrReturnCtx(e,n),B(n,{code:L.invalid_string,validation:{startsWith:s.value},message:s.message}),t.dirty()):"endsWith"===s.kind?e.data.endsWith(s.value)||(n=this._getOrReturnCtx(e,n),B(n,{code:L.invalid_string,validation:{endsWith:s.value},message:s.message}),t.dirty()):"datetime"===s.kind?xe(s).test(e.data)||(n=this._getOrReturnCtx(e,n),B(n,{code:L.invalid_string,validation:"datetime",message:s.message}),t.dirty()):"date"===s.kind?ve.test(e.data)||(n=this._getOrReturnCtx(e,n),B(n,{code:L.invalid_string,validation:"date",message:s.message}),t.dirty()):"time"===s.kind?be(s).test(e.data)||(n=this._getOrReturnCtx(e,n),B(n,{code:L.invalid_string,validation:"time",message:s.message}),t.dirty()):"duration"===s.kind?ue.test(e.data)||(n=this._getOrReturnCtx(e,n),B(n,{validation:"duration",code:L.invalid_string,message:s.message}),t.dirty()):"ip"===s.kind?Se(e.data,s.version)||(n=this._getOrReturnCtx(e,n),B(n,{validation:"ip",code:L.invalid_string,message:s.message}),t.dirty()):"jwt"===s.kind?ke(e.data,s.alg)||(n=this._getOrReturnCtx(e,n),B(n,{validation:"jwt",code:L.invalid_string,message:s.message}),t.dirty()):"cidr"===s.kind?Ie(e.data,s.version)||(n=this._getOrReturnCtx(e,n),B(n,{validation:"cidr",code:L.invalid_string,message:s.message}),t.dirty()):"base64"===s.kind?ge.test(e.data)||(n=this._getOrReturnCtx(e,n),B(n,{validation:"base64",code:L.invalid_string,message:s.message}),t.dirty()):"base64url"===s.kind?_e.test(e.data)||(n=this._getOrReturnCtx(e,n),B(n,{validation:"base64url",code:L.invalid_string,message:s.message}),t.dirty()):D.assertNever(s);return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement(t=>e.test(t),{validation:t,code:L.invalid_string,...Y.errToObj(n)})}_addCheck(e){return new Te({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...Y.errToObj(e)})}url(e){return this._addCheck({kind:"url",...Y.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...Y.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...Y.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...Y.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...Y.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...Y.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...Y.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...Y.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...Y.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...Y.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...Y.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...Y.errToObj(e)})}datetime(e){return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===e?.precision?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...Y.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===e?.precision?null:e?.precision,...Y.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...Y.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...Y.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...Y.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...Y.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...Y.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...Y.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...Y.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...Y.errToObj(t)})}nonempty(e){return this.min(1,Y.errToObj(e))}trim(){return new Te({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Te({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Te({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isDate(){return!!this._def.checks.find(e=>"date"===e.kind)}get isTime(){return!!this._def.checks.find(e=>"time"===e.kind)}get isDuration(){return!!this._def.checks.find(e=>"duration"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isEmoji(){return!!this._def.checks.find(e=>"emoji"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isNANOID(){return!!this._def.checks.find(e=>"nanoid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get isCUID2(){return!!this._def.checks.find(e=>"cuid2"===e.kind)}get isULID(){return!!this._def.checks.find(e=>"ulid"===e.kind)}get isIP(){return!!this._def.checks.find(e=>"ip"===e.kind)}get isCIDR(){return!!this._def.checks.find(e=>"cidr"===e.kind)}get isBase64(){return!!this._def.checks.find(e=>"base64"===e.kind)}get isBase64url(){return!!this._def.checks.find(e=>"base64url"===e.kind)}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function Ae(e,t){const n=(e.toString().split(".")[1]||"").length,s=(t.toString().split(".")[1]||"").length,r=n>s?n:s;return Number.parseInt(e.toFixed(r).replace(".",""))%Number.parseInt(t.toFixed(r).replace(".",""))/10**r}Te.create=e=>new Te({checks:[],typeName:ut.ZodString,coerce:e?.coerce??!1,...te(e)});class Ce extends ne{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==M.number){const t=this._getOrReturnCtx(e);return B(t,{code:L.invalid_type,expected:M.number,received:t.parsedType}),z}let t;const n=new J;for(const s of this._def.checks)"int"===s.kind?D.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),B(t,{code:L.invalid_type,expected:"integer",received:"float",message:s.message}),n.dirty()):"min"===s.kind?(s.inclusive?e.data<s.value:e.data<=s.value)&&(t=this._getOrReturnCtx(e,t),B(t,{code:L.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),n.dirty()):"max"===s.kind?(s.inclusive?e.data>s.value:e.data>=s.value)&&(t=this._getOrReturnCtx(e,t),B(t,{code:L.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),n.dirty()):"multipleOf"===s.kind?0!==Ae(e.data,s.value)&&(t=this._getOrReturnCtx(e,t),B(t,{code:L.not_multiple_of,multipleOf:s.value,message:s.message}),n.dirty()):"finite"===s.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),B(t,{code:L.not_finite,message:s.message}),n.dirty()):D.assertNever(s);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,Y.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Y.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Y.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Y.toString(t))}setLimit(e,t,n,s){return new Ce({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:Y.toString(s)}]})}_addCheck(e){return new Ce({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:Y.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:Y.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:Y.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:Y.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:Y.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Y.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:Y.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:Y.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:Y.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind||"multipleOf"===e.kind&&D.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if("finite"===n.kind||"int"===n.kind||"multipleOf"===n.kind)return!0;"min"===n.kind?(null===t||n.value>t)&&(t=n.value):"max"===n.kind&&(null===e||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}Ce.create=e=>new Ce({checks:[],typeName:ut.ZodNumber,coerce:e?.coerce||!1,...te(e)});class Oe extends ne{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==M.bigint)return this._getInvalidInput(e);let t;const n=new J;for(const s of this._def.checks)"min"===s.kind?(s.inclusive?e.data<s.value:e.data<=s.value)&&(t=this._getOrReturnCtx(e,t),B(t,{code:L.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),n.dirty()):"max"===s.kind?(s.inclusive?e.data>s.value:e.data>=s.value)&&(t=this._getOrReturnCtx(e,t),B(t,{code:L.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),n.dirty()):"multipleOf"===s.kind?e.data%s.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),B(t,{code:L.not_multiple_of,multipleOf:s.value,message:s.message}),n.dirty()):D.assertNever(s);return{status:n.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return B(t,{code:L.invalid_type,expected:M.bigint,received:t.parsedType}),z}gte(e,t){return this.setLimit("min",e,!0,Y.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Y.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Y.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Y.toString(t))}setLimit(e,t,n,s){return new Oe({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:Y.toString(s)}]})}_addCheck(e){return new Oe({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:Y.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:Y.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:Y.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:Y.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Y.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}Oe.create=e=>new Oe({checks:[],typeName:ut.ZodBigInt,coerce:e?.coerce??!1,...te(e)});class Re extends ne{_parse(e){if(this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==M.boolean){const t=this._getOrReturnCtx(e);return B(t,{code:L.invalid_type,expected:M.boolean,received:t.parsedType}),z}return G(e.data)}}Re.create=e=>new Re({typeName:ut.ZodBoolean,coerce:e?.coerce||!1,...te(e)});class Ee extends ne{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==M.date){const t=this._getOrReturnCtx(e);return B(t,{code:L.invalid_type,expected:M.date,received:t.parsedType}),z}if(Number.isNaN(e.data.getTime()))return B(this._getOrReturnCtx(e),{code:L.invalid_date}),z;const t=new J;let n;for(const s of this._def.checks)"min"===s.kind?e.data.getTime()<s.value&&(n=this._getOrReturnCtx(e,n),B(n,{code:L.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),t.dirty()):"max"===s.kind?e.data.getTime()>s.value&&(n=this._getOrReturnCtx(e,n),B(n,{code:L.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),t.dirty()):D.assertNever(s);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Ee({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:Y.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:Y.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}Ee.create=e=>new Ee({checks:[],coerce:e?.coerce||!1,typeName:ut.ZodDate,...te(e)});class Ne extends ne{_parse(e){if(this._getType(e)!==M.symbol){const t=this._getOrReturnCtx(e);return B(t,{code:L.invalid_type,expected:M.symbol,received:t.parsedType}),z}return G(e.data)}}Ne.create=e=>new Ne({typeName:ut.ZodSymbol,...te(e)});class Pe extends ne{_parse(e){if(this._getType(e)!==M.undefined){const t=this._getOrReturnCtx(e);return B(t,{code:L.invalid_type,expected:M.undefined,received:t.parsedType}),z}return G(e.data)}}Pe.create=e=>new Pe({typeName:ut.ZodUndefined,...te(e)});class $e extends ne{_parse(e){if(this._getType(e)!==M.null){const t=this._getOrReturnCtx(e);return B(t,{code:L.invalid_type,expected:M.null,received:t.parsedType}),z}return G(e.data)}}$e.create=e=>new $e({typeName:ut.ZodNull,...te(e)});class De extends ne{constructor(){super(...arguments),this._any=!0}_parse(e){return G(e.data)}}De.create=e=>new De({typeName:ut.ZodAny,...te(e)});class je extends ne{constructor(){super(...arguments),this._unknown=!0}_parse(e){return G(e.data)}}je.create=e=>new je({typeName:ut.ZodUnknown,...te(e)});class Me extends ne{_parse(e){const t=this._getOrReturnCtx(e);return B(t,{code:L.invalid_type,expected:M.never,received:t.parsedType}),z}}Me.create=e=>new Me({typeName:ut.ZodNever,...te(e)});class Ze extends ne{_parse(e){if(this._getType(e)!==M.undefined){const t=this._getOrReturnCtx(e);return B(t,{code:L.invalid_type,expected:M.void,received:t.parsedType}),z}return G(e.data)}}Ze.create=e=>new Ze({typeName:ut.ZodVoid,...te(e)});class Le extends ne{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),s=this._def;if(t.parsedType!==M.array)return B(t,{code:L.invalid_type,expected:M.array,received:t.parsedType}),z;if(null!==s.exactLength){const e=t.data.length>s.exactLength.value,r=t.data.length<s.exactLength.value;(e||r)&&(B(t,{code:e?L.too_big:L.too_small,minimum:r?s.exactLength.value:void 0,maximum:e?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),n.dirty())}if(null!==s.minLength&&t.data.length<s.minLength.value&&(B(t,{code:L.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),n.dirty()),null!==s.maxLength&&t.data.length>s.maxLength.value&&(B(t,{code:L.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map((e,n)=>s.type._parseAsync(new Q(t,e,t.path,n)))).then(e=>J.mergeArray(n,e));const r=[...t.data].map((e,n)=>s.type._parseSync(new Q(t,e,t.path,n)));return J.mergeArray(n,r)}get element(){return this._def.type}min(e,t){return new Le({...this._def,minLength:{value:e,message:Y.toString(t)}})}max(e,t){return new Le({...this._def,maxLength:{value:e,message:Y.toString(t)}})}length(e,t){return new Le({...this._def,exactLength:{value:e,message:Y.toString(t)}})}nonempty(e){return this.min(1,e)}}function Fe(e){if(e instanceof qe){const t={};for(const n in e.shape){const s=e.shape[n];t[n]=tt.create(Fe(s))}return new qe({...e._def,shape:()=>t})}return e instanceof Le?new Le({...e._def,type:Fe(e.element)}):e instanceof tt?tt.create(Fe(e.unwrap())):e instanceof nt?nt.create(Fe(e.unwrap())):e instanceof ze?ze.create(e.items.map(e=>Fe(e))):e}Le.create=(e,t)=>new Le({type:e,minLength:null,maxLength:null,exactLength:null,typeName:ut.ZodArray,...te(t)});class qe extends ne{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=D.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==M.object){const t=this._getOrReturnCtx(e);return B(t,{code:L.invalid_type,expected:M.object,received:t.parsedType}),z}const{status:t,ctx:n}=this._processInputParams(e),{shape:s,keys:r}=this._getCached(),a=[];if(!(this._def.catchall instanceof Me&&"strip"===this._def.unknownKeys))for(const e in n.data)r.includes(e)||a.push(e);const i=[];for(const e of r){const t=s[e],r=n.data[e];i.push({key:{status:"valid",value:e},value:t._parse(new Q(n,r,n.path,e)),alwaysSet:e in n.data})}if(this._def.catchall instanceof Me){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of a)i.push({key:{status:"valid",value:e},value:{status:"valid",value:n.data[e]}});else if("strict"===e)a.length>0&&(B(n,{code:L.unrecognized_keys,keys:a}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of a){const s=n.data[t];i.push({key:{status:"valid",value:t},value:e._parse(new Q(n,s,n.path,t)),alwaysSet:t in n.data})}}return n.common.async?Promise.resolve().then(async()=>{const e=[];for(const t of i){const n=await t.key,s=await t.value;e.push({key:n,value:s,alwaysSet:t.alwaysSet})}return e}).then(e=>J.mergeObjectSync(t,e)):J.mergeObjectSync(t,i)}get shape(){return this._def.shape()}strict(e){return Y.errToObj,new qe({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,n)=>{const s=this._def.errorMap?.(t,n).message??n.defaultError;return"unrecognized_keys"===t.code?{message:Y.errToObj(e).message??s}:{message:s}}}:{}})}strip(){return new qe({...this._def,unknownKeys:"strip"})}passthrough(){return new qe({...this._def,unknownKeys:"passthrough"})}extend(e){return new qe({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new qe({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:ut.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new qe({...this._def,catchall:e})}pick(e){const t={};for(const n of D.objectKeys(e))e[n]&&this.shape[n]&&(t[n]=this.shape[n]);return new qe({...this._def,shape:()=>t})}omit(e){const t={};for(const n of D.objectKeys(this.shape))e[n]||(t[n]=this.shape[n]);return new qe({...this._def,shape:()=>t})}deepPartial(){return Fe(this)}partial(e){const t={};for(const n of D.objectKeys(this.shape)){const s=this.shape[n];e&&!e[n]?t[n]=s:t[n]=s.optional()}return new qe({...this._def,shape:()=>t})}required(e){const t={};for(const n of D.objectKeys(this.shape))if(e&&!e[n])t[n]=this.shape[n];else{let e=this.shape[n];for(;e instanceof tt;)e=e._def.innerType;t[n]=e}return new qe({...this._def,shape:()=>t})}keyof(){return Ve(D.objectKeys(this.shape))}}qe.create=(e,t)=>new qe({shape:()=>e,unknownKeys:"strip",catchall:Me.create(),typeName:ut.ZodObject,...te(t)}),qe.strictCreate=(e,t)=>new qe({shape:()=>e,unknownKeys:"strict",catchall:Me.create(),typeName:ut.ZodObject,...te(t)}),qe.lazycreate=(e,t)=>new qe({shape:e,unknownKeys:"strip",catchall:Me.create(),typeName:ut.ZodObject,...te(t)});class Ue extends ne{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;if(t.common.async)return Promise.all(n.map(async e=>{const n={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}})).then(function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const n of e)if("dirty"===n.result.status)return t.common.issues.push(...n.ctx.common.issues),n.result;const n=e.map(e=>new F(e.ctx.common.issues));return B(t,{code:L.invalid_union,unionErrors:n}),z});{let e;const s=[];for(const r of n){const n={...t,common:{...t.common,issues:[]},parent:null},a=r._parseSync({data:t.data,path:t.path,parent:n});if("valid"===a.status)return a;"dirty"!==a.status||e||(e={result:a,ctx:n}),n.common.issues.length&&s.push(n.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const r=s.map(e=>new F(e));return B(t,{code:L.invalid_union,unionErrors:r}),z}}get options(){return this._def.options}}function Be(e,t){const n=Z(e),s=Z(t);if(e===t)return{valid:!0,data:e};if(n===M.object&&s===M.object){const n=D.objectKeys(t),s=D.objectKeys(e).filter(e=>-1!==n.indexOf(e)),r={...e,...t};for(const n of s){const s=Be(e[n],t[n]);if(!s.valid)return{valid:!1};r[n]=s.data}return{valid:!0,data:r}}if(n===M.array&&s===M.array){if(e.length!==t.length)return{valid:!1};const n=[];for(let s=0;s<e.length;s++){const r=Be(e[s],t[s]);if(!r.valid)return{valid:!1};n.push(r.data)}return{valid:!0,data:n}}return n===M.date&&s===M.date&&+e===+t?{valid:!0,data:e}:{valid:!1}}Ue.create=(e,t)=>new Ue({options:e,typeName:ut.ZodUnion,...te(t)});class Je extends ne{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),s=(e,s)=>{if(K(e)||K(s))return z;const r=Be(e.value,s.value);return r.valid?((H(e)||H(s))&&t.dirty(),{status:t.value,value:r.data}):(B(n,{code:L.invalid_intersection_types}),z)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([e,t])=>s(e,t)):s(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}Je.create=(e,t,n)=>new Je({left:e,right:t,typeName:ut.ZodIntersection,...te(n)});class ze extends ne{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==M.array)return B(n,{code:L.invalid_type,expected:M.array,received:n.parsedType}),z;if(n.data.length<this._def.items.length)return B(n,{code:L.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),z;!this._def.rest&&n.data.length>this._def.items.length&&(B(n,{code:L.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const s=[...n.data].map((e,t)=>{const s=this._def.items[t]||this._def.rest;return s?s._parse(new Q(n,e,n.path,t)):null}).filter(e=>!!e);return n.common.async?Promise.all(s).then(e=>J.mergeArray(t,e)):J.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new ze({...this._def,rest:e})}}ze.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new ze({items:e,typeName:ut.ZodTuple,rest:null,...te(t)})};class We extends ne{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==M.map)return B(n,{code:L.invalid_type,expected:M.map,received:n.parsedType}),z;const s=this._def.keyType,r=this._def.valueType,a=[...n.data.entries()].map(([e,t],a)=>({key:s._parse(new Q(n,e,n.path,[a,"key"])),value:r._parse(new Q(n,t,n.path,[a,"value"]))}));if(n.common.async){const e=new Map;return Promise.resolve().then(async()=>{for(const n of a){const s=await n.key,r=await n.value;if("aborted"===s.status||"aborted"===r.status)return z;"dirty"!==s.status&&"dirty"!==r.status||t.dirty(),e.set(s.value,r.value)}return{status:t.value,value:e}})}{const e=new Map;for(const n of a){const s=n.key,r=n.value;if("aborted"===s.status||"aborted"===r.status)return z;"dirty"!==s.status&&"dirty"!==r.status||t.dirty(),e.set(s.value,r.value)}return{status:t.value,value:e}}}}We.create=(e,t,n)=>new We({valueType:t,keyType:e,typeName:ut.ZodMap,...te(n)});class Ge extends ne{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==M.set)return B(n,{code:L.invalid_type,expected:M.set,received:n.parsedType}),z;const s=this._def;null!==s.minSize&&n.data.size<s.minSize.value&&(B(n,{code:L.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),t.dirty()),null!==s.maxSize&&n.data.size>s.maxSize.value&&(B(n,{code:L.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),t.dirty());const r=this._def.valueType;function a(e){const n=new Set;for(const s of e){if("aborted"===s.status)return z;"dirty"===s.status&&t.dirty(),n.add(s.value)}return{status:t.value,value:n}}const i=[...n.data.values()].map((e,t)=>r._parse(new Q(n,e,n.path,t)));return n.common.async?Promise.all(i).then(e=>a(e)):a(i)}min(e,t){return new Ge({...this._def,minSize:{value:e,message:Y.toString(t)}})}max(e,t){return new Ge({...this._def,maxSize:{value:e,message:Y.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Ge.create=(e,t)=>new Ge({valueType:e,minSize:null,maxSize:null,typeName:ut.ZodSet,...te(t)});class Ke extends ne{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Ke.create=(e,t)=>new Ke({getter:e,typeName:ut.ZodLazy,...te(t)});class He extends ne{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return B(t,{received:t.data,code:L.invalid_literal,expected:this._def.value}),z}return{status:"valid",value:e.data}}get value(){return this._def.value}}function Ve(e,t){return new Xe({values:e,typeName:ut.ZodEnum,...te(t)})}He.create=(e,t)=>new He({value:e,typeName:ut.ZodLiteral,...te(t)});class Xe extends ne{_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),n=this._def.values;return B(t,{expected:D.joinValues(n),received:t.parsedType,code:L.invalid_type}),z}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return B(t,{received:t.data,code:L.invalid_enum_value,options:n}),z}return G(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return Xe.create(e,{...this._def,...t})}exclude(e,t=this._def){return Xe.create(this.options.filter(t=>!e.includes(t)),{...this._def,...t})}}Xe.create=Ve;class Ye extends ne{_parse(e){const t=D.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==M.string&&n.parsedType!==M.number){const e=D.objectValues(t);return B(n,{expected:D.joinValues(e),received:n.parsedType,code:L.invalid_type}),z}if(this._cache||(this._cache=new Set(D.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const e=D.objectValues(t);return B(n,{received:n.data,code:L.invalid_enum_value,options:e}),z}return G(e.data)}get enum(){return this._def.values}}Ye.create=(e,t)=>new Ye({values:e,typeName:ut.ZodNativeEnum,...te(t)});class Qe extends ne{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==M.promise&&!1===t.common.async)return B(t,{code:L.invalid_type,expected:M.promise,received:t.parsedType}),z;const n=t.parsedType===M.promise?t.data:Promise.resolve(t.data);return G(n.then(e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap})))}}Qe.create=(e,t)=>new Qe({type:e,typeName:ut.ZodPromise,...te(t)});class et extends ne{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===ut.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),s=this._def.effect||null,r={addIssue:e=>{B(n,e),e.fatal?t.abort():t.dirty()},get path(){return n.path}};if(r.addIssue=r.addIssue.bind(r),"preprocess"===s.type){const e=s.transform(n.data,r);if(n.common.async)return Promise.resolve(e).then(async e=>{if("aborted"===t.value)return z;const s=await this._def.schema._parseAsync({data:e,path:n.path,parent:n});return"aborted"===s.status?z:"dirty"===s.status||"dirty"===t.value?W(s.value):s});{if("aborted"===t.value)return z;const s=this._def.schema._parseSync({data:e,path:n.path,parent:n});return"aborted"===s.status?z:"dirty"===s.status||"dirty"===t.value?W(s.value):s}}if("refinement"===s.type){const e=e=>{const t=s.refinement(e,r);if(n.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===n.common.async){const s=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===s.status?z:("dirty"===s.status&&t.dirty(),e(s.value),{status:t.value,value:s.value})}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(n=>"aborted"===n.status?z:("dirty"===n.status&&t.dirty(),e(n.value).then(()=>({status:t.value,value:n.value}))))}if("transform"===s.type){if(!1===n.common.async){const e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!V(e))return z;const a=s.transform(e.value,r);if(a instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:a}}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(e=>V(e)?Promise.resolve(s.transform(e.value,r)).then(e=>({status:t.value,value:e})):z)}D.assertNever(s)}}et.create=(e,t,n)=>new et({schema:e,typeName:ut.ZodEffects,effect:t,...te(n)}),et.createWithPreprocess=(e,t,n)=>new et({schema:t,effect:{type:"preprocess",transform:e},typeName:ut.ZodEffects,...te(n)});class tt extends ne{_parse(e){return this._getType(e)===M.undefined?G(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}tt.create=(e,t)=>new tt({innerType:e,typeName:ut.ZodOptional,...te(t)});class nt extends ne{_parse(e){return this._getType(e)===M.null?G(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}nt.create=(e,t)=>new nt({innerType:e,typeName:ut.ZodNullable,...te(t)});class st extends ne{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===M.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}st.create=(e,t)=>new st({innerType:e,typeName:ut.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...te(t)});class rt extends ne{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},s=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return X(s)?s.then(e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new F(n.common.issues)},input:n.data})})):{status:"valid",value:"valid"===s.status?s.value:this._def.catchValue({get error(){return new F(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}rt.create=(e,t)=>new rt({innerType:e,typeName:ut.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...te(t)});class at extends ne{_parse(e){if(this._getType(e)!==M.nan){const t=this._getOrReturnCtx(e);return B(t,{code:L.invalid_type,expected:M.nan,received:t.parsedType}),z}return{status:"valid",value:e.data}}}at.create=e=>new at({typeName:ut.ZodNaN,...te(e)}),Symbol("zod_brand");class it extends ne{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class ot extends ne{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?z:"dirty"===e.status?(t.dirty(),W(e.value)):this._def.out._parseAsync({data:e.value,path:n.path,parent:n})})();{const e=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?z:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}}static create(e,t){return new ot({in:e,out:t,typeName:ut.ZodPipeline})}}class ct extends ne{_parse(e){const t=this._def.innerType._parse(e),n=e=>(V(e)&&(e.value=Object.freeze(e.value)),e);return X(t)?t.then(e=>n(e)):n(t)}unwrap(){return this._def.innerType}}var ut;function lt(e,t,n,s){s?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function dt(e,t,n,s,r){e[t]=n,lt(e,t,s,r)}function pt(e,t,n){const s=n??t.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((n,s)=>pt(e,t,n))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return ht(e,t)}}ct.create=(e,t)=>new ct({innerType:e,typeName:ut.ZodReadonly,...te(t)}),qe.lazycreate,function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(ut||(ut={})),Te.create,Ce.create,at.create,Oe.create,Re.create,Ee.create,Ne.create,Pe.create,$e.create,De.create,je.create,Me.create,Ze.create,Le.create,qe.create,qe.strictCreate,Ue.create,Je.create,ze.create,We.create,Ge.create,Ke.create,He.create,Xe.create,Ye.create,Qe.create,et.create,tt.create,nt.create,et.createWithPreprocess,ot.create;const ht=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const s of e.checks)switch(s.kind){case"min":dt(n,"minimum",s.value,s.message,t);break;case"max":dt(n,"maximum",s.value,s.message,t)}return n};let mt;const ft=/^[cC][^\s-]{8,}$/,gt=/^[0-9a-z]+$/,_t=/^[0-9A-HJKMNP-TV-Z]{26}$/,yt=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,vt=()=>(void 0===mt&&(mt=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),mt),wt=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,bt=/^[a-zA-Z0-9_-]{21}$/;function xt(e,t){const n={type:"string"};function s(e){return"escape"===t.patternStrategy?St(e):e}if(e.checks)for(const r of e.checks)switch(r.kind){case"min":dt(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,r.value):r.value,r.message,t);break;case"max":dt(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,r.value):r.value,r.message,t);break;case"email":switch(t.emailStrategy){case"format:email":kt(n,"email",r.message,t);break;case"format:idn-email":kt(n,"idn-email",r.message,t);break;case"pattern:zod":It(n,yt,r.message,t)}break;case"url":kt(n,"uri",r.message,t);break;case"uuid":kt(n,"uuid",r.message,t);break;case"regex":It(n,r.regex,r.message,t);break;case"cuid":It(n,ft,r.message,t);break;case"cuid2":It(n,gt,r.message,t);break;case"startsWith":It(n,RegExp(`^${s(r.value)}`),r.message,t);break;case"endsWith":It(n,RegExp(`${s(r.value)}$`),r.message,t);break;case"datetime":kt(n,"date-time",r.message,t);break;case"date":kt(n,"date",r.message,t);break;case"time":kt(n,"time",r.message,t);break;case"duration":kt(n,"duration",r.message,t);break;case"length":dt(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,r.value):r.value,r.message,t),dt(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,r.value):r.value,r.message,t);break;case"includes":It(n,RegExp(s(r.value)),r.message,t);break;case"ip":"v6"!==r.version&&kt(n,"ipv4",r.message,t),"v4"!==r.version&&kt(n,"ipv6",r.message,t);break;case"emoji":It(n,vt,r.message,t);break;case"ulid":It(n,_t,r.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":kt(n,"binary",r.message,t);break;case"contentEncoding:base64":dt(n,"contentEncoding","base64",r.message,t);break;case"pattern:zod":It(n,wt,r.message,t)}break;case"nanoid":It(n,bt,r.message,t);case"toLowerCase":case"toUpperCase":case"trim":break;default:(()=>{})()}return n}const St=e=>Array.from(e).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),kt=(e,t,n,s)=>{e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&s.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&s.errorMessages&&{errorMessage:{format:n}}})):dt(e,"format",t,n,s)},It=(e,t,n,s)=>{e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&s.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:Tt(t,s),...n&&s.errorMessages&&{errorMessage:{pattern:n}}})):dt(e,"pattern",Tt(t,s),n,s)},Tt=(e,t)=>{const n="function"==typeof e?e():e;if(!t.applyRegexFlags||!n.flags)return n.source;const s=n.flags.includes("i"),r=n.flags.includes("m"),a=n.flags.includes("s"),i=s?n.source.toLowerCase():n.source;let o="",c=!1,u=!1,l=!1;for(let e=0;e<i.length;e++)if(c)o+=i[e],c=!1;else{if(s)if(u){if(i[e].match(/[a-z]/)){l?(o+=i[e],o+=`${i[e-2]}-${i[e]}`.toUpperCase(),l=!1):"-"===i[e+1]&&i[e+2]?.match(/[a-z]/)?(o+=i[e],l=!0):o+=`${i[e]}${i[e].toUpperCase()}`;continue}}else if(i[e].match(/[a-z]/)){o+=`[${i[e]}${i[e].toUpperCase()}]`;continue}if(r){if("^"===i[e]){o+="(^|(?<=[\r\n]))";continue}if("$"===i[e]){o+="($|(?=[\r\n]))";continue}}a&&"."===i[e]?o+=u?`${i[e]}\r\n`:`[${i[e]}\r\n]`:(o+=i[e],"\\"===i[e]?c=!0:u&&"]"===i[e]?u=!1:u||"["!==i[e]||(u=!0))}try{new RegExp(o)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return o};function At(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===ut.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((n,s)=>({...n,[s]:Et(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",s]})??{}}),{}),additionalProperties:!1};const n={type:"object",additionalProperties:Et(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===ut.ZodString&&e.keyType._def.checks?.length){const s=Object.entries(xt(e.keyType._def,t)).reduce((e,[t,n])=>"type"===t?e:{...e,[t]:n},{});return{...n,propertyNames:s}}return e.keyType?._def.typeName===ut.ZodEnum?{...n,propertyNames:{enum:e.keyType._def.values}}:n}const Ct={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},Ot=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,n)=>Et(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return n.length?{anyOf:n}:void 0};function Rt(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:Et(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:Et(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function Et(e,t,n=!1){const s=t.seen.get(e);if(t.override){const r=t.override?.(e,t,s,n);if(r!==N)return r}if(s&&!n){const e=Nt(s,t);if(void 0!==e)return"$ref"in e&&t.seenRefs.add(e.$ref),e}const r={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,r);const a=$t(e,e.typeName,t,n);return a&&Dt(e,t,a),r.jsonSchema=a,a}const Nt=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":const n=e.path.slice(t.basePath.length+1).join("_");return n!==t.name&&"duplicate-ref"===t.nameStrategy&&(t.definitions[n]=e.def),{$ref:[...t.basePath,t.definitionPath,n].join("/")};case"relative":return{$ref:Pt(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((e,n)=>t.currentPath[n]===e)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},Pt=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")},$t=(e,t,n,s)=>{switch(t){case ut.ZodString:return xt(e,n);case ut.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const s of e.checks)switch(s.kind){case"int":n.type="integer",lt(n,"type",s.message,t);break;case"min":"jsonSchema7"===t.target?s.inclusive?dt(n,"minimum",s.value,s.message,t):dt(n,"exclusiveMinimum",s.value,s.message,t):(s.inclusive||(n.exclusiveMinimum=!0),dt(n,"minimum",s.value,s.message,t));break;case"max":"jsonSchema7"===t.target?s.inclusive?dt(n,"maximum",s.value,s.message,t):dt(n,"exclusiveMaximum",s.value,s.message,t):(s.inclusive||(n.exclusiveMaximum=!0),dt(n,"maximum",s.value,s.message,t));break;case"multipleOf":dt(n,"multipleOf",s.value,s.message,t)}return n}(e,n);case ut.ZodObject:return function(e,t){const n={type:"object",...Object.entries(e.shape()).reduce((e,[n,s])=>{if(void 0===s||void 0===s._def)return e;const r=[...t.currentPath,"properties",n],a=Et(s._def,{...t,currentPath:r,propertyPath:r});if(void 0===a)return e;if(t.openaiStrictMode&&s.isOptional()&&!s.isNullable()&&void 0===s._def?.defaultValue)throw new Error(`Zod field at \`${r.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);return{properties:{...e.properties,[n]:a},required:s.isOptional()&&!t.openaiStrictMode?e.required:[...e.required,n]}},{properties:{},required:[]}),additionalProperties:Rt(e,t)};return n.required.length||delete n.required,n}(e,n);case ut.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const s of e.checks)switch(s.kind){case"min":"jsonSchema7"===t.target?s.inclusive?dt(n,"minimum",s.value,s.message,t):dt(n,"exclusiveMinimum",s.value,s.message,t):(s.inclusive||(n.exclusiveMinimum=!0),dt(n,"minimum",s.value,s.message,t));break;case"max":"jsonSchema7"===t.target?s.inclusive?dt(n,"maximum",s.value,s.message,t):dt(n,"exclusiveMaximum",s.value,s.message,t):(s.inclusive||(n.exclusiveMaximum=!0),dt(n,"maximum",s.value,s.message,t));break;case"multipleOf":dt(n,"multipleOf",s.value,s.message,t)}return n}(e,n);case ut.ZodBoolean:return{type:"boolean"};case ut.ZodDate:return pt(e,n);case ut.ZodUndefined:return{not:{}};case ut.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case ut.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def?.typeName!==ut.ZodAny&&(n.items=Et(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&dt(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&dt(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(dt(n,"minItems",e.exactLength.value,e.exactLength.message,t),dt(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case ut.ZodUnion:case ut.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return Ot(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every(e=>e._def.typeName in Ct&&(!e._def.checks||!e._def.checks.length))){const e=n.reduce((e,t)=>{const n=Ct[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e},[]);return{type:e.length>1?e:e[0]}}if(n.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){const e=n.reduce((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===n.length){const t=e.filter((e,t,n)=>n.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:n.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(n.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:n.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return Ot(e,t)}(e,n);case ut.ZodIntersection:return function(e,t){const n=[Et(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),Et(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(e=>!!e);let s="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const r=[];return n.forEach(e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...s}=e;t=s}else s=void 0;r.push(t)}else r.push(...e.allOf),void 0===e.unevaluatedProperties&&(s=void 0);var t}),r.length?{allOf:r,...s}:void 0}(e,n);case ut.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,n)=>Et(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:Et(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,n)=>Et(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])}}(e,n);case ut.ZodRecord:return At(e,n);case ut.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case ut.ZodEnum:return function(e){return{type:"string",enum:[...e.values]}}(e);case ut.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter(e=>"number"!=typeof t[t[e]]).map(e=>t[e]),s=Array.from(new Set(n.map(e=>typeof e)));return{type:1===s.length?"string"===s[0]?"string":"number":["string","number"],enum:n}}(e);case ut.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target||"property"===t.nullableStrategy?{type:Ct[e.innerType._def.typeName],nullable:!0}:{type:[Ct[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=Et(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=Et(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case ut.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return Et(e.innerType._def,t);const n=Et(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}})(e,n);case ut.ZodMap:return function(e,t){return"record"===t.mapStrategy?At(e,t):{type:"array",maxItems:125,items:{type:"array",items:[Et(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},Et(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,n);case ut.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:Et(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&dt(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&dt(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case ut.ZodLazy:return Et(e.getter()._def,n);case ut.ZodPromise:return function(e,t){return Et(e.type._def,t)}(e,n);case ut.ZodNaN:case ut.ZodNever:return{not:{}};case ut.ZodEffects:return function(e,t,n){return"input"===t.effectStrategy?Et(e.schema._def,t,n):{}}(e,n,s);case ut.ZodAny:case ut.ZodUnknown:return{};case ut.ZodDefault:return function(e,t){return{...Et(e.innerType._def,t),default:e.defaultValue()}}(e,n);case ut.ZodBranded:return function(e,t){return Et(e.type._def,t)}(e,n);case ut.ZodReadonly:case ut.ZodCatch:return((e,t)=>Et(e.innerType._def,t))(e,n);case ut.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return Et(e.in._def,t);if("output"===t.pipeStrategy)return Et(e.out._def,t);const n=Et(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,Et(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter(e=>void 0!==e)}})(e,n);case ut.ZodFunction:case ut.ZodVoid:case ut.ZodSymbol:default:return}},Dt=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n),jt=(e,t)=>{const n=(e=>{const t=(e=>"string"==typeof e?{...P,basePath:["#"],definitions:{},name:e}:{...P,basePath:["#"],definitions:{},...e})(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:n,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(t.definitions).map(([e,n])=>[$(n),{def:$(n),path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}]))}})(t),s="string"==typeof t?t:"title"===t?.nameStrategy?void 0:t?.name,r=Et(e._def,void 0===s?n:{...n,currentPath:[...n.basePath,n.definitionPath,s]},!1)??{},a="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==a&&(r.title=a);const i=(()=>{if(function(e){if(!e)return!0;for(const t in e)return!1;return!0}(n.definitions))return;const e={},t=new Set;for(let s=0;s<500;s++){const s=Object.entries(n.definitions).filter(([e])=>!t.has(e));if(0===s.length)break;for(const[r,a]of s)e[r]=Et($(a),{...n,currentPath:[...n.basePath,n.definitionPath,r]},!0)??{},t.add(r)}return e})(),o=void 0===s?i?{...r,[n.definitionPath]:i}:r:"duplicate-ref"===n.nameStrategy?{...r,...i||n.seenRefs.size?{[n.definitionPath]:{...i,...n.seenRefs.size?{[s]:r}:void 0}}:void 0}:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,s].join("/"),[n.definitionPath]:{...i,[s]:r}};return"jsonSchema7"===n.target?o.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===n.target&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function Mt(e,t){const n=e.output.map(e=>{if("function_call"===e.type)return{...e,parsed_arguments:Ft(t,e)};if("message"===e.type){const n=e.content.map(e=>"output_text"===e.type?{...e,parsed:Zt(t,e.text)}:e);return{...e,content:n}}return e}),s=Object.assign({},e,{output:n});return Object.getOwnPropertyDescriptor(e,"output_text")||qt(s),Object.defineProperty(s,"output_parsed",{enumerable:!0,get(){for(const e of s.output)if("message"===e.type)for(const t of e.content)if("output_text"===t.type&&null!==t.parsed)return t.parsed;return null}}),s}function Zt(e,t){if("json_schema"!==e.text?.format?.type)return null;if("$parseRaw"in e.text?.format){const n=e.text?.format;return n.$parseRaw(t)}return JSON.parse(t)}function Lt(e){return"auto-parseable-tool"===e?.$brand}function Ft(e,t){const n=(s=e.tools??[],r=t.name,s.find(e=>"function"===e.type&&e.name===r));var s,r;return{...t,...t,parsed_arguments:Lt(n)?n.$parseRaw(t.arguments):n?.strict?JSON.parse(t.arguments):null}}function qt(e){const t=[];for(const n of e.output)if("message"===n.type)for(const e of n.content)"output_text"===e.type&&t.push(e.text);e.output_text=t.join("")}function Ut(e,t){return jt(e,{openaiStrictMode:!0,name:t.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function Bt(e,t,n){return function(t){const n={...t};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t=>e.parse(JSON.parse(t)),enumerable:!1}}),n}({type:"json_schema",...n,name:t,strict:!0,schema:Ut(e,{name:t})})}class Jt extends Error{state;constructor(e,t){super(e),this.state=t}}class zt extends Jt{}class Wt extends Jt{}class Gt extends Jt{}class Kt extends Jt{}class Ht extends Jt{error;constructor(e,t,n){super(e,n),this.error=t}}class Vt extends Jt{error;constructor(e,t,n){super(e,n),this.error=t}}class Xt extends Jt{result;constructor(e,t,n){super(e,n),this.result=t}}class Yt extends Jt{result;constructor(e,t,n){super(e,n),this.result=t}}function Qt(e){return"object"==typeof e&&null!==e&&"_def"in e&&"object"==typeof e._def&&null!==e._def&&"typeName"in e._def&&"ZodObject"===e._def.typeName}function en(e){if(0===(e=(e=e.replace(/\s/g,"_")).replace(/[^a-zA-Z0-9]/g,"_")).length)throw new Error("Tool name cannot be empty");return e}function tn(e,t){if(Qt(e)){const s=function(e,{parser:t,callback:n}){const s={...e};return Object.defineProperties(s,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:t,enumerable:!1},$callback:{value:n,enumerable:!1}}),s}({type:"function",name:(n={name:t,parameters:e,function:()=>{},description:""}).name,parameters:Ut(n.parameters,{name:n.name}),strict:!0,...n.description?{description:n.description}:void 0},{callback:n.function,parser:e=>n.parameters.parse(JSON.parse(e))});return{schema:s.parameters,parser:s.$parseRaw}}var n;if("object"==typeof e&&null!==e)return{schema:e,parser:e=>JSON.parse(e)};throw new Kt("Input type is not a ZodObject or a valid JSON schema")}function nn(e){if("text"===e)return"text";if(Qt(e)){const t=Bt(e,"output");return{type:t.type,name:t.name,strict:t.strict||!1,schema:t.schema}}return e}var sn=n(833);function rn(e){const t={};return"true"===t[e]||"1"===t[e]}const an={get disabled(){return!0}},on={get dontLogModelData(){return rn("OPENAI_AGENTS_DONT_LOG_MODEL_DATA")},get dontLogToolData(){return rn("OPENAI_AGENTS_DONT_LOG_TOOL_DATA")}},cn=on.dontLogModelData,un=on.dontLogToolData;function ln(e="openai-agents"){return{namespace:e,debug:sn(e),error:console.error,warn:console.warn,dontLogModelData:cn,dontLogToolData:un}}const dn=ln("openai-agents:core"),pn=dn;function hn(e){if(null==e)return String(e);if("string"==typeof e)return e;if("object"==typeof e)try{return JSON.stringify(e)}catch(e){return"[object with circular references]"}return String(e)}function mn(e){return{type:"computer",name:e.name??"computer_use_preview",computer:e.computer}}function fn(e){return{type:"hosted_tool",name:"hosted_mcp",providerData:void 0===e.requireApproval||"never"===e.requireApproval?{type:"mcp",server_label:e.serverLabel,server_url:e.serverUrl,require_approval:"never",allowed_tools:vn(e.allowedTools),headers:e.headers}:{type:"mcp",server_label:e.serverLabel,server_url:e.serverUrl,allowed_tools:vn(e.allowedTools),headers:e.headers,require_approval:"string"==typeof e.requireApproval?"always":yn(e.requireApproval),on_approval:e.onApproval}}}function gn(e,t){return`An error occurred while running the tool. Please try again. Error: ${t instanceof Error?t.toString():String(t)}`}function _n(e){const t=e.name?en(e.name):en(e.execute.name),n=void 0===e.errorFunction?gn:e.errorFunction;if(!t)throw new Error("Tool name cannot be empty. Either name your function or provide a name in the options.");const s=e.strict??!0;if(!s&&Qt(e.parameters))throw new Kt("Strict mode is required for Zod parameters");const{parser:r,schema:a}=tn(e.parameters,t),i="function"==typeof e.needsApproval?e.needsApproval:async()=>"boolean"==typeof e.needsApproval&&e.needsApproval;return{type:"function",name:t,description:e.description,parameters:a,strict:s,invoke:async function(s,a){return async function(n,s){const[a,i]=await o(()=>r(s));if(null!==a)throw pn.dontLogToolData?pn.debug(`Invalid JSON input for tool ${t}`):pn.debug(`Invalid JSON input for tool ${t}: ${s}`),new Gt("Invalid JSON input for tool");pn.dontLogToolData?pn.debug(`Invoking tool ${t}`):pn.debug(`Invoking tool ${t} with input ${s}`);const c=await e.execute(i,n),u=hn(c);return pn.dontLogToolData?pn.debug(`Tool ${t} completed`):pn.debug(`Tool ${t} returned: ${u}`),c}(s,a).catch(e=>{if(n){const r=Er();return r?.setError({message:"Error running tool (non-fatal)",data:{tool_name:t,error:e.toString()}}),n(s,e)}throw e})},needsApproval:i}}function yn(e){const t={};return e.always&&(t.always={tool_names:e.always.toolNames}),e.never&&(t.never={tool_names:e.never.toolNames}),t}function vn(e){if(void 0!==e)return Array.isArray(e)?{tool_names:e}:{tool_names:e?.toolNames??[]}}var wn,bn;!function(e){e.assertEqual=e=>{},e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const n of e)t[n]=n;return t},e.getValidEnumValues=t=>{const n=e.objectKeys(t).filter(e=>"number"!=typeof t[t[e]]),s={};for(const e of n)s[e]=t[e];return e.objectValues(s)},e.objectValues=t=>e.objectKeys(t).map(function(e){return t[e]}),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},e.find=(e,t)=>{for(const n of e)if(t(n))return n},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&Number.isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map(e=>"string"==typeof e?`'${e}'`:e).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(wn||(wn={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(bn||(bn={}));const xn=wn.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Sn=e=>{switch(typeof e){case"undefined":return xn.undefined;case"string":return xn.string;case"number":return Number.isNaN(e)?xn.nan:xn.number;case"boolean":return xn.boolean;case"function":return xn.function;case"bigint":return xn.bigint;case"symbol":return xn.symbol;case"object":return Array.isArray(e)?xn.array:null===e?xn.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?xn.promise:"undefined"!=typeof Map&&e instanceof Map?xn.map:"undefined"!=typeof Set&&e instanceof Set?xn.set:"undefined"!=typeof Date&&e instanceof Date?xn.date:xn.object;default:return xn.unknown}},kn=wn.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class In extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(e){return e.message},n={_errors:[]},s=e=>{for(const r of e.issues)if("invalid_union"===r.code)r.unionErrors.map(s);else if("invalid_return_type"===r.code)s(r.returnTypeError);else if("invalid_arguments"===r.code)s(r.argumentsError);else if(0===r.path.length)n._errors.push(t(r));else{let e=n,s=0;for(;s<r.path.length;){const n=r.path[s];s===r.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(t(r))):e[n]=e[n]||{_errors:[]},e=e[n],s++}}};return s(this),n}static assert(e){if(!(e instanceof In))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,wn.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},n=[];for(const s of this.issues)s.path.length>0?(t[s.path[0]]=t[s.path[0]]||[],t[s.path[0]].push(e(s))):n.push(e(s));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}In.create=e=>new In(e);const Tn=(e,t)=>{let n;switch(e.code){case kn.invalid_type:n=e.received===xn.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case kn.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(e.expected,wn.jsonStringifyReplacer)}`;break;case kn.unrecognized_keys:n=`Unrecognized key(s) in object: ${wn.joinValues(e.keys,", ")}`;break;case kn.invalid_union:n="Invalid input";break;case kn.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${wn.joinValues(e.options)}`;break;case kn.invalid_enum_value:n=`Invalid enum value. Expected ${wn.joinValues(e.options)}, received '${e.received}'`;break;case kn.invalid_arguments:n="Invalid function arguments";break;case kn.invalid_return_type:n="Invalid function return type";break;case kn.invalid_date:n="Invalid date";break;case kn.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(n=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(n=`${n} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?n=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?n=`Invalid input: must end with "${e.validation.endsWith}"`:wn.assertNever(e.validation):n="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case kn.too_small:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case kn.too_big:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case kn.custom:n="Invalid input";break;case kn.invalid_intersection_types:n="Intersection results could not be merged";break;case kn.not_multiple_of:n=`Number must be a multiple of ${e.multipleOf}`;break;case kn.not_finite:n="Number must be finite";break;default:n=t.defaultError,wn.assertNever(e)}return{message:n}};let An=Tn;function Cn(e,t){const n=An,s=(e=>{const{data:t,path:n,errorMaps:s,issueData:r}=e,a=[...n,...r.path||[]],i={...r,path:a};if(void 0!==r.message)return{...r,path:a,message:r.message};let o="";const c=s.filter(e=>!!e).slice().reverse();for(const e of c)o=e(i,{data:t,defaultError:o}).message;return{...r,path:a,message:o}})({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,n,n===Tn?void 0:Tn].filter(e=>!!e)});e.common.issues.push(s)}class On{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const s of t){if("aborted"===s.status)return Rn;"dirty"===s.status&&e.dirty(),n.push(s.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const e of t){const t=await e.key,s=await e.value;n.push({key:t,value:s})}return On.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const s of t){const{key:t,value:r}=s;if("aborted"===t.status)return Rn;if("aborted"===r.status)return Rn;"dirty"===t.status&&e.dirty(),"dirty"===r.status&&e.dirty(),"__proto__"===t.value||void 0===r.value&&!s.alwaysSet||(n[t.value]=r.value)}return{status:e.value,value:n}}}const Rn=Object.freeze({status:"aborted"}),En=e=>({status:"dirty",value:e}),Nn=e=>({status:"valid",value:e}),Pn=e=>"aborted"===e.status,$n=e=>"dirty"===e.status,Dn=e=>"valid"===e.status,jn=e=>"undefined"!=typeof Promise&&e instanceof Promise;var Mn;!function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:e?.message}(Mn||(Mn={}));class Zn{constructor(e,t,n,s){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=s}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Ln=(e,t)=>{if(Dn(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new In(e.common.issues);return this._error=t,this._error}}};function Fn(e){if(!e)return{};const{errorMap:t,invalid_type_error:n,required_error:s,description:r}=e;if(t&&(n||s))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:r}:{errorMap:(t,r)=>{const{message:a}=e;return"invalid_enum_value"===t.code?{message:a??r.defaultError}:void 0===r.data?{message:a??s??r.defaultError}:"invalid_type"!==t.code?{message:r.defaultError}:{message:a??n??r.defaultError}},description:r}}class qn{get description(){return this._def.description}_getType(e){return Sn(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Sn(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new On,ctx:{common:e.parent.common,data:e.data,parsedType:Sn(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(jn(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){const n={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Sn(e)},s=this._parseSync({data:e,path:n.path,parent:n});return Ln(n,s)}"~validate"(e){const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Sn(e)};if(!this["~standard"].async)try{const n=this._parseSync({data:e,path:[],parent:t});return Dn(n)?{value:n.value}:{issues:t.common.issues}}catch(e){e?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(e=>Dn(e)?{value:e.value}:{issues:t.common.issues})}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Sn(e)},s=this._parse({data:e,path:n.path,parent:n}),r=await(jn(s)?s:Promise.resolve(s));return Ln(n,r)}refine(e,t){const n=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement((t,s)=>{const r=e(t),a=()=>s.addIssue({code:kn.custom,...n(t)});return"undefined"!=typeof Promise&&r instanceof Promise?r.then(e=>!!e||(a(),!1)):!!r||(a(),!1)})}refinement(e,t){return this._refinement((n,s)=>!!e(n)||(s.addIssue("function"==typeof t?t(n,s):t),!1))}_refinement(e){return new Us({schema:this,typeName:Xs.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return Bs.create(this,this._def)}nullable(){return Js.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return ks.create(this)}promise(){return qs.create(this,this._def)}or(e){return As.create([this,e],this._def)}and(e){return Es.create(this,e,this._def)}transform(e){return new Us({...Fn(this._def),schema:this,typeName:Xs.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new zs({...Fn(this._def),innerType:this,defaultValue:t,typeName:Xs.ZodDefault})}brand(){return new Ks({typeName:Xs.ZodBranded,type:this,...Fn(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new Ws({...Fn(this._def),innerType:this,catchValue:t,typeName:Xs.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return Hs.create(this,e)}readonly(){return Vs.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Un=/^c[^\s-]{8,}$/i,Bn=/^[0-9a-z]+$/,Jn=/^[0-9A-HJKMNP-TV-Z]{26}$/i,zn=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Wn=/^[a-z0-9_-]{21}$/i,Gn=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Kn=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Hn=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let Vn;const Xn=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Yn=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Qn=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,es=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,ts=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,ns=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,ss="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",rs=new RegExp(`^${ss}$`);function as(e){let t="[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),`([01]\\d|2[0-3]):[0-5]\\d(:${t})${e.precision?"+":"?"}`}function is(e){return new RegExp(`^${as(e)}$`)}function os(e){let t=`${ss}T${as(e)}`;const n=[];return n.push(e.local?"Z?":"Z"),e.offset&&n.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${n.join("|")})`,new RegExp(`^${t}$`)}function cs(e,t){return!("v4"!==t&&t||!Xn.test(e))||!("v6"!==t&&t||!Qn.test(e))}function us(e,t){if(!Gn.test(e))return!1;try{const[n]=e.split("."),s=n.replace(/-/g,"+").replace(/_/g,"/").padEnd(n.length+(4-n.length%4)%4,"="),r=JSON.parse(atob(s));return!("object"!=typeof r||null===r||"typ"in r&&"JWT"!==r?.typ||!r.alg||t&&r.alg!==t)}catch{return!1}}function ls(e,t){return!("v4"!==t&&t||!Yn.test(e))||!("v6"!==t&&t||!es.test(e))}class ds extends qn{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==xn.string){const t=this._getOrReturnCtx(e);return Cn(t,{code:kn.invalid_type,expected:xn.string,received:t.parsedType}),Rn}const t=new On;let n;for(const s of this._def.checks)if("min"===s.kind)e.data.length<s.value&&(n=this._getOrReturnCtx(e,n),Cn(n,{code:kn.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("max"===s.kind)e.data.length>s.value&&(n=this._getOrReturnCtx(e,n),Cn(n,{code:kn.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("length"===s.kind){const r=e.data.length>s.value,a=e.data.length<s.value;(r||a)&&(n=this._getOrReturnCtx(e,n),r?Cn(n,{code:kn.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):a&&Cn(n,{code:kn.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),t.dirty())}else if("email"===s.kind)Hn.test(e.data)||(n=this._getOrReturnCtx(e,n),Cn(n,{validation:"email",code:kn.invalid_string,message:s.message}),t.dirty());else if("emoji"===s.kind)Vn||(Vn=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Vn.test(e.data)||(n=this._getOrReturnCtx(e,n),Cn(n,{validation:"emoji",code:kn.invalid_string,message:s.message}),t.dirty());else if("uuid"===s.kind)zn.test(e.data)||(n=this._getOrReturnCtx(e,n),Cn(n,{validation:"uuid",code:kn.invalid_string,message:s.message}),t.dirty());else if("nanoid"===s.kind)Wn.test(e.data)||(n=this._getOrReturnCtx(e,n),Cn(n,{validation:"nanoid",code:kn.invalid_string,message:s.message}),t.dirty());else if("cuid"===s.kind)Un.test(e.data)||(n=this._getOrReturnCtx(e,n),Cn(n,{validation:"cuid",code:kn.invalid_string,message:s.message}),t.dirty());else if("cuid2"===s.kind)Bn.test(e.data)||(n=this._getOrReturnCtx(e,n),Cn(n,{validation:"cuid2",code:kn.invalid_string,message:s.message}),t.dirty());else if("ulid"===s.kind)Jn.test(e.data)||(n=this._getOrReturnCtx(e,n),Cn(n,{validation:"ulid",code:kn.invalid_string,message:s.message}),t.dirty());else if("url"===s.kind)try{new URL(e.data)}catch{n=this._getOrReturnCtx(e,n),Cn(n,{validation:"url",code:kn.invalid_string,message:s.message}),t.dirty()}else"regex"===s.kind?(s.regex.lastIndex=0,s.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),Cn(n,{validation:"regex",code:kn.invalid_string,message:s.message}),t.dirty())):"trim"===s.kind?e.data=e.data.trim():"includes"===s.kind?e.data.includes(s.value,s.position)||(n=this._getOrReturnCtx(e,n),Cn(n,{code:kn.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),t.dirty()):"toLowerCase"===s.kind?e.data=e.data.toLowerCase():"toUpperCase"===s.kind?e.data=e.data.toUpperCase():"startsWith"===s.kind?e.data.startsWith(s.value)||(n=this._getOrReturnCtx(e,n),Cn(n,{code:kn.invalid_string,validation:{startsWith:s.value},message:s.message}),t.dirty()):"endsWith"===s.kind?e.data.endsWith(s.value)||(n=this._getOrReturnCtx(e,n),Cn(n,{code:kn.invalid_string,validation:{endsWith:s.value},message:s.message}),t.dirty()):"datetime"===s.kind?os(s).test(e.data)||(n=this._getOrReturnCtx(e,n),Cn(n,{code:kn.invalid_string,validation:"datetime",message:s.message}),t.dirty()):"date"===s.kind?rs.test(e.data)||(n=this._getOrReturnCtx(e,n),Cn(n,{code:kn.invalid_string,validation:"date",message:s.message}),t.dirty()):"time"===s.kind?is(s).test(e.data)||(n=this._getOrReturnCtx(e,n),Cn(n,{code:kn.invalid_string,validation:"time",message:s.message}),t.dirty()):"duration"===s.kind?Kn.test(e.data)||(n=this._getOrReturnCtx(e,n),Cn(n,{validation:"duration",code:kn.invalid_string,message:s.message}),t.dirty()):"ip"===s.kind?cs(e.data,s.version)||(n=this._getOrReturnCtx(e,n),Cn(n,{validation:"ip",code:kn.invalid_string,message:s.message}),t.dirty()):"jwt"===s.kind?us(e.data,s.alg)||(n=this._getOrReturnCtx(e,n),Cn(n,{validation:"jwt",code:kn.invalid_string,message:s.message}),t.dirty()):"cidr"===s.kind?ls(e.data,s.version)||(n=this._getOrReturnCtx(e,n),Cn(n,{validation:"cidr",code:kn.invalid_string,message:s.message}),t.dirty()):"base64"===s.kind?ts.test(e.data)||(n=this._getOrReturnCtx(e,n),Cn(n,{validation:"base64",code:kn.invalid_string,message:s.message}),t.dirty()):"base64url"===s.kind?ns.test(e.data)||(n=this._getOrReturnCtx(e,n),Cn(n,{validation:"base64url",code:kn.invalid_string,message:s.message}),t.dirty()):wn.assertNever(s);return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement(t=>e.test(t),{validation:t,code:kn.invalid_string,...Mn.errToObj(n)})}_addCheck(e){return new ds({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...Mn.errToObj(e)})}url(e){return this._addCheck({kind:"url",...Mn.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...Mn.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...Mn.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...Mn.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...Mn.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...Mn.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...Mn.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...Mn.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...Mn.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...Mn.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...Mn.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...Mn.errToObj(e)})}datetime(e){return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===e?.precision?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...Mn.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===e?.precision?null:e?.precision,...Mn.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...Mn.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...Mn.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...Mn.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...Mn.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...Mn.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...Mn.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...Mn.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...Mn.errToObj(t)})}nonempty(e){return this.min(1,Mn.errToObj(e))}trim(){return new ds({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new ds({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new ds({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isDate(){return!!this._def.checks.find(e=>"date"===e.kind)}get isTime(){return!!this._def.checks.find(e=>"time"===e.kind)}get isDuration(){return!!this._def.checks.find(e=>"duration"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isEmoji(){return!!this._def.checks.find(e=>"emoji"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isNANOID(){return!!this._def.checks.find(e=>"nanoid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get isCUID2(){return!!this._def.checks.find(e=>"cuid2"===e.kind)}get isULID(){return!!this._def.checks.find(e=>"ulid"===e.kind)}get isIP(){return!!this._def.checks.find(e=>"ip"===e.kind)}get isCIDR(){return!!this._def.checks.find(e=>"cidr"===e.kind)}get isBase64(){return!!this._def.checks.find(e=>"base64"===e.kind)}get isBase64url(){return!!this._def.checks.find(e=>"base64url"===e.kind)}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function ps(e,t){const n=(e.toString().split(".")[1]||"").length,s=(t.toString().split(".")[1]||"").length,r=n>s?n:s;return Number.parseInt(e.toFixed(r).replace(".",""))%Number.parseInt(t.toFixed(r).replace(".",""))/10**r}ds.create=e=>new ds({checks:[],typeName:Xs.ZodString,coerce:e?.coerce??!1,...Fn(e)});class hs extends qn{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==xn.number){const t=this._getOrReturnCtx(e);return Cn(t,{code:kn.invalid_type,expected:xn.number,received:t.parsedType}),Rn}let t;const n=new On;for(const s of this._def.checks)"int"===s.kind?wn.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),Cn(t,{code:kn.invalid_type,expected:"integer",received:"float",message:s.message}),n.dirty()):"min"===s.kind?(s.inclusive?e.data<s.value:e.data<=s.value)&&(t=this._getOrReturnCtx(e,t),Cn(t,{code:kn.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),n.dirty()):"max"===s.kind?(s.inclusive?e.data>s.value:e.data>=s.value)&&(t=this._getOrReturnCtx(e,t),Cn(t,{code:kn.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),n.dirty()):"multipleOf"===s.kind?0!==ps(e.data,s.value)&&(t=this._getOrReturnCtx(e,t),Cn(t,{code:kn.not_multiple_of,multipleOf:s.value,message:s.message}),n.dirty()):"finite"===s.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),Cn(t,{code:kn.not_finite,message:s.message}),n.dirty()):wn.assertNever(s);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,Mn.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Mn.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Mn.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Mn.toString(t))}setLimit(e,t,n,s){return new hs({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:Mn.toString(s)}]})}_addCheck(e){return new hs({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:Mn.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:Mn.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:Mn.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:Mn.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:Mn.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Mn.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:Mn.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:Mn.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:Mn.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind||"multipleOf"===e.kind&&wn.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if("finite"===n.kind||"int"===n.kind||"multipleOf"===n.kind)return!0;"min"===n.kind?(null===t||n.value>t)&&(t=n.value):"max"===n.kind&&(null===e||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}hs.create=e=>new hs({checks:[],typeName:Xs.ZodNumber,coerce:e?.coerce||!1,...Fn(e)});class ms extends qn{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==xn.bigint)return this._getInvalidInput(e);let t;const n=new On;for(const s of this._def.checks)"min"===s.kind?(s.inclusive?e.data<s.value:e.data<=s.value)&&(t=this._getOrReturnCtx(e,t),Cn(t,{code:kn.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),n.dirty()):"max"===s.kind?(s.inclusive?e.data>s.value:e.data>=s.value)&&(t=this._getOrReturnCtx(e,t),Cn(t,{code:kn.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),n.dirty()):"multipleOf"===s.kind?e.data%s.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),Cn(t,{code:kn.not_multiple_of,multipleOf:s.value,message:s.message}),n.dirty()):wn.assertNever(s);return{status:n.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return Cn(t,{code:kn.invalid_type,expected:xn.bigint,received:t.parsedType}),Rn}gte(e,t){return this.setLimit("min",e,!0,Mn.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Mn.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Mn.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Mn.toString(t))}setLimit(e,t,n,s){return new ms({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:Mn.toString(s)}]})}_addCheck(e){return new ms({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:Mn.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:Mn.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:Mn.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:Mn.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Mn.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}ms.create=e=>new ms({checks:[],typeName:Xs.ZodBigInt,coerce:e?.coerce??!1,...Fn(e)});class fs extends qn{_parse(e){if(this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==xn.boolean){const t=this._getOrReturnCtx(e);return Cn(t,{code:kn.invalid_type,expected:xn.boolean,received:t.parsedType}),Rn}return Nn(e.data)}}fs.create=e=>new fs({typeName:Xs.ZodBoolean,coerce:e?.coerce||!1,...Fn(e)});class gs extends qn{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==xn.date){const t=this._getOrReturnCtx(e);return Cn(t,{code:kn.invalid_type,expected:xn.date,received:t.parsedType}),Rn}if(Number.isNaN(e.data.getTime()))return Cn(this._getOrReturnCtx(e),{code:kn.invalid_date}),Rn;const t=new On;let n;for(const s of this._def.checks)"min"===s.kind?e.data.getTime()<s.value&&(n=this._getOrReturnCtx(e,n),Cn(n,{code:kn.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),t.dirty()):"max"===s.kind?e.data.getTime()>s.value&&(n=this._getOrReturnCtx(e,n),Cn(n,{code:kn.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),t.dirty()):wn.assertNever(s);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new gs({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:Mn.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:Mn.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}gs.create=e=>new gs({checks:[],coerce:e?.coerce||!1,typeName:Xs.ZodDate,...Fn(e)});class _s extends qn{_parse(e){if(this._getType(e)!==xn.symbol){const t=this._getOrReturnCtx(e);return Cn(t,{code:kn.invalid_type,expected:xn.symbol,received:t.parsedType}),Rn}return Nn(e.data)}}_s.create=e=>new _s({typeName:Xs.ZodSymbol,...Fn(e)});class ys extends qn{_parse(e){if(this._getType(e)!==xn.undefined){const t=this._getOrReturnCtx(e);return Cn(t,{code:kn.invalid_type,expected:xn.undefined,received:t.parsedType}),Rn}return Nn(e.data)}}ys.create=e=>new ys({typeName:Xs.ZodUndefined,...Fn(e)});class vs extends qn{_parse(e){if(this._getType(e)!==xn.null){const t=this._getOrReturnCtx(e);return Cn(t,{code:kn.invalid_type,expected:xn.null,received:t.parsedType}),Rn}return Nn(e.data)}}vs.create=e=>new vs({typeName:Xs.ZodNull,...Fn(e)});class ws extends qn{constructor(){super(...arguments),this._any=!0}_parse(e){return Nn(e.data)}}ws.create=e=>new ws({typeName:Xs.ZodAny,...Fn(e)});class bs extends qn{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Nn(e.data)}}bs.create=e=>new bs({typeName:Xs.ZodUnknown,...Fn(e)});class xs extends qn{_parse(e){const t=this._getOrReturnCtx(e);return Cn(t,{code:kn.invalid_type,expected:xn.never,received:t.parsedType}),Rn}}xs.create=e=>new xs({typeName:Xs.ZodNever,...Fn(e)});class Ss extends qn{_parse(e){if(this._getType(e)!==xn.undefined){const t=this._getOrReturnCtx(e);return Cn(t,{code:kn.invalid_type,expected:xn.void,received:t.parsedType}),Rn}return Nn(e.data)}}Ss.create=e=>new Ss({typeName:Xs.ZodVoid,...Fn(e)});class ks extends qn{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),s=this._def;if(t.parsedType!==xn.array)return Cn(t,{code:kn.invalid_type,expected:xn.array,received:t.parsedType}),Rn;if(null!==s.exactLength){const e=t.data.length>s.exactLength.value,r=t.data.length<s.exactLength.value;(e||r)&&(Cn(t,{code:e?kn.too_big:kn.too_small,minimum:r?s.exactLength.value:void 0,maximum:e?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),n.dirty())}if(null!==s.minLength&&t.data.length<s.minLength.value&&(Cn(t,{code:kn.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),n.dirty()),null!==s.maxLength&&t.data.length>s.maxLength.value&&(Cn(t,{code:kn.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map((e,n)=>s.type._parseAsync(new Zn(t,e,t.path,n)))).then(e=>On.mergeArray(n,e));const r=[...t.data].map((e,n)=>s.type._parseSync(new Zn(t,e,t.path,n)));return On.mergeArray(n,r)}get element(){return this._def.type}min(e,t){return new ks({...this._def,minLength:{value:e,message:Mn.toString(t)}})}max(e,t){return new ks({...this._def,maxLength:{value:e,message:Mn.toString(t)}})}length(e,t){return new ks({...this._def,exactLength:{value:e,message:Mn.toString(t)}})}nonempty(e){return this.min(1,e)}}function Is(e){if(e instanceof Ts){const t={};for(const n in e.shape){const s=e.shape[n];t[n]=Bs.create(Is(s))}return new Ts({...e._def,shape:()=>t})}return e instanceof ks?new ks({...e._def,type:Is(e.element)}):e instanceof Bs?Bs.create(Is(e.unwrap())):e instanceof Js?Js.create(Is(e.unwrap())):e instanceof Ns?Ns.create(e.items.map(e=>Is(e))):e}ks.create=(e,t)=>new ks({type:e,minLength:null,maxLength:null,exactLength:null,typeName:Xs.ZodArray,...Fn(t)});class Ts extends qn{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=wn.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==xn.object){const t=this._getOrReturnCtx(e);return Cn(t,{code:kn.invalid_type,expected:xn.object,received:t.parsedType}),Rn}const{status:t,ctx:n}=this._processInputParams(e),{shape:s,keys:r}=this._getCached(),a=[];if(!(this._def.catchall instanceof xs&&"strip"===this._def.unknownKeys))for(const e in n.data)r.includes(e)||a.push(e);const i=[];for(const e of r){const t=s[e],r=n.data[e];i.push({key:{status:"valid",value:e},value:t._parse(new Zn(n,r,n.path,e)),alwaysSet:e in n.data})}if(this._def.catchall instanceof xs){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of a)i.push({key:{status:"valid",value:e},value:{status:"valid",value:n.data[e]}});else if("strict"===e)a.length>0&&(Cn(n,{code:kn.unrecognized_keys,keys:a}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of a){const s=n.data[t];i.push({key:{status:"valid",value:t},value:e._parse(new Zn(n,s,n.path,t)),alwaysSet:t in n.data})}}return n.common.async?Promise.resolve().then(async()=>{const e=[];for(const t of i){const n=await t.key,s=await t.value;e.push({key:n,value:s,alwaysSet:t.alwaysSet})}return e}).then(e=>On.mergeObjectSync(t,e)):On.mergeObjectSync(t,i)}get shape(){return this._def.shape()}strict(e){return Mn.errToObj,new Ts({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,n)=>{const s=this._def.errorMap?.(t,n).message??n.defaultError;return"unrecognized_keys"===t.code?{message:Mn.errToObj(e).message??s}:{message:s}}}:{}})}strip(){return new Ts({...this._def,unknownKeys:"strip"})}passthrough(){return new Ts({...this._def,unknownKeys:"passthrough"})}extend(e){return new Ts({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new Ts({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:Xs.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new Ts({...this._def,catchall:e})}pick(e){const t={};for(const n of wn.objectKeys(e))e[n]&&this.shape[n]&&(t[n]=this.shape[n]);return new Ts({...this._def,shape:()=>t})}omit(e){const t={};for(const n of wn.objectKeys(this.shape))e[n]||(t[n]=this.shape[n]);return new Ts({...this._def,shape:()=>t})}deepPartial(){return Is(this)}partial(e){const t={};for(const n of wn.objectKeys(this.shape)){const s=this.shape[n];e&&!e[n]?t[n]=s:t[n]=s.optional()}return new Ts({...this._def,shape:()=>t})}required(e){const t={};for(const n of wn.objectKeys(this.shape))if(e&&!e[n])t[n]=this.shape[n];else{let e=this.shape[n];for(;e instanceof Bs;)e=e._def.innerType;t[n]=e}return new Ts({...this._def,shape:()=>t})}keyof(){return Zs(wn.objectKeys(this.shape))}}Ts.create=(e,t)=>new Ts({shape:()=>e,unknownKeys:"strip",catchall:xs.create(),typeName:Xs.ZodObject,...Fn(t)}),Ts.strictCreate=(e,t)=>new Ts({shape:()=>e,unknownKeys:"strict",catchall:xs.create(),typeName:Xs.ZodObject,...Fn(t)}),Ts.lazycreate=(e,t)=>new Ts({shape:e,unknownKeys:"strip",catchall:xs.create(),typeName:Xs.ZodObject,...Fn(t)});class As extends qn{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;if(t.common.async)return Promise.all(n.map(async e=>{const n={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}})).then(function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const n of e)if("dirty"===n.result.status)return t.common.issues.push(...n.ctx.common.issues),n.result;const n=e.map(e=>new In(e.ctx.common.issues));return Cn(t,{code:kn.invalid_union,unionErrors:n}),Rn});{let e;const s=[];for(const r of n){const n={...t,common:{...t.common,issues:[]},parent:null},a=r._parseSync({data:t.data,path:t.path,parent:n});if("valid"===a.status)return a;"dirty"!==a.status||e||(e={result:a,ctx:n}),n.common.issues.length&&s.push(n.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const r=s.map(e=>new In(e));return Cn(t,{code:kn.invalid_union,unionErrors:r}),Rn}}get options(){return this._def.options}}As.create=(e,t)=>new As({options:e,typeName:Xs.ZodUnion,...Fn(t)});const Cs=e=>e instanceof js?Cs(e.schema):e instanceof Us?Cs(e.innerType()):e instanceof Ms?[e.value]:e instanceof Ls?e.options:e instanceof Fs?wn.objectValues(e.enum):e instanceof zs?Cs(e._def.innerType):e instanceof ys?[void 0]:e instanceof vs?[null]:e instanceof Bs?[void 0,...Cs(e.unwrap())]:e instanceof Js?[null,...Cs(e.unwrap())]:e instanceof Ks||e instanceof Vs?Cs(e.unwrap()):e instanceof Ws?Cs(e._def.innerType):[];class Os extends qn{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==xn.object)return Cn(t,{code:kn.invalid_type,expected:xn.object,received:t.parsedType}),Rn;const n=this.discriminator,s=t.data[n],r=this.optionsMap.get(s);return r?t.common.async?r._parseAsync({data:t.data,path:t.path,parent:t}):r._parseSync({data:t.data,path:t.path,parent:t}):(Cn(t,{code:kn.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),Rn)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){const s=new Map;for(const n of t){const t=Cs(n.shape[e]);if(!t.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const r of t){if(s.has(r))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(r)}`);s.set(r,n)}}return new Os({typeName:Xs.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:s,...Fn(n)})}}function Rs(e,t){const n=Sn(e),s=Sn(t);if(e===t)return{valid:!0,data:e};if(n===xn.object&&s===xn.object){const n=wn.objectKeys(t),s=wn.objectKeys(e).filter(e=>-1!==n.indexOf(e)),r={...e,...t};for(const n of s){const s=Rs(e[n],t[n]);if(!s.valid)return{valid:!1};r[n]=s.data}return{valid:!0,data:r}}if(n===xn.array&&s===xn.array){if(e.length!==t.length)return{valid:!1};const n=[];for(let s=0;s<e.length;s++){const r=Rs(e[s],t[s]);if(!r.valid)return{valid:!1};n.push(r.data)}return{valid:!0,data:n}}return n===xn.date&&s===xn.date&&+e===+t?{valid:!0,data:e}:{valid:!1}}class Es extends qn{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),s=(e,s)=>{if(Pn(e)||Pn(s))return Rn;const r=Rs(e.value,s.value);return r.valid?(($n(e)||$n(s))&&t.dirty(),{status:t.value,value:r.data}):(Cn(n,{code:kn.invalid_intersection_types}),Rn)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([e,t])=>s(e,t)):s(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}Es.create=(e,t,n)=>new Es({left:e,right:t,typeName:Xs.ZodIntersection,...Fn(n)});class Ns extends qn{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==xn.array)return Cn(n,{code:kn.invalid_type,expected:xn.array,received:n.parsedType}),Rn;if(n.data.length<this._def.items.length)return Cn(n,{code:kn.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),Rn;!this._def.rest&&n.data.length>this._def.items.length&&(Cn(n,{code:kn.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const s=[...n.data].map((e,t)=>{const s=this._def.items[t]||this._def.rest;return s?s._parse(new Zn(n,e,n.path,t)):null}).filter(e=>!!e);return n.common.async?Promise.all(s).then(e=>On.mergeArray(t,e)):On.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new Ns({...this._def,rest:e})}}Ns.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Ns({items:e,typeName:Xs.ZodTuple,rest:null,...Fn(t)})};class Ps extends qn{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==xn.object)return Cn(n,{code:kn.invalid_type,expected:xn.object,received:n.parsedType}),Rn;const s=[],r=this._def.keyType,a=this._def.valueType;for(const e in n.data)s.push({key:r._parse(new Zn(n,e,n.path,e)),value:a._parse(new Zn(n,n.data[e],n.path,e)),alwaysSet:e in n.data});return n.common.async?On.mergeObjectAsync(t,s):On.mergeObjectSync(t,s)}get element(){return this._def.valueType}static create(e,t,n){return new Ps(t instanceof qn?{keyType:e,valueType:t,typeName:Xs.ZodRecord,...Fn(n)}:{keyType:ds.create(),valueType:e,typeName:Xs.ZodRecord,...Fn(t)})}}class $s extends qn{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==xn.map)return Cn(n,{code:kn.invalid_type,expected:xn.map,received:n.parsedType}),Rn;const s=this._def.keyType,r=this._def.valueType,a=[...n.data.entries()].map(([e,t],a)=>({key:s._parse(new Zn(n,e,n.path,[a,"key"])),value:r._parse(new Zn(n,t,n.path,[a,"value"]))}));if(n.common.async){const e=new Map;return Promise.resolve().then(async()=>{for(const n of a){const s=await n.key,r=await n.value;if("aborted"===s.status||"aborted"===r.status)return Rn;"dirty"!==s.status&&"dirty"!==r.status||t.dirty(),e.set(s.value,r.value)}return{status:t.value,value:e}})}{const e=new Map;for(const n of a){const s=n.key,r=n.value;if("aborted"===s.status||"aborted"===r.status)return Rn;"dirty"!==s.status&&"dirty"!==r.status||t.dirty(),e.set(s.value,r.value)}return{status:t.value,value:e}}}}$s.create=(e,t,n)=>new $s({valueType:t,keyType:e,typeName:Xs.ZodMap,...Fn(n)});class Ds extends qn{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==xn.set)return Cn(n,{code:kn.invalid_type,expected:xn.set,received:n.parsedType}),Rn;const s=this._def;null!==s.minSize&&n.data.size<s.minSize.value&&(Cn(n,{code:kn.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),t.dirty()),null!==s.maxSize&&n.data.size>s.maxSize.value&&(Cn(n,{code:kn.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),t.dirty());const r=this._def.valueType;function a(e){const n=new Set;for(const s of e){if("aborted"===s.status)return Rn;"dirty"===s.status&&t.dirty(),n.add(s.value)}return{status:t.value,value:n}}const i=[...n.data.values()].map((e,t)=>r._parse(new Zn(n,e,n.path,t)));return n.common.async?Promise.all(i).then(e=>a(e)):a(i)}min(e,t){return new Ds({...this._def,minSize:{value:e,message:Mn.toString(t)}})}max(e,t){return new Ds({...this._def,maxSize:{value:e,message:Mn.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Ds.create=(e,t)=>new Ds({valueType:e,minSize:null,maxSize:null,typeName:Xs.ZodSet,...Fn(t)});class js extends qn{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}js.create=(e,t)=>new js({getter:e,typeName:Xs.ZodLazy,...Fn(t)});class Ms extends qn{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return Cn(t,{received:t.data,code:kn.invalid_literal,expected:this._def.value}),Rn}return{status:"valid",value:e.data}}get value(){return this._def.value}}function Zs(e,t){return new Ls({values:e,typeName:Xs.ZodEnum,...Fn(t)})}Ms.create=(e,t)=>new Ms({value:e,typeName:Xs.ZodLiteral,...Fn(t)});class Ls extends qn{_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),n=this._def.values;return Cn(t,{expected:wn.joinValues(n),received:t.parsedType,code:kn.invalid_type}),Rn}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return Cn(t,{received:t.data,code:kn.invalid_enum_value,options:n}),Rn}return Nn(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return Ls.create(e,{...this._def,...t})}exclude(e,t=this._def){return Ls.create(this.options.filter(t=>!e.includes(t)),{...this._def,...t})}}Ls.create=Zs;class Fs extends qn{_parse(e){const t=wn.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==xn.string&&n.parsedType!==xn.number){const e=wn.objectValues(t);return Cn(n,{expected:wn.joinValues(e),received:n.parsedType,code:kn.invalid_type}),Rn}if(this._cache||(this._cache=new Set(wn.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const e=wn.objectValues(t);return Cn(n,{received:n.data,code:kn.invalid_enum_value,options:e}),Rn}return Nn(e.data)}get enum(){return this._def.values}}Fs.create=(e,t)=>new Fs({values:e,typeName:Xs.ZodNativeEnum,...Fn(t)});class qs extends qn{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==xn.promise&&!1===t.common.async)return Cn(t,{code:kn.invalid_type,expected:xn.promise,received:t.parsedType}),Rn;const n=t.parsedType===xn.promise?t.data:Promise.resolve(t.data);return Nn(n.then(e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap})))}}qs.create=(e,t)=>new qs({type:e,typeName:Xs.ZodPromise,...Fn(t)});class Us extends qn{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===Xs.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),s=this._def.effect||null,r={addIssue:e=>{Cn(n,e),e.fatal?t.abort():t.dirty()},get path(){return n.path}};if(r.addIssue=r.addIssue.bind(r),"preprocess"===s.type){const e=s.transform(n.data,r);if(n.common.async)return Promise.resolve(e).then(async e=>{if("aborted"===t.value)return Rn;const s=await this._def.schema._parseAsync({data:e,path:n.path,parent:n});return"aborted"===s.status?Rn:"dirty"===s.status||"dirty"===t.value?En(s.value):s});{if("aborted"===t.value)return Rn;const s=this._def.schema._parseSync({data:e,path:n.path,parent:n});return"aborted"===s.status?Rn:"dirty"===s.status||"dirty"===t.value?En(s.value):s}}if("refinement"===s.type){const e=e=>{const t=s.refinement(e,r);if(n.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===n.common.async){const s=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===s.status?Rn:("dirty"===s.status&&t.dirty(),e(s.value),{status:t.value,value:s.value})}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(n=>"aborted"===n.status?Rn:("dirty"===n.status&&t.dirty(),e(n.value).then(()=>({status:t.value,value:n.value}))))}if("transform"===s.type){if(!1===n.common.async){const e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!Dn(e))return Rn;const a=s.transform(e.value,r);if(a instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:a}}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(e=>Dn(e)?Promise.resolve(s.transform(e.value,r)).then(e=>({status:t.value,value:e})):Rn)}wn.assertNever(s)}}Us.create=(e,t,n)=>new Us({schema:e,typeName:Xs.ZodEffects,effect:t,...Fn(n)}),Us.createWithPreprocess=(e,t,n)=>new Us({schema:t,effect:{type:"preprocess",transform:e},typeName:Xs.ZodEffects,...Fn(n)});class Bs extends qn{_parse(e){return this._getType(e)===xn.undefined?Nn(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Bs.create=(e,t)=>new Bs({innerType:e,typeName:Xs.ZodOptional,...Fn(t)});class Js extends qn{_parse(e){return this._getType(e)===xn.null?Nn(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Js.create=(e,t)=>new Js({innerType:e,typeName:Xs.ZodNullable,...Fn(t)});class zs extends qn{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===xn.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}zs.create=(e,t)=>new zs({innerType:e,typeName:Xs.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...Fn(t)});class Ws extends qn{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},s=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return jn(s)?s.then(e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new In(n.common.issues)},input:n.data})})):{status:"valid",value:"valid"===s.status?s.value:this._def.catchValue({get error(){return new In(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}Ws.create=(e,t)=>new Ws({innerType:e,typeName:Xs.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...Fn(t)});class Gs extends qn{_parse(e){if(this._getType(e)!==xn.nan){const t=this._getOrReturnCtx(e);return Cn(t,{code:kn.invalid_type,expected:xn.nan,received:t.parsedType}),Rn}return{status:"valid",value:e.data}}}Gs.create=e=>new Gs({typeName:Xs.ZodNaN,...Fn(e)}),Symbol("zod_brand");class Ks extends qn{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class Hs extends qn{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?Rn:"dirty"===e.status?(t.dirty(),En(e.value)):this._def.out._parseAsync({data:e.value,path:n.path,parent:n})})();{const e=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?Rn:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}}static create(e,t){return new Hs({in:e,out:t,typeName:Xs.ZodPipeline})}}class Vs extends qn{_parse(e){const t=this._def.innerType._parse(e),n=e=>(Dn(e)&&(e.value=Object.freeze(e.value)),e);return jn(t)?t.then(e=>n(e)):n(t)}unwrap(){return this._def.innerType}}var Xs;Vs.create=(e,t)=>new Vs({innerType:e,typeName:Xs.ZodReadonly,...Fn(t)}),Ts.lazycreate,function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(Xs||(Xs={}));const Ys=ds.create,Qs=hs.create,er=(Gs.create,ms.create,fs.create),tr=(gs.create,_s.create,ys.create,vs.create,ws.create),nr=(bs.create,xs.create,Ss.create,ks.create),sr=Ts.create,rr=(Ts.strictCreate,As.create),ar=Os.create,ir=(Es.create,Ns.create,Ps.create),or=($s.create,Ds.create,js.create),cr=Ms.create,ur=Ls.create;Fs.create,qs.create,Us.create,Bs.create,Js.create,Us.createWithPreprocess,Hs.create;class lr{cacheToolsList;_cachedTools=void 0;logger;constructor(e){this.logger=e.logger??ln("openai-agents:stdio-mcp-client"),this.cacheToolsList=e.cacheToolsList??!1}debugLog(e){sn.enabled(this.logger.namespace)&&this.logger.debug(e())}}class dr{cacheToolsList;_cachedTools=void 0;logger;constructor(e){this.logger=e.logger??ln("openai-agents:streamable-http-mcp-client"),this.cacheToolsList=e.cacheToolsList??!1}debugLog(e){sn.enabled(this.logger.namespace)&&this.logger.debug(e())}}sr({name:Ys(),description:Ys().optional(),inputSchema:sr({type:cr("object"),properties:ir(Ys(),tr()),required:nr(Ys()),additionalProperties:er()})});class pr extends lr{underlying;constructor(e){super(e),this.underlying=new vr(e)}get name(){return this.underlying.name}connect(){return this.underlying.connect()}close(){return this.underlying.close()}async listTools(){if(this.cacheToolsList&&this._cachedTools)return this._cachedTools;const e=await this.underlying.listTools();return this.cacheToolsList&&(this._cachedTools=e),e}callTool(e,t){return this.underlying.callTool(e,t)}}class hr extends dr{underlying;constructor(e){super(e),this.underlying=new wr(e)}get name(){return this.underlying.name}connect(){return this.underlying.connect()}close(){return this.underlying.close()}async listTools(){if(this.cacheToolsList&&this._cachedTools)return this._cachedTools;const e=await this.underlying.listTools();return this.cacheToolsList&&(this._cachedTools=e),e}callTool(e,t){return this.underlying.callTool(e,t)}}const mr={};function fr(e){delete mr[e]}async function gr(e,t){return e.cacheToolsList&&mr[e.name]?mr[e.name].map(n=>yr(n,e,t)):Ia(async n=>{const s=await e.listTools();n.spanData.result=s.map(e=>e.name);const r=s.map(n=>yr(n,e,t));return e.cacheToolsList&&(mr[e.name]=s),r},{data:{server:e.name}})}async function _r(e,t=!1){return async function(e,t=!1){const n=[],s=new Set;for(const r of e){const e=await gr(r,t),a=[...new Set(e.map(e=>e.name))].filter(e=>s.has(e));if(a.length>0)throw new Kt(`Duplicate tool names found across MCP servers: ${a.join(", ")}`);for(const t of e)s.add(t.name),n.push(t)}return n}(e,t)}function yr(e,t,n){async function s(n,s){let r={};"string"==typeof n&&n?r=JSON.parse(n):"object"==typeof n&&null!=n&&(r=n);const a=Er();a&&(a.spanData.mcp_data={server:t.name});const i=await t.callTool(e.name,r);return 1===i.length?i[0]:i}const r={type:e.inputSchema?.type??"object",properties:e.inputSchema?.properties??{},required:e.inputSchema?.required??[],additionalProperties:e.inputSchema?.additionalProperties??!1};if(n||!0===r.additionalProperties)try{const t=function(e){const t={...e,additionalProperties:!1};return t.required||(t.required=[]),t}(r);return _n({name:e.name,description:e.description||"",parameters:t,strict:!0,execute:s})}catch(e){dn.warn(`Error converting MCP schema to strict mode: ${e}`)}const a={...r,additionalProperties:!0};return _n({name:e.name,description:e.description||"",parameters:a,strict:!1,execute:s})}class vr extends lr{constructor(e){super(e)}get name(){return"MCPServerStdio"}connect(){throw new Error("Method not implemented.")}close(){throw new Error("Method not implemented.")}listTools(){throw new Error("Method not implemented.")}callTool(e,t){throw new Error("Method not implemented.")}}class wr extends dr{constructor(e){super(e)}get name(){return"MCPServerStdio"}connect(){throw new Error("Method not implemented.")}close(){throw new Error("Method not implemented.")}listTools(){throw new Error("Method not implemented.")}callTool(e,t){throw new Error("Method not implemented.")}}class br{#e=new EventTarget;on(e,t){return this.#e.addEventListener(e,e=>t(...e.detail??[])),this}off(e,t){return this.#e.removeEventListener(e,e=>t(...e.detail??[])),this}emit(e,...t){const n=new CustomEvent(e,{detail:t});return this.#e.dispatchEvent(n)}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};return this.on(e,n),this}}const xr=crypto.randomUUID.bind(crypto),Sr=class{constructor(){}pipeTo(e,t){}pipeThrough(e,t){}},kr=globalThis.ReadableStream,Ir=(globalThis.ReadableStreamDefaultController,globalThis.TransformStream);class Tr{context=null;constructor(){}run(e,t){return this.context=e,t()}getStore(){return this.context}enterWith(e){this.context=e}}const Ar=new class{constructor(){}setTimeout(e,t){const n=setTimeout(e,t);return n.ref="function"==typeof n.ref?n.ref:()=>n,n.unref="function"==typeof n.unref?n.unref:()=>n,n.hasRef="function"==typeof n.hasRef?n.hasRef:()=>!0,n.refresh="function"==typeof n.refresh?n.refresh:()=>n,n}clearTimeout(e){window.clearTimeout(e)}};let Cr;function Or(){return Cr??=new Tr,Cr}function Rr(){const e=Or().getStore();return e?.trace?e.trace:null}function Er(){const e=Or().getStore();return e?.span?e.span:null}function Nr(e){return async()=>{const t=Rr();if(!t)throw new Error("No trace found");await t.start();const n=await e(t);return await t.end(),n}}async function Pr(e,t,n={}){const s="string"==typeof e?na().createTrace({...n,name:e}):e;return Or().run({trace:s},Nr(t))}async function $r(e,t={}){if(Rr())return await e();const n=na().createTrace(t);return Or().run({trace:n},Nr(e))}function Dr(e){const t=Or().getStore();if(!t)throw new Error("No existing trace found");t.span&&(t.span.previousSpan=t.previousSpan,t.previousSpan=t.span),t.span=e,Or().enterWith(t)}function jr(){const e=Or().getStore();e&&(e.span=e.previousSpan,e.previousSpan=e.previousSpan?.previousSpan,Or().enterWith(e))}function Mr(e){const t=Er();t&&t.setError(e)}function Zr(e){const t=Or().getStore();if(!t)throw new Error("No existing trace found");const n=(s=t,{trace:s.trace?.clone(),span:s.span?.clone(),previousSpan:s.previousSpan?.clone()});var s;return Or().run(n,e)}class Lr{async export(e){if(an.disabled)pn.debug("Tracing is disabled. Skipping export");else for(const t of e)"trace"===t.type?console.log(`[Exporter] Export trace traceId=${t.traceId} name=${t.name}`):console.log(`[Exporter] Export span: ${JSON.stringify(t)}`)}}class Fr{#t;#n;#s;#r;#a;#i=[];#o;#c=null;#u=!1;#l=null;constructor(e,{maxQueueSize:t=1e3,maxBatchSize:n=100,scheduleDelay:s=5e3,exportTriggerRatio:r=.8}={}){this.#t=t,this.#n=n,this.#s=s,this.#r=t*r,this.#a=e,this.#o=Ar,pn.debug("Automatic trace export loop is not supported in this environment. You need to manually call `getGlobalTraceProvider().forceFlush()` to export traces.")}start(){this.#l=new AbortController,this.#d()}async#p(e){this.#i.length+1>this.#t?pn.error("Dropping trace because buffer is full"):(this.#i.push(e),this.#i.length>this.#r&&await this.#h())}#d(){this.#c=this.#o.setTimeout(async()=>{await this.#h(),this.#d()},this.#s),"function"==typeof this.#c.unref&&this.#c.unref()}async#h(e=!1){if(0!==this.#i.length)if(pn.debug(`Exporting batches. Force: ${e}. Buffer size: ${this.#i.length}`),e||this.#i.length<this.#n){const e=[...this.#i];this.#i=[],this.#u=!0,await this.#a.export(e),this.#u=!1}else if(this.#i.length>0){const e=this.#i.splice(0,this.#n);this.#u=!0,await this.#a.export(e),this.#u=!1}}async onTraceStart(e){await this.#p(e)}async onTraceEnd(e){}async onSpanStart(e){}async onSpanEnd(e){await this.#p(e)}async shutdown(e){for(e&&this.#o.setTimeout(()=>{this.#l?.abort()},e),pn.debug("Shutting down gracefully");this.#i.length>0;){if(pn.debug(`Waiting for buffer to empty. Items left: ${this.#i.length}`),this.#u||await this.#h(!0),this.#l?.signal.aborted){pn.debug("Timeout reached, force flushing"),await this.#h(!0);break}await new Promise(e=>this.#o.setTimeout(e,500))}pn.debug("Buffer empty. Exiting"),this.#o&&this.#c&&this.#o.clearTimeout(this.#c)}async forceFlush(){this.#i.length>0&&await this.#h(!0)}}class qr{#m=[];start(){for(const e of this.#m)e.start&&e.start()}addTraceProcessor(e){this.#m.push(e)}setProcessors(e){pn.debug("Shutting down old processors");for(const e of this.#m)e.shutdown();this.#m=e}async onTraceStart(e){for(const t of this.#m)await t.onTraceStart(e)}async onTraceEnd(e){for(const t of this.#m)await t.onTraceEnd(e)}async onSpanStart(e){for(const t of this.#m)await t.onSpanStart(e)}async onSpanEnd(e){for(const t of this.#m)await t.onSpanEnd(e)}async shutdown(e){for(const t of this.#m)await t.shutdown(e)}async forceFlush(){for(const e of this.#m)await e.forceFlush()}}let Ur,Br=null,Jr=null;function zr(){return Jr||(Jr=new Fr((Br||(Br=new Lr),Br))),Jr}function Wr(){return(new Date).toISOString()}function Gr(){return`trace_${xr().replace(/-/g,"")}`}function Kr(){return`span_${xr().replace(/-/g,"").slice(0,24)}`}function Hr(){return`group_${xr().replace(/-/g,"").slice(0,24)}`}class Vr{type="trace.span";#f;#g;#_;#y;#v;#w;#b;#x;#S;constructor(e,t){this.#g=e.traceId,this.#_=e.spanId??Kr(),this.#f=e.data,this.#v=t,this.#y=e.parentId??null,this.#x=e.error??null,this.#w=e.startedAt??null,this.#b=e.endedAt??null}get traceId(){return this.#g}get spanData(){return this.#f}get spanId(){return this.#_}get parentId(){return this.#y}get previousSpan(){return this.#S}set previousSpan(e){this.#S=e}start(){this.#w?pn.warn("Span already started"):(this.#w=Wr(),this.#v.onSpanStart(this))}end(){this.#b?pn.debug("Span already finished",this.spanData):(this.#b=Wr(),this.#v.onSpanEnd(this))}setError(e){this.#x=e}get error(){return this.#x}get startedAt(){return this.#w}get endedAt(){return this.#b}clone(){const e=new Vr({traceId:this.traceId,spanId:this.spanId,parentId:this.parentId??void 0,data:this.spanData,startedAt:this.#w??void 0,endedAt:this.#b??void 0,error:this.#x??void 0},this.#v);return e.previousSpan=this.previousSpan?.clone(),e}toJSON(){return{object:this.type,id:this.spanId,trace_id:this.traceId,parent_id:this.parentId,started_at:this.startedAt,ended_at:this.endedAt,span_data:(e=this.spanData,Object.fromEntries(Object.entries(e).filter(([e])=>!e.startsWith("_")))),error:this.error};var e}}class Xr extends Vr{constructor(e,t){super({traceId:"no-op",spanId:"no-op",data:e},t)}start(){}end(){}setError(){}toJSON(){return null}}class Yr{type="trace";traceId;name;groupId=null;metadata;#v;#k;constructor(e,t){this.traceId=e.traceId??Gr(),this.name=e.name??"Agent workflow",this.groupId=e.groupId??null,this.metadata=e.metadata??{},this.#v=t??zr(),this.#k=e.started??!1}async start(){this.#k||(this.#k=!0,await this.#v.onTraceStart(this))}async end(){this.#k&&(this.#k=!1,await this.#v.onTraceEnd(this))}clone(){return new Yr({traceId:this.traceId,name:this.name,groupId:this.groupId??void 0,metadata:this.metadata,started:this.#k})}toJSON(){return{object:this.type,id:this.traceId,workflow_name:this.name,group_id:this.groupId,metadata:this.metadata}}}class Qr extends Yr{constructor(){super({})}async start(){}async end(){}toJSON(){return null}}class ea{#I;#T;constructor(){this.#I=new qr,this.#T=an.disabled,this.#A()}registerProcessor(e){this.#I.addTraceProcessor(e)}setProcessors(e){this.#I.setProcessors(e)}getCurrentTrace(){return Rr()}getCurrentSpan(){return Er()}setDisabled(e){this.#T=e}startExportLoop(){this.#I.start()}createTrace(e){if(this.#T)return pn.debug("Tracing is disabled, Not creating trace %o",e),new Qr;const t=e.traceId??Gr(),n=e.name??"Agent workflow";return pn.debug("Creating trace %s with name %s",t,n),new Yr({...e,name:n,traceId:t},this.#I)}createSpan(e,t){if(this.#T||e.disabled)return pn.debug("Tracing is disabled, Not creating span %o",e),new Xr(e.data,this.#I);let n,s;if(t){if(t instanceof Yr){if(t instanceof Qr)return pn.debug("Parent trace is no-op, returning NoopSpan"),new Xr(e.data,this.#I);s=t.traceId}else if(t instanceof Vr){if(t instanceof Xr)return pn.debug("Parent span is no-op, returning NoopSpan"),new Xr(e.data,this.#I);n=t.spanId,s=t.traceId}}else{const t=Rr(),r=Er();if(!t)return pn.error("No active trace. Make sure to start a trace with `withTrace()` first. Returning NoopSpan."),new Xr(e.data,this.#I);if(r instanceof Xr||t instanceof Qr)return pn.debug(`Parent ${r} or ${t} is no-op, returning NoopSpan`),new Xr(e.data,this.#I);s=t.traceId,r?(pn.debug("Using parent span %s",r.spanId),n=r.spanId):pn.debug("No parent span, using current trace %s",t.traceId)}return s?(pn.debug(`Creating span ${JSON.stringify(e.data)} with id ${e.spanId??s}`),new Vr({...e,traceId:s,parentId:n},this.#I)):(pn.error("No traceId found. Make sure to start a trace with `withTrace()` first. Returning NoopSpan."),new Xr(e.data,this.#I))}async shutdown(e){try{pn.debug("Shutting down tracing provider"),await this.#I.shutdown(e)}catch(e){pn.error("Error shutting down tracing provider %o",e)}}#A(){if("undefined"!=typeof process&&"function"==typeof process.on){const e=async()=>{const e=setTimeout(()=>{console.warn("Cleanup timeout, forcing exit"),process.exit(1)},5e3);try{await this.shutdown()}finally{clearTimeout(e)}};process.on("beforeExit",e),process.on("SIGINT",async()=>{await e(),ta("SIGINT")||process.exit(130)}),process.on("SIGTERM",async()=>{await e(),ta("SIGTERM")||process.exit(0)}),process.on("unhandledRejection",async(t,n)=>{pn.error("Unhandled rejection",t,n),await e(),process.listeners("unhandledRejection").length>1||process.exit(1)})}}async forceFlush(){await this.#I.forceFlush()}}function ta(e){return process.listeners(e).length>1}function na(){return Ur||(Ur=new ea),Ur}function sa(e){return async(t,...n)=>Zr(async()=>{const s=e(...n);Dr(s);try{return s.start(),await t(s)}catch(e){throw s.setError({message:e.message,data:e.data}),e}finally{s.end(),jr()}})}function ra(e,t){return e={},na().createSpan({...e,data:{type:"response",...e.data}},t)}const aa=sa(ra);function ia(e,t){return na().createSpan({...e,data:{type:"agent",name:e?.data?.name??"Agent",...e?.data}},t)}const oa=sa(ia);function ca(e,t){return na().createSpan({...e,data:{type:"function",input:e?.data?.input??"",output:e?.data?.output??"",...e?.data}},t)}const ua=sa(ca);function la(e,t){return na().createSpan({...e,data:{type:"handoff",...e?.data}},t)}const da=sa(la);function pa(e,t){return na().createSpan({...e,data:{type:"generation",...e?.data}},t)}const ha=sa(pa);function ma(e,t){return na().createSpan({...e,data:{type:"custom",data:{},...e?.data}},t)}const fa=sa(ma);function ga(e,t){return na().createSpan({...e,data:{type:"guardrail",triggered:!1,...e?.data}},t)}const _a=sa(ga);function ya(e,t){return na().createSpan({...e,data:{type:"transcription",...e.data}},t)}const va=sa(ya);function wa(e,t){return na().createSpan({...e,data:{type:"speech",...e.data}},t)}const ba=sa(wa);function xa(e,t){return na().createSpan({...e,data:{type:"speech_group",...e?.data}},t)}const Sa=sa(xa);function ka(e,t){return na().createSpan({...e,data:{type:"mcp_tools",...e?.data}},t)}const Ia=sa(ka);function Ta(e){na().registerProcessor(e)}function Aa(e){na().setProcessors(e)}function Ca(e){na().setDisabled(e)}function Oa(){na().startExportLoop()}class Ra{on(e,t){return this.eventEmitter.on(e,t),this.eventEmitter}off(e,t){return this.eventEmitter.off(e,t),this.eventEmitter}emit(e,...t){return this.eventEmitter.emit(e,...t)}once(e,t){return this.eventEmitter.once(e,t),this.eventEmitter}}class Ea extends Ra{eventEmitter=new br}class Na extends Ra{eventEmitter=new br}function Pa({name:e,execute:t}){return{type:"input",name:e,guardrailFunction:t,run:async n=>({guardrail:{type:"input",name:e},output:await t(n)})}}function $a({name:e,execute:t}){return{type:"output",name:e,guardrailFunction:t,run:async n=>({guardrail:{type:"output",name:e},agent:n.agent,agentOutput:n.agentOutput,output:await t(n)})}}function Da(e){return JSON.stringify({assistant:e.name})}class ja{toolName;toolDescription;inputJsonSchema={type:"object",properties:{},required:[],additionalProperties:!1};strictJsonSchema=!0;onInvokeHandoff;agentName;inputFilter;agent;getHandoffAsFunctionTool(){return{type:"function",name:this.toolName,description:this.toolDescription,parameters:this.inputJsonSchema,strict:this.strictJsonSchema}}constructor(e,t){this.agentName=e.name,this.onInvokeHandoff=t,this.toolName=function(e){return`transfer_to_${en(e.name)}`}(e),this.toolDescription=function(e){return`Handoff to the ${e.name} agent to handle the request. ${e.handoffDescription??""}`}(e),this.agent=e}}function Ma(e,t={}){let n;if(!!t.onHandoff!=!!t.inputType)throw new Kt("You must provide either both `onHandoff` and `inputType` or neither.");const s=new ja(e,async function(s,r){if(n){if(!r)throw Mr({message:`Handoff function expected non empty input but got: ${r}`,data:{details:"input is empty"}}),new Gt("Handoff function expected non empty input");try{const e=await n(r);t.onHandoff&&await t.onHandoff(s,e)}catch(e){throw Mr({message:"Invalid JSON provided",data:{}}),pn.dontLogToolData||pn.error(`Invalid JSON when parsing: ${r}. Error: ${e}`),new Gt("Invalid JSON provided")}}else await(t.onHandoff?.(s));return e});if(t.inputType){const e=tn(t.inputType,s.toolName);s.inputJsonSchema=e.schema,s.strictJsonSchema=!0,n=e.parser}return t.toolNameOverride&&(s.toolName=t.toolNameOverride),t.toolDescriptionOverride&&(s.toolDescription=t.toolDescriptionOverride),t.inputFilter&&(s.inputFilter=t.inputFilter),s}function Za(e){return e instanceof ja?e:Ma(e)}let La;function Fa(e){La=e}function qa(){if(void 0===La)throw new Error("No default model provider set. Make sure to set a provider using setDefaultModelProvider before calling getDefaultModelProvider or pass an explicit provider.");return La}const Ua=sr({providerData:ir(Ys(),tr()).optional()}),Ba=Ua.extend({id:Ys().optional()}),Ja=Ua.extend({type:cr("refusal"),refusal:Ys()}),za=Ua.extend({type:cr("output_text"),text:Ys()}),Wa=Ua.extend({type:cr("input_text"),text:Ys()}),Ga=Ua.extend({type:cr("input_image"),image:Ys().or(sr({id:Ys()})).describe("Could be a URL, base64 or an object with a file ID.")}),Ka=Ua.extend({type:cr("input_file"),file:Ys().describe("Either base64 encoded file data or a publicly accessible file URL").or(sr({id:Ys().describe("OpenAI file ID")})).or(sr({url:Ys().describe("Publicly accessible PDF file URL")})).describe("Contents of the file or an object with a file ID.")}),Ha=Ua.extend({type:cr("audio"),audio:Ys().or(sr({id:Ys()})).describe("Base64 encoded audio data or file id"),format:Ys().nullable().optional(),transcript:Ys().nullable().optional()}),Va=Ua.extend({type:cr("image"),image:Ys().describe("Base64 encoded image data")}),Xa=Ua.extend({type:cr("text"),text:Ys()}),Ya=Ua.extend({type:cr("image"),data:Ys().describe("Base64 encoded image data"),mediaType:Ys().describe("IANA media type of the image")}),Qa=Ua.extend({type:cr("computer_screenshot"),data:Ys().describe("Base64 encoded image data or URL")}),ei=ar("type",[sr({type:cr("screenshot")}),sr({type:cr("click"),x:Qs(),y:Qs(),button:ur(["left","right","wheel","back","forward"])}),sr({type:cr("double_click"),x:Qs(),y:Qs()}),sr({type:cr("scroll"),x:Qs(),y:Qs(),scroll_x:Qs(),scroll_y:Qs()}),sr({type:cr("type"),text:Ys()}),sr({type:cr("wait")}),sr({type:cr("move"),x:Qs(),y:Qs()}),sr({type:cr("keypress"),keys:nr(Ys())}),sr({type:cr("drag"),path:nr(sr({x:Qs(),y:Qs()}))})]),ti=ar("type",[za,Ja,Wa,Ha,Va]),ni=Ba.extend({type:cr("message").optional()}),si=ni.extend({role:cr("assistant"),status:ur(["in_progress","completed","incomplete"]),content:nr(ti)}),ri=ar("type",[Wa,Ga,Ka,Ha]),ai=ni.extend({role:cr("user"),content:nr(ri).or(Ys())}),ii=ni.extend({role:cr("system"),content:Ys()}),oi=ar("role",[ii,si,ai]),ci=Ba.extend({type:cr("hosted_tool_call"),name:Ys().describe("The name of the hosted tool"),arguments:Ys().describe("The arguments of the hosted tool call").optional(),status:Ys().optional(),output:Ys().optional()}),ui=Ba.extend({type:cr("function_call"),callId:Ys().describe("The ID of the tool call"),name:Ys().describe("The name of the function"),status:ur(["in_progress","completed","incomplete"]).optional(),arguments:Ys()}),li=Ba.extend({type:cr("function_call_result"),name:Ys().describe("The name of the tool"),callId:Ys().describe("The ID of the tool call"),status:ur(["in_progress","completed","incomplete"]),output:ar("type",[Xa,Ya])}),di=Ba.extend({type:cr("computer_call"),callId:Ys().describe("The ID of the computer call"),status:ur(["in_progress","completed","incomplete"]),action:ei}),pi=Ba.extend({type:cr("computer_call_result"),callId:Ys().describe("The ID of the computer call"),output:Qa}),hi=ar("type",[di,ui,ci]),mi=Ua.extend({id:Ys().optional(),type:cr("reasoning"),content:nr(Wa)}),fi=Ba.extend({type:cr("unknown")}),gi=ar("type",[si,ci,ui,di,mi,fi]),_i=rr([ai,si,ii,ci,ui,di,li,pi,mi,fi]),yi=sr({requests:Qs().optional(),inputTokens:Qs(),outputTokens:Qs(),totalTokens:Qs(),inputTokensDetails:ir(Ys(),Qs()).optional(),outputTokensDetails:ir(Ys(),Qs()).optional()}),vi=Ua.extend({type:cr("output_text_delta"),delta:Ys()}),wi=Ua.extend({type:cr("response_started")}),bi=Ua.extend({type:cr("response_done"),response:Ua.extend({id:Ys(),usage:yi,output:nr(gi)})}),xi=Ua.extend({type:cr("model"),event:tr().describe("The event from the model")}),Si=ar("type",[vi,bi,wi,xi]);class ki{requests;inputTokens;outputTokens;totalTokens;inputTokensDetails=[];outputTokensDetails=[];constructor(e){void 0===e?(this.requests=0,this.inputTokens=0,this.outputTokens=0,this.totalTokens=0,this.inputTokensDetails=[],this.outputTokensDetails=[]):(this.requests=e?.requests??1,this.inputTokens=e?.inputTokens??0,this.outputTokens=e?.outputTokens??0,this.totalTokens=e?.totalTokens??0,this.inputTokensDetails=e?.inputTokensDetails?[e.inputTokensDetails]:[],this.outputTokensDetails=e?.outputTokensDetails?[e.outputTokensDetails]:[])}add(e){this.requests+=e.requests,this.inputTokens+=e.inputTokens,this.outputTokens+=e.outputTokens,this.totalTokens+=e.totalTokens,e.inputTokensDetails&&this.inputTokensDetails.push(...e.inputTokensDetails),e.outputTokensDetails&&this.outputTokensDetails.push(...e.outputTokensDetails)}}class Ii{context;usage;#C;constructor(e={}){this.context=e,this.usage=new ki,this.#C=new Map}_rebuildApprovals(e){this.#C=new Map(Object.entries(e))}isToolApproved({toolName:e,callId:t}){const n=this.#C.get(e);if(!0===n?.approved&&!0===n.rejected)return pn.warn("Tool is permanently approved and rejected at the same time. Approval takes precedence"),!0;if(!0===n?.approved)return!0;if(!0===n?.rejected)return!1;const s=!!Array.isArray(n?.approved)&&n.approved.includes(t),r=!!Array.isArray(n?.rejected)&&n.rejected.includes(t);return s&&r?(pn.warn(`Tool call ${t} is both approved and rejected at the same time. Approval takes precedence`),!0):!!s||!r&&void 0}approveTool(e,{alwaysApprove:t=!1}={}){const n=e.rawItem.name;if(t)return void this.#C.set(n,{approved:!0,rejected:[]});const s=this.#C.get(n)??{approved:[],rejected:[]};if(Array.isArray(s.approved)){const t="callId"in e.rawItem?e.rawItem.callId:e.rawItem.id;s.approved.push(t)}this.#C.set(n,s)}rejectTool(e,{alwaysReject:t=!1}={}){const n=e.rawItem.name;if(t)return void this.#C.set(n,{approved:!1,rejected:!0});const s=this.#C.get(n)??{approved:[],rejected:[]};if(Array.isArray(s.rejected)){const t="callId"in e.rawItem?e.rawItem.callId:e.rawItem.id;s.rejected.push(t)}this.#C.set(n,s)}toJSON(){return{context:this.context,usage:this.usage,approvals:Object.fromEntries(this.#C.entries())}}}class Ti{state;constructor(e){this.state=e}get history(){return So(this.input,this.newItems)}get output(){return So([],this.newItems)}get input(){return this.state._originalInput}get newItems(){return this.state._generatedItems}get rawResponses(){return this.state._modelResponses}get lastResponseId(){const e=this.rawResponses;return e&&e.length>0?e[e.length-1].responseId:void 0}get lastAgent(){return this.state._currentAgent}get inputGuardrailResults(){return this.state._inputGuardrailResults}get outputGuardrailResults(){return this.state._outputGuardrailResults}get interruptions(){return"next_step_interruption"===this.state._currentStep?.type?this.state._currentStep.data.interruptions:[]}get finalOutput(){if("next_step_final_output"===this.state._currentStep?.type)return this.state._currentAgent.processFinalOutput(this.state._currentStep.output);pn.warn("Accessed finalOutput before agent run is completed.")}}class Ai extends Ti{constructor(e){super(e)}}class Ci extends Ti{get currentAgent(){return this.lastAgent}currentTurn=0;maxTurns;#x=null;#O;#R;#E;#N;#P;#$;#D=!1;constructor(e={}){super(e.state),this.#O=e.signal,this.#O&&this.#O.addEventListener("abort",async()=>{await this.#E.cancel()}),this.#E=new kr({start:e=>{this.#R=e},cancel:()=>{this.#D=!0}}),this.#N=new Promise((e,t)=>{this.#P=e,this.#$=t})}_addItem(e){this.cancelled||this.#R?.enqueue(e)}_done(){!this.cancelled&&this.#R&&(this.#R.close(),this.#R=void 0,this.#P?.())}_raiseError(e){!this.cancelled&&this.#R&&(this.#R.error(e),this.#R=void 0),this.#x=e,this.#$?.(e),this.#N.catch(e=>{pn.debug(`Resulted in an error: ${e}`)})}get cancelled(){return this.#D}toStream(){return this.#E}get completed(){return this.#N}get error(){return this.#x}toTextStream(e={}){const t=this.#E.pipeThrough(new Ir({transform(e,t){if("raw_model_stream_event"===e.type&&"output_text_delta"===e.data.type){const n=vi.parse(e.data);t.enqueue(n.delta)}}}));return e.compatibleWithNodeStreams?Sr.fromWeb(t):t}[Symbol.asyncIterator](){return this.#E[Symbol.asyncIterator]()}}function Oi(e){return"function"===e.type?{type:"function",name:e.name,description:e.description,parameters:e.parameters,strict:e.strict}:"computer"===e.type?{type:"computer",name:e.name,environment:e.computer.environment,dimensions:e.computer.dimensions}:{type:"hosted_tool",name:e.name,providerData:e.providerData}}function Ri(e){return{toolName:e.toolName,toolDescription:e.toolDescription,inputJsonSchema:e.inputJsonSchema,strictJsonSchema:e.strictJsonSchema}}class Ei{type="base_item";rawItem;toJSON(){return{type:this.type,rawItem:this.rawItem}}}class Ni extends Ei{rawItem;agent;type="message_output_item";constructor(e,t){super(),this.rawItem=e,this.agent=t}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}get content(){let e="";for(const t of this.rawItem.content)"output_text"===t.type&&(e+=t.text);return e}}class Pi extends Ei{rawItem;agent;type="tool_call_item";constructor(e,t){super(),this.rawItem=e,this.agent=t}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}class $i extends Ei{rawItem;agent;output;type="tool_call_output_item";constructor(e,t,n){super(),this.rawItem=e,this.agent=t,this.output=n}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON(),output:hn(this.output)}}}class Di extends Ei{rawItem;agent;type="reasoning_item";constructor(e,t){super(),this.rawItem=e,this.agent=t}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}class ji extends Ei{rawItem;agent;type="handoff_call_item";constructor(e,t){super(),this.rawItem=e,this.agent=t}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}class Mi extends Ei{rawItem;sourceAgent;targetAgent;type="handoff_output_item";constructor(e,t,n){super(),this.rawItem=e,this.sourceAgent=t,this.targetAgent=n}toJSON(){return{...super.toJSON(),sourceAgent:this.sourceAgent.toJSON(),targetAgent:this.targetAgent.toJSON()}}}class Zi extends Ei{rawItem;agent;type="tool_approval_item";constructor(e,t){super(),this.rawItem=e,this.agent=t}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}function Li(e){return e.filter(e=>"message_output_item"===e.type).map(e=>e.content).join("")}function Fi(e){if("message"!==e.type)return;if("assistant"!==e.role)return;const t=e.content[e.content.length-1];return"output_text"===t.type?t.text:void 0}class qi{data;type="raw_model_stream_event";constructor(e){this.data=e}}class Ui{name;item;type="run_item_stream_event";constructor(e,t){this.name=e,this.item=t}}class Bi{agent;type="agent_updated_stream_event";constructor(e){this.agent=e}}function Ji(e,t,n,s){const r=[],a=[],i=[],o=[],c=[],u=[],l=new Map(s.map(e=>[e.toolName,e])),d=new Map(n.filter(e=>"function"===e.type).map(e=>[e.name,e])),p=n.find(e=>"computer"===e.type),h=new Map(n.filter(e=>"hosted_tool"===e.type&&"mcp"===e.providerData?.type).map(e=>e).map(e=>[e.providerData.server_label,e]));for(const n of e.output){if("message"===n.type)"assistant"===n.role&&r.push(new Ni(n,t));else if("hosted_tool_call"===n.type){r.push(new Pi(n,t));const e=n.name;if(u.push(e),"mcp_approval_request"===n.providerData?.type||"mcp_approval_request"===n.name){const e=n.providerData,s=e.server_label,a=h.get(s);if(void 0===a){const e=`MCP server (${s}) not found in Agent (${t.name})`;throw Mr({message:e,data:{mcp_server_label:s}}),new Gt(e)}const i=new Zi({type:"hosted_tool_call",name:e.name,id:e.id,status:"in_progress",providerData:e},t);c.push({requestItem:i,mcpTool:a}),a.providerData.on_approval||r.push(i)}}else if("reasoning"===n.type)r.push(new Di(n,t));else if("computer_call"===n.type){if(r.push(new Pi(n,t)),u.push("computer_use"),!p)throw Mr({message:"Model produced computer action without a computer tool.",data:{agent_name:t.name}}),new Gt("Model produced computer action without a computer tool.");o.push({toolCall:n,computer:p})}if("function_call"!==n.type)continue;u.push(n.name);const e=l.get(n.name);if(e)r.push(new ji(n,t)),a.push({toolCall:n,handoff:e});else{const e=d.get(n.name);if(!e)throw Mr({message:`Tool ${n.name} not found in agent ${t.name}.`,data:{tool_name:n.name,agent_name:t.name}}),new Gt(`Tool ${n.name} not found in agent ${t.name}.`);r.push(new Pi(n,t)),i.push({toolCall:n,tool:e})}}return{newItems:r,handoffs:a,functions:i,computerActions:o,mcpApprovalRequests:c,toolsUsed:u,hasToolsOrApprovalsToRun:()=>a.length>0||i.length>0||c.length>0||o.length>0}}const zi=ar("type",[sr({type:cr("next_step_handoff"),newAgent:tr()}),sr({type:cr("next_step_final_output"),output:Ys()}),sr({type:cr("next_step_run_again")}),sr({type:cr("next_step_interruption"),data:ir(Ys(),tr())})]);class Wi{originalInput;modelResponse;preStepItems;newStepItems;nextStep;constructor(e,t,n,s,r){this.originalInput=e,this.modelResponse=t,this.preStepItems=n,this.newStepItems=s,this.nextStep=r}get generatedItems(){return this.preStepItems.concat(this.newStepItems)}}function Gi(e,t,n){return e.resetToolChoice&&t.hasUsedTools(e)?{...n,toolChoice:void 0}:n}async function Ki(e,t,n,s,r,a,i){const o=n.filter(e=>e instanceof Zi&&"callId"in e.rawItem&&"function_call"===e.rawItem.type).map(e=>e.rawItem.callId),c=r.functions.filter(e=>o.includes(e.toolCall.callId)),u=await Xi(e,c,a,i),l=u.map(e=>e.runItem),d=r.mcpApprovalRequests.filter(e=>"tool_approval_item"===e.requestItem.type&&"hosted_tool_call"===e.requestItem.rawItem.type&&"mcp_approval_request"===e.requestItem.rawItem.providerData?.type);for(const t of d){const n=t.requestItem.rawItem.id,s=i._context.isToolApproved({toolName:t.requestItem.rawItem.name,callId:n});if(void 0!==s){const t={approve:s,approval_request_id:n,reason:void 0};l.push(new Pi({type:"hosted_tool_call",name:"mcp_approval_response",providerData:t},e))}}const p=await to(e,u,i),h=n.filter(e=>!(e instanceof Zi));return p.isFinalOutput?(a.emit("agent_end",i._context,e,p.finalOutput),e.emit("agent_end",i._context,p.finalOutput),new Wi(t,s,h,l,{type:"next_step_final_output",output:p.finalOutput})):p.isInterrupted?new Wi(t,s,h,l,{type:"next_step_interruption",data:{interruptions:p.interruptions}}):new Wi(t,s,h,l,{type:"next_step_run_again"})}async function Hi(e,t,n,s,r,a,i){const c=n;let u=r.newItems;const[l,d]=await Promise.all([Xi(e,r.functions,a,i),Qi(e,r.computerActions,a,i._context)]);if(u=u.concat(l.map(e=>e.runItem)),u=u.concat(d),r.mcpApprovalRequests.length>0)for(const t of r.mcpApprovalRequests){const n=t.mcpTool.providerData,s=t.requestItem.rawItem.providerData;if(n.on_approval){const r=await n.on_approval(i._context,t.requestItem),a={approve:r.approve,approval_request_id:s.id,reason:r.reason};u.push(new Pi({type:"hosted_tool_call",name:"mcp_approval_response",providerData:a},e))}else{u.push(t.requestItem);const n={type:"hosted_mcp_tool_approval",tool:t.mcpTool,runItem:new Zi({type:"hosted_tool_call",name:s.name,id:s.id,arguments:s.arguments,status:"in_progress",providerData:s},e)};l.push(n)}}if(r.handoffs.length>0)return await async function(e,t,n,s,r,a,i,o){if(s=[...s],0===a.length)return pn.warn("Incorrectly called executeHandoffCalls with no handoffs. This should not happen. Moving on."),new Wi(t,r,n,s,{type:"next_step_run_again"});if(a.length>1){const t="Multiple handoffs detected, ignoring this one.";for(let n=1;n<a.length;n++)s.push(new $i(Vi(a[n].toolCall,t),e,t))}const c=a[0];return da(async u=>{const l=c.handoff,d=await l.onInvokeHandoff(o,c.toolCall.arguments);if(u.spanData.to_agent=d.name,a.length>1){const e=a.map(e=>e.handoff.agentName);u.setError({message:"Multiple handoffs requested",data:{requested_agents:e}})}s.push(new Mi(Vi(c.toolCall,Da(d)),e,d)),i.emit("agent_handoff",o,e,d),e.emit("agent_handoff",o,d);const p=l.inputFilter??i.config.handoffInputFilter;if(p){pn.debug("Filtering inputs for handoff"),"function"!=typeof p&&u.setError({message:"Invalid input filter",data:{details:"not callable"}});const e=p({inputHistory:Array.isArray(t)?[...t]:t,preHandoffItems:[...n],newItems:[...s]});t=e.inputHistory,n=e.preHandoffItems,s=e.newItems}return new Wi(t,r,n,s,{type:"next_step_handoff",newAgent:d})},{data:{from_agent:e.name}})}(e,t,c,u,s,r.handoffs,a,i._context);const p=await to(e,l,i);if(p.isFinalOutput)return a.emit("agent_end",i._context,e,p.finalOutput),e.emit("agent_end",i._context,p.finalOutput),new Wi(t,s,c,u,{type:"next_step_final_output",output:p.finalOutput});if(p.isInterrupted)return new Wi(t,s,c,u,{type:"next_step_interruption",data:{interruptions:p.interruptions}});const h=u.filter(e=>e instanceof Ni),m=h.length>0?Fi(h[h.length-1].rawItem):void 0;if(!m)return new Wi(t,s,c,u,{type:"next_step_run_again"});if("text"===e.outputType&&!r.hasToolsOrApprovalsToRun())return new Wi(t,s,c,u,{type:"next_step_final_output",output:m});if("text"!==e.outputType&&m){const{parser:n}=tn(e.outputType,"final_output"),[r]=await o(()=>n(m));if(r)throw Mr({message:"Invalid output type",data:{error:String(r)}}),new Gt("Invalid output type");return new Wi(t,s,c,u,{type:"next_step_final_output",output:m})}return new Wi(t,s,c,u,{type:"next_step_run_again"})}function Vi(e,t){return{type:"function_call_result",name:e.name,callId:e.callId,status:"completed",output:{type:"text",text:hn(t)}}}async function Xi(e,t,n,s){try{return await Promise.all(t.map(async function(t){let r=t.toolCall.arguments;if(t.tool.parameters&&(r=Qt(t.tool.parameters)?t.tool.parameters.parse(r):JSON.parse(r)),await t.tool.needsApproval(s._context,r,t.toolCall.callId)){const n=s._context.isToolApproved({toolName:t.tool.name,callId:t.toolCall.callId});if(!1===n)return ua(async n=>{const s="Tool execution was not approved.";return n.setError({message:s,data:{tool_name:t.tool.name,error:`Tool execution for ${t.toolCall.callId} was manually rejected by user.`}}),n.spanData.output=s,{type:"function_output",tool:t.tool,output:s,runItem:new $i(Vi(t.toolCall,s),e,s)}},{data:{name:t.tool.name}});if(!0!==n)return{type:"function_approval",tool:t.tool,runItem:new Zi(t.toolCall,e)}}return ua(async r=>{n.config.traceIncludeSensitiveData&&(r.spanData.input=t.toolCall.arguments);try{n.emit("agent_tool_start",s._context,e,t.tool,{toolCall:t.toolCall}),e.emit("agent_tool_start",s._context,t.tool,{toolCall:t.toolCall});const a=await t.tool.invoke(s._context,t.toolCall.arguments),i=hn(a);return n.emit("agent_tool_end",s._context,e,t.tool,i,{toolCall:t.toolCall}),e.emit("agent_tool_end",s._context,t.tool,i,{toolCall:t.toolCall}),n.config.traceIncludeSensitiveData&&(r.spanData.output=i),{type:"function_output",tool:t.tool,output:a,runItem:new $i(Vi(t.toolCall,a),e,a)}}catch(e){throw r.setError({message:"Error running tool",data:{tool_name:t.tool.name,error:String(e)}}),e}},{data:{name:t.tool.name}})}))}catch(e){throw new Vt(`Failed to run function tools: ${e}`,e,s)}}async function Yi(e,t){const n=t.action;let s;switch(n.type){case"click":await e.click(n.x,n.y,n.button);break;case"double_click":await e.doubleClick(n.x,n.y);break;case"drag":await e.drag(n.path.map(e=>[e.x,e.y]));break;case"keypress":await e.keypress(n.keys);break;case"move":await e.move(n.x,n.y);break;case"screenshot":s=await e.screenshot();break;case"scroll":await e.scroll(n.x,n.y,n.scroll_x,n.scroll_y);break;case"type":await e.type(n.text);break;case"wait":await e.wait()}if(void 0!==s)return s;if("function"==typeof e.screenshot&&(s=await e.screenshot(),void 0!==s))return s;throw new Error("Computer does not implement screenshot()")}async function Qi(e,t,n,s,r=void 0){const a=r??pn,i=[];for(const r of t){const t=r.computer.computer,o=r.toolCall;let c;n.emit("agent_tool_start",s,e,r.computer,{toolCall:o}),"function"==typeof e.emit&&e.emit("agent_tool_start",s,r.computer,{toolCall:o});try{c=await Yi(t,o)}catch(e){a.error("Failed to execute computer action:",e),c=""}n.emit("agent_tool_end",s,e,r.computer,c,{toolCall:o}),"function"==typeof e.emit&&e.emit("agent_tool_end",s,r.computer,c,{toolCall:o});const u=c?`data:image/png;base64,${c}`:"",l={type:"computer_call_result",callId:o.callId,output:{type:"computer_screenshot",data:u}};i.push(new $i(l,e,u))}return i}const eo={isFinalOutput:!1,isInterrupted:void 0};async function to(e,t,n){if(0===t.length)return eo;const s=t.filter(e=>e.runItem instanceof Zi).map(e=>e.runItem);if(s.length>0)return{isFinalOutput:!1,isInterrupted:!0,interruptions:s};if("run_llm_again"===e.toolUseBehavior)return eo;const r=t[0];if("stop_on_first_tool"===e.toolUseBehavior)return"function_output"===r?.type?{isFinalOutput:!0,isInterrupted:void 0,finalOutput:hn(r.output)}:eo;const a=e.toolUseBehavior;if("object"==typeof a){const e=t.find(e=>a.stopAtToolNames.includes(e.tool.name));return"function_output"===e?.type?{isFinalOutput:!0,isInterrupted:void 0,finalOutput:hn(e.output)}:eo}if("function"==typeof a)return a(n._context,t);throw new Kt(`Invalid toolUseBehavior: ${a}`,n)}function no(e,t){for(const n of t.newStepItems){let t;if(n instanceof Ni)t="message_output_created";else if(n instanceof ji)t="handoff_requested";else if(n instanceof Mi)t="handoff_occurred";else if(n instanceof Pi)t="tool_called";else if(n instanceof $i)t="tool_output";else if(n instanceof Di)t="reasoning_item_created";else{if(!(n instanceof Zi)){pn.warn("Unknown item type: ",n);continue}t="tool_approval_requested"}e._addItem(new Ui(t,n))}}class so{#j=new Map;addToolUse(e,t){this.#j.set(e,t)}hasUsedTools(e){return this.#j.has(e)}toJSON(){return Object.fromEntries(Array.from(this.#j.entries()).map(([e,t])=>[e.name,t]))}}const ro="1.0",ao=cr(ro),io=sr({name:Ys()}),oo=sr({object:cr("trace.span"),id:Ys(),trace_id:Ys(),parent_id:Ys().nullable(),started_at:Ys().nullable(),ended_at:Ys().nullable(),error:sr({message:Ys(),data:ir(Ys(),tr()).optional()}).nullable(),span_data:ir(Ys(),tr())}).extend({previous_span:or(()=>oo).optional()}),co=sr({requests:Qs(),inputTokens:Qs(),outputTokens:Qs(),totalTokens:Qs()}),uo=sr({usage:co,output:nr(gi),responseId:Ys().optional(),providerData:ir(Ys(),tr()).optional()}),lo=ar("type",[sr({type:cr("message_output_item"),rawItem:si,agent:io}),sr({type:cr("tool_call_item"),rawItem:hi.or(ci),agent:io}),sr({type:cr("tool_call_output_item"),rawItem:li,agent:io,output:Ys()}),sr({type:cr("reasoning_item"),rawItem:mi,agent:io}),sr({type:cr("handoff_call_item"),rawItem:ui,agent:io}),sr({type:cr("handoff_output_item"),rawItem:li,sourceAgent:io,targetAgent:io}),sr({type:cr("tool_approval_item"),rawItem:ui.or(ci),agent:io})]),po=sr({object:cr("trace"),id:Ys(),workflow_name:Ys(),group_id:Ys().nullable(),metadata:ir(Ys(),tr())}),ho=sr({newItems:nr(lo),toolsUsed:nr(Ys()),handoffs:nr(sr({toolCall:tr(),handoff:tr()})),functions:nr(sr({toolCall:tr(),tool:tr()})),computerActions:nr(sr({toolCall:tr(),computer:tr()})),mcpApprovalRequests:nr(sr({requestItem:sr({rawItem:sr({type:cr("hosted_tool_call"),name:Ys(),arguments:Ys().optional(),status:Ys().optional(),output:Ys().optional(),providerData:ir(Ys(),tr()).nullable().optional()})}),mcpTool:sr({type:cr("hosted_tool"),name:cr("hosted_mcp"),providerData:ir(Ys(),tr())})})).optional()}),mo=sr({tripwireTriggered:er(),outputInfo:tr()}),fo=sr({guardrail:sr({type:cr("input"),name:Ys()}),output:mo}),go=sr({guardrail:sr({type:cr("output"),name:Ys()}),agentOutput:tr(),agent:io,output:mo}),_o=sr({$schemaVersion:ao,currentTurn:Qs(),currentAgent:io,originalInput:Ys().or(nr(_i)),modelResponses:nr(uo),context:sr({usage:co,approvals:ir(Ys(),sr({approved:nr(Ys()).or(er()),rejected:nr(Ys()).or(er())})),context:ir(Ys(),tr())}),toolUseTracker:ir(Ys(),nr(Ys())),maxTurns:Qs(),currentAgentSpan:oo.nullable().optional(),noActiveAgentRun:er(),inputGuardrailResults:nr(fo),outputGuardrailResults:nr(go),currentStep:zi.optional(),lastModelResponse:uo.optional(),generatedItems:nr(lo),lastProcessedResponse:ho.optional(),trace:po.nullable()});class yo{_currentTurn=0;_currentAgent;_originalInput;_modelResponses;_currentAgentSpan;_context;_toolUseTracker;_generatedItems;_maxTurns;_noActiveAgentRun=!0;_lastTurnResponse;_inputGuardrailResults;_outputGuardrailResults;_currentStep=void 0;_lastProcessedResponse=void 0;_trace=null;constructor(e,t,n,s){this._context=e,this._originalInput=structuredClone(t),this._modelResponses=[],this._currentAgentSpan=void 0,this._currentAgent=n,this._toolUseTracker=new so,this._generatedItems=[],this._maxTurns=s,this._inputGuardrailResults=[],this._outputGuardrailResults=[],this._trace=Rr()}getInterruptions(){return"next_step_interruption"!==this._currentStep?.type?[]:this._currentStep.data.interruptions}approve(e,t={alwaysApprove:!1}){this._context.approveTool(e,t)}reject(e,t={alwaysReject:!1}){this._context.rejectTool(e,t)}toJSON(){const e={$schemaVersion:ro,currentTurn:this._currentTurn,currentAgent:{name:this._currentAgent.name},originalInput:this._originalInput,modelResponses:this._modelResponses.map(e=>({usage:{requests:e.usage.requests,inputTokens:e.usage.inputTokens,outputTokens:e.usage.outputTokens,totalTokens:e.usage.totalTokens},output:e.output,responseId:e.responseId,providerData:e.providerData})),context:this._context.toJSON(),toolUseTracker:this._toolUseTracker.toJSON(),maxTurns:this._maxTurns,currentAgentSpan:this._currentAgentSpan?.toJSON(),noActiveAgentRun:this._noActiveAgentRun,inputGuardrailResults:this._inputGuardrailResults,outputGuardrailResults:this._outputGuardrailResults.map(e=>({...e,agent:e.agent.toJSON()})),currentStep:this._currentStep,lastModelResponse:this._lastTurnResponse,generatedItems:this._generatedItems.map(e=>e.toJSON()),lastProcessedResponse:this._lastProcessedResponse,trace:this._trace?this._trace.toJSON():null},t=_o.safeParse(e);if(!t.success)throw new zt(`Failed to serialize run state. ${t.error.message}`);return t.data}toString(){return JSON.stringify(this.toJSON())}static async fromString(e,t){const[n,s]=await o(()=>JSON.parse(t));if(n)throw new Kt(`Failed to parse run state. ${n instanceof Error?n.message:String(n)}`);const r=s.$schemaVersion;if(!r)throw new Kt("Run state is missing schema version");if(r!==ro)throw new Kt(`Run state schema version ${r} is not supported. Please use version ${ro}`);const a=_o.parse(JSON.parse(t)),i=function(e){const t=new Map,n=[e];for(;n.length>0;){const e=n.shift();if(!t.has(e.name)){t.set(e.name,e);for(const s of e.handoffs)s instanceof Co?t.has(s.name)||n.push(s):s.agent&&(t.has(s.agent.name)||n.push(s.agent))}}return t}(e),c=new Ii(a.context.context);c._rebuildApprovals(a.context.approvals);const u=i.get(a.currentAgent.name);if(!u)throw new Kt(`Agent ${a.currentAgent.name} not found`);const l=new yo(c,"",u,a.maxTurns);l._currentTurn=a.currentTurn,l._toolUseTracker=new so;for(const[e,t]of Object.entries(a.toolUseTracker))l._toolUseTracker.addToolUse(i.get(e),t);if(a.currentAgentSpan){a.trace||pn.warn("Trace is not set, skipping tracing setup");const e=na().createTrace({traceId:a.trace?.id,name:a.trace?.workflow_name,groupId:a.trace?.group_id??void 0,metadata:a.trace?.metadata});l._currentAgentSpan=vo(e,a.currentAgentSpan),l._trace=e}return l._noActiveAgentRun=a.noActiveAgentRun,l._inputGuardrailResults=a.inputGuardrailResults,l._outputGuardrailResults=a.outputGuardrailResults.map(e=>({...e,agent:i.get(e.agent.name)})),l._currentStep=a.currentStep,l._originalInput=a.originalInput,l._modelResponses=a.modelResponses.map(wo),l._lastTurnResponse=a.lastModelResponse?wo(a.lastModelResponse):void 0,l._generatedItems=a.generatedItems.map(e=>bo(e,i)),l._lastProcessedResponse=a.lastProcessedResponse?await async function(e,t,n){const s=await t.getAllTools(),r=new Map(s.filter(e=>"function"===e.type).map(e=>[e.name,e])),a=new Map(s.filter(e=>"computer"===e.type).map(e=>[e.name,e])),i=new Map(t.handoffs.map(e=>e instanceof Co?[e.name,Ma(e)]:[e.toolName,e])),o={newItems:n.newItems.map(t=>bo(t,e)),toolsUsed:n.toolsUsed,handoffs:n.handoffs.map(e=>{if(!i.has(e.handoff.toolName))throw new Kt(`Handoff ${e.handoff.toolName} not found`);return{toolCall:e.toolCall,handoff:i.get(e.handoff.toolName)}}),functions:await Promise.all(n.functions.map(async e=>{if(!r.has(e.tool.name))throw new Kt(`Tool ${e.tool.name} not found`);return{toolCall:e.toolCall,tool:r.get(e.tool.name)}})),computerActions:n.computerActions.map(e=>{const t=e.computer.name;if(!a.has(t))throw new Kt(`Computer tool ${t} not found`);return{toolCall:e.toolCall,computer:a.get(t)}}),mcpApprovalRequests:(n.mcpApprovalRequests??[]).map(e=>({requestItem:new Zi(e.requestItem.rawItem,t),mcpTool:e.mcpTool}))};return{...o,hasToolsOrApprovalsToRun:()=>o.handoffs.length>0||o.functions.length>0||o.mcpApprovalRequests.length>0||o.computerActions.length>0}}(i,l._currentAgent,a.lastProcessedResponse):void 0,"next_step_handoff"===a.currentStep?.type&&(l._currentStep={type:"next_step_handoff",newAgent:i.get(a.currentStep.newAgent.name)}),l}}function vo(e,t){const n=t.span_data,s=t.previous_span?vo(e,t.previous_span):void 0,r=na().createSpan({spanId:t.id,traceId:t.trace_id,parentId:t.parent_id??void 0,startedAt:t.started_at??void 0,endedAt:t.ended_at??void 0,data:n},e);return r.previousSpan=s,r}function wo(e){const t=new ki;return t.requests=e.usage.requests,t.inputTokens=e.usage.inputTokens,t.outputTokens=e.usage.outputTokens,t.totalTokens=e.usage.totalTokens,{usage:t,output:e.output.map(e=>gi.parse(e)),responseId:e.responseId,providerData:e.providerData}}function bo(e,t){switch(e.type){case"message_output_item":return new Ni(e.rawItem,t.get(e.agent.name));case"tool_call_item":return new Pi(e.rawItem,t.get(e.agent.name));case"tool_call_output_item":return new $i(e.rawItem,t.get(e.agent.name),e.output);case"reasoning_item":return new Di(e.rawItem,t.get(e.agent.name));case"handoff_call_item":return new ji(e.rawItem,t.get(e.agent.name));case"handoff_output_item":return new Mi(e.rawItem,t.get(e.sourceAgent.name),t.get(e.targetAgent.name));case"tool_approval_item":return new Zi(e.rawItem,t.get(e.agent.name))}}function xo(e,t){return!e&&(!!t||"enabled_without_data")}function So(e,t){const n=t.filter(e=>"tool_approval_item"!==e.type).map(e=>e.rawItem);return"string"==typeof e&&(e=[{type:"message",role:"user",content:e}]),[...e,...n]}class ko extends Na{config;inputGuardrailDefs;outputGuardrailDefs;constructor(e={}){super(),this.config={modelProvider:e.modelProvider??qa(),model:e.model,modelSettings:e.modelSettings,handoffInputFilter:e.handoffInputFilter,inputGuardrails:e.inputGuardrails,outputGuardrails:e.outputGuardrails,tracingDisabled:e.tracingDisabled??!1,traceIncludeSensitiveData:e.traceIncludeSensitiveData??!0,workflowName:e.workflowName??"Agent workflow",traceId:e.traceId,groupId:e.groupId,traceMetadata:e.traceMetadata},this.inputGuardrailDefs=(e.inputGuardrails??[]).map(Pa),this.outputGuardrailDefs=(e.outputGuardrails??[]).map($a)}async#M(e,t,n){return Zr(async()=>{const s=t instanceof yo?t:new yo(n.context instanceof Ii?n.context:new Ii(n.context),t,e,n.maxTurns??10);try{for(;;){let e=To(s._currentAgent.model,this.config.model);if("string"==typeof e&&(e=await this.config.modelProvider.getModel(e)),s._currentStep=s._currentStep??{type:"next_step_run_again"},"next_step_interruption"===s._currentStep.type){if(pn.debug("Continuing from interruption"),!s._lastTurnResponse||!s._lastProcessedResponse)throw new Kt("No model response found in previous state",s);const e=await Ki(s._currentAgent,s._originalInput,s._generatedItems,s._lastTurnResponse,s._lastProcessedResponse,this,s);if(s._toolUseTracker.addToolUse(s._currentAgent,s._lastProcessedResponse.toolsUsed),s._originalInput=e.originalInput,s._generatedItems=e.generatedItems,s._currentStep=e.nextStep,"next_step_interruption"===e.nextStep.type)return new Ai(s);continue}if("next_step_run_again"===s._currentStep.type){const t=[];if(s._currentAgent.handoffs&&t.push(...s._currentAgent.handoffs.map(Za)),!s._currentAgentSpan){const e=t.map(e=>e.agentName);s._currentAgentSpan=ia({data:{name:s._currentAgent.name,handoffs:e,output_type:s._currentAgent.outputSchemaName}}),s._currentAgentSpan.start(),Dr(s._currentAgentSpan)}const r=await s._currentAgent.getAllTools(),a=r.map(e=>Oi(e)),i=t.map(e=>Ri(e));if(s._currentAgentSpan&&(s._currentAgentSpan.spanData.tools=r.map(e=>e.name)),s._currentTurn++,s._currentTurn>s._maxTurns)throw s._currentAgentSpan?.setError({message:"Max turns exceeded",data:{max_turns:s._maxTurns}}),new Wt(`Max turns (${s._maxTurns}) exceeded`,s);pn.debug(`Running agent ${s._currentAgent.name} (turn ${s._currentTurn})`),1===s._currentTurn&&await this.#Z(s);const o=So(s._originalInput,s._generatedItems);s._noActiveAgentRun&&(s._currentAgent.emit("agent_start",s._context,s._currentAgent),this.emit("agent_start",s._context,s._currentAgent));let c={...this.config.modelSettings,...s._currentAgent.modelSettings};c=Gi(s._currentAgent,s._toolUseTracker,c),s._lastTurnResponse=await e.getResponse({systemInstructions:await s._currentAgent.getSystemPrompt(s._context),prompt:await s._currentAgent.getPrompt(s._context),input:o,previousResponseId:n.previousResponseId,modelSettings:c,tools:a,outputType:nn(s._currentAgent.outputType),handoffs:i,tracing:xo(this.config.tracingDisabled,this.config.traceIncludeSensitiveData),signal:n.signal}),s._modelResponses.push(s._lastTurnResponse),s._context.usage.add(s._lastTurnResponse.usage),s._noActiveAgentRun=!1;const u=Ji(s._lastTurnResponse,s._currentAgent,r,t);s._lastProcessedResponse=u;const l=await Hi(s._currentAgent,s._originalInput,s._generatedItems,s._lastTurnResponse,s._lastProcessedResponse,this,s);s._toolUseTracker.addToolUse(s._currentAgent,s._lastProcessedResponse.toolsUsed),s._originalInput=l.originalInput,s._generatedItems=l.generatedItems,s._currentStep=l.nextStep}if(s._currentStep&&"next_step_final_output"===s._currentStep.type)return await this.#L(s,s._currentStep.output),this.emit("agent_end",s._context,s._currentAgent,s._currentStep.output),s._currentAgent.emit("agent_end",s._context,s._currentStep.output),new Ai(s);if(s._currentStep&&"next_step_handoff"===s._currentStep.type)s._currentAgent=s._currentStep.newAgent,s._currentAgentSpan&&(s._currentAgentSpan.end(),jr(),s._currentAgentSpan=void 0),s._noActiveAgentRun=!0,s._currentStep={type:"next_step_run_again"};else{if(s._currentStep&&"next_step_interruption"===s._currentStep.type)return new Ai(s);pn.debug("Running next loop")}}}catch(e){throw s._currentAgentSpan&&s._currentAgentSpan.setError({message:"Error in agent run",data:{error:String(e)}}),e}finally{s._currentAgentSpan&&("next_step_interruption"!==s._currentStep?.type&&s._currentAgentSpan.end(),jr())}})}async#Z(e){const t=this.inputGuardrailDefs.concat(e._currentAgent.inputGuardrails.map(Pa));if(t.length>0){const n={agent:e._currentAgent,input:e._originalInput,context:e._context};try{const s=await Promise.all(t.map(async t=>_a(async e=>{const s=await t.run(n);return e.spanData.triggered=s.output.tripwireTriggered,s},{data:{name:t.name}},e._currentAgentSpan)));for(const t of s)if(t.output.tripwireTriggered)throw e._currentAgentSpan&&e._currentAgentSpan.setError({message:"Guardrail tripwire triggered",data:{guardrail:t.guardrail.name}}),new Xt(`Input guardrail triggered: ${JSON.stringify(t.output.outputInfo)}`,t,e)}catch(t){if(t instanceof Xt)throw t;throw e._currentTurn--,new Ht(`Input guardrail failed to complete: ${t}`,t,e)}}}async#L(e,t){const n=this.outputGuardrailDefs.concat(e._currentAgent.outputGuardrails.map($a));if(n.length>0){const s=e._currentAgent.processFinalOutput(t),r={agent:e._currentAgent,agentOutput:s,context:e._context,details:{modelResponse:e._lastTurnResponse}};try{const t=await Promise.all(n.map(async t=>_a(async e=>{const n=await t.run(r);return e.spanData.triggered=n.output.tripwireTriggered,n},{data:{name:t.name}},e._currentAgentSpan)));for(const n of t)if(n.output.tripwireTriggered)throw e._currentAgentSpan&&e._currentAgentSpan.setError({message:"Guardrail tripwire triggered",data:{guardrail:n.guardrail.name}}),new Yt(`Output guardrail triggered: ${JSON.stringify(n.output.outputInfo)}`,n,e)}catch(t){if(t instanceof Yt)throw t;throw new Ht(`Output guardrail failed to complete: ${t}`,t,e)}}}async#F(e,t){try{for(;;){const n=e.state._currentAgent,s=n.handoffs.map(Za),r=await n.getAllTools(),a=r.map(e=>Oi(e)),i=s.map(e=>Ri(e));if(e.state._currentStep=e.state._currentStep??{type:"next_step_run_again"},"next_step_interruption"===e.state._currentStep.type){if(pn.debug("Continuing from interruption"),!e.state._lastTurnResponse||!e.state._lastProcessedResponse)throw new Kt("No model response found in previous state",e.state);const t=await Ki(e.state._currentAgent,e.state._originalInput,e.state._generatedItems,e.state._lastTurnResponse,e.state._lastProcessedResponse,this,e.state);if(no(e,t),e.state._toolUseTracker.addToolUse(e.state._currentAgent,e.state._lastProcessedResponse.toolsUsed),e.state._originalInput=t.originalInput,e.state._generatedItems=t.generatedItems,e.state._currentStep=t.nextStep,"next_step_interruption"===t.nextStep.type)return;continue}if("next_step_run_again"===e.state._currentStep.type){if(!e.state._currentAgentSpan){const t=s.map(e=>e.agentName);e.state._currentAgentSpan=ia({data:{name:n.name,handoffs:t,tools:r.map(e=>e.name),output_type:n.outputSchemaName}}),e.state._currentAgentSpan.start(),Dr(e.state._currentAgentSpan)}if(e.state._currentTurn++,e.state._currentTurn>e.state._maxTurns)throw e.state._currentAgentSpan?.setError({message:"Max turns exceeded",data:{max_turns:e.state._maxTurns}}),new Wt(`Max turns (${e.state._maxTurns}) exceeded`,e.state);pn.debug(`Running agent ${n.name} (turn ${e.state._currentTurn})`);let o=To(n.model,this.config.model);"string"==typeof o&&(o=await this.config.modelProvider.getModel(o)),1===e.state._currentTurn&&await this.#Z(e.state);let c={...this.config.modelSettings,...n.modelSettings};c=Gi(n,e.state._toolUseTracker,c);const u=So(e.input,e.newItems);let l;e.state._noActiveAgentRun&&(n.emit("agent_start",e.state._context,n),this.emit("agent_start",e.state._context,n));for await(const s of o.getStreamedResponse({systemInstructions:await n.getSystemPrompt(e.state._context),prompt:await n.getPrompt(e.state._context),input:u,previousResponseId:t.previousResponseId,modelSettings:c,tools:a,handoffs:i,outputType:nn(n.outputType),tracing:xo(this.config.tracingDisabled,this.config.traceIncludeSensitiveData),signal:t.signal})){if("response_done"===s.type){const e=bi.parse(s);l={usage:new ki(e.response.usage),output:e.response.output,responseId:e.response.id}}if(e.cancelled)return;e._addItem(new qi(s))}if(e.state._noActiveAgentRun=!1,!l)throw new Gt("Model did not produce a final response!",e.state);e.state._lastTurnResponse=l,e.state._modelResponses.push(e.state._lastTurnResponse);const d=Ji(e.state._lastTurnResponse,n,r,s);e.state._lastProcessedResponse=d;const p=await Hi(n,e.state._originalInput,e.state._generatedItems,e.state._lastTurnResponse,e.state._lastProcessedResponse,this,e.state);no(e,p),e.state._toolUseTracker.addToolUse(n,d.toolsUsed),e.state._originalInput=p.originalInput,e.state._generatedItems=p.generatedItems,e.state._currentStep=p.nextStep}if("next_step_final_output"===e.state._currentStep.type)return void await this.#L(e.state,e.state._currentStep.output);if("next_step_interruption"===e.state._currentStep.type)return;"next_step_handoff"===e.state._currentStep.type?(e.state._currentAgent=e.state._currentStep?.newAgent,e.state._currentAgentSpan&&(e.state._currentAgentSpan.end(),jr()),e.state._currentAgentSpan=void 0,e._addItem(new Bi(e.state._currentAgent)),e.state._noActiveAgentRun=!0,e.state._currentStep={type:"next_step_run_again"}):pn.debug("Running next loop")}}catch(t){throw e.state._currentAgentSpan&&e.state._currentAgentSpan.setError({message:"Error in agent run",data:{error:String(t)}}),t}finally{e.state._currentAgentSpan&&("next_step_interruption"!==e.state._currentStep?.type&&e.state._currentAgentSpan.end(),jr())}}async#q(e,t,n){return n=n??{},Zr(async()=>{const s=t instanceof yo?t:new yo(n.context instanceof Ii?n.context:new Ii(n.context),t,e,n.maxTurns??10),r=new Ci({signal:n.signal,state:s});return r.maxTurns=n.maxTurns??s._maxTurns,this.#F(r,n).then(()=>{r._done()},e=>{r._raiseError(e)}),r})}run(e,t,n={stream:!1,context:void 0}){return t instanceof yo&&t._trace?Pr(t._trace,async()=>(t._currentAgentSpan&&Dr(t._currentAgentSpan),n?.stream?this.#q(e,t,n):this.#M(e,t,n))):$r(async()=>n?.stream?this.#q(e,t,n):this.#M(e,t,n),{traceId:this.config.traceId,name:this.config.workflowName,groupId:this.config.groupId,metadata:this.config.traceMetadata})}}let Io;function To(e,t){return"string"==typeof e&&e!==Co.DEFAULT_MODEL_PLACEHOLDER||e?e:t??e??Co.DEFAULT_MODEL_PLACEHOLDER}async function Ao(e,t,n){const s=Io||(Io=new ko,Io);return await s.run(e,t,n)}class Co extends Ea{static create(e){return new Co({...e,handoffs:e.handoffs,outputType:e.outputType,handoffOutputTypeWarningEnabled:!1})}static DEFAULT_MODEL_PLACEHOLDER="";name;instructions;prompt;handoffDescription;handoffs;model;modelSettings;tools;mcpServers;inputGuardrails;outputGuardrails;outputType="text";toolUseBehavior;resetToolChoice;constructor(e){if(super(),"string"!=typeof e.name||""===e.name.trim())throw new Kt("Agent must have a name.");if(this.name=e.name,this.instructions=e.instructions??Co.DEFAULT_MODEL_PLACEHOLDER,this.prompt=e.prompt,this.handoffDescription=e.handoffDescription??"",this.handoffs=e.handoffs??[],this.model=e.model??"",this.modelSettings=e.modelSettings??{},this.tools=e.tools??[],this.mcpServers=e.mcpServers??[],this.inputGuardrails=e.inputGuardrails??[],this.outputGuardrails=e.outputGuardrails??[],e.outputType&&(this.outputType=e.outputType),this.toolUseBehavior=e.toolUseBehavior??"run_llm_again",this.resetToolChoice=e.resetToolChoice??!0,(void 0===e.handoffOutputTypeWarningEnabled||e.handoffOutputTypeWarningEnabled)&&this.handoffs&&this.outputType){const e=new Set([JSON.stringify(this.outputType)]);for(const t of this.handoffs)"outputType"in t&&t.outputType?e.add(JSON.stringify(t.outputType)):"agent"in t&&t.agent.outputType&&e.add(JSON.stringify(t.agent.outputType));e.size>1&&pn.warn(`[Agent] Warning: Handoff agents have different output types: ${Array.from(e).join(", ")}. You can make it type-safe by using Agent.create({ ... }) method instead.`)}}get outputSchemaName(){if("text"===this.outputType)return"text";if(Qt(this.outputType))return"ZodOutput";if("object"==typeof this.outputType)return this.outputType.name;throw new Error(`Unknown output type: ${this.outputType}`)}clone(e){return new Co({...this,...e})}asTool(e){const{toolName:t,toolDescription:n,customOutputExtractor:s}=e;return _n({name:t??en(this.name),description:n??"",parameters:{type:"object",properties:{input:{type:"string"}},required:["input"],additionalProperties:!1},strict:!0,execute:async(e,t)=>{if("object"!=typeof(n=e)||null===n||!("input"in n)||"string"!=typeof n.input)throw new Gt("Agent tool called with invalid input");var n;const r=new ko,a=await r.run(this,e.input,{context:t?.context});return"function"==typeof s?s(a):0===(i=a.rawResponses[a.rawResponses.length-1]).output.length?"":Fi(i.output[i.output.length-1])||"";var i}})}async getSystemPrompt(e){return"function"==typeof this.instructions?await this.instructions(e,this):this.instructions}async getPrompt(e){return"function"==typeof this.prompt?await this.prompt(e,this):this.prompt}async getMcpTools(){return this.mcpServers.length>0?_r(this.mcpServers):[]}async getAllTools(){return[...await this.getMcpTools(),...this.tools]}processFinalOutput(e){if("text"===this.outputType)return e;if("object"==typeof this.outputType){const t=JSON.parse(e);return Qt(this.outputType)?this.outputType.parse(t):t}throw new Error(`Unknown output type: ${this.outputType}`)}toJSON(){return{name:this.name}}}function Oo(e,t){return{type:"message",role:"user",content:"string"==typeof e?[{type:"input_text",text:e}]:e,providerData:t}}function Ro(e,t){return{type:"message",role:"system",content:e,providerData:t}}function Eo(e,t){return{type:"message",role:"assistant",content:"string"==typeof e?[{type:"output_text",text:e}]:e,status:"completed",providerData:t}}function No(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n}function Po(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)}Ta(zr());let $o=function(){const{crypto:e}=globalThis;if(e?.randomUUID)return $o=e.randomUUID.bind(e),e.randomUUID();const t=new Uint8Array(1),n=e?()=>e.getRandomValues(t)[0]:()=>255*Math.random()&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(+e^n()&15>>+e/4).toString(16))};const Do=/^[a-z][a-z0-9+.-]*:/i;let jo=e=>(jo=Array.isArray,jo(e)),Mo=jo;function Zo(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}const Lo=e=>new Promise(t=>setTimeout(t,e)),Fo="5.10.1",qo=()=>{const e="undefined"!=typeof Deno&&null!=Deno.build?"deno":"undefined"!=typeof EdgeRuntime?"edge":"[object process]"===Object.prototype.toString.call(void 0!==globalThis.process?globalThis.process:0)?"node":"unknown";if("deno"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Fo,"X-Stainless-OS":Bo(Deno.build.os),"X-Stainless-Arch":Uo(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Fo,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if("node"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Fo,"X-Stainless-OS":Bo(globalThis.process.platform??"unknown"),"X-Stainless-Arch":Uo(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const t=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e)return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}return null}();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Fo,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Fo,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}},Uo=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",Bo=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let Jo;function zo(...e){const t=globalThis.ReadableStream;if(void 0===t)throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new t(...e)}function Wo(e){let t=Symbol.asyncIterator in e?e[Symbol.asyncIterator]():e[Symbol.iterator]();return zo({start(){},async pull(e){const{done:n,value:s}=await t.next();n?e.close():e.enqueue(s)},async cancel(){await(t.return?.())}})}function Go(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const Ko=({headers:e,body:t})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(t)}),Ho="RFC3986",Vo=e=>String(e),Xo={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:Vo};let Yo=(e,t)=>(Yo=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),Yo(e,t));const Qo=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),ec=1024;function tc(e,t){if(jo(e)){const n=[];for(let s=0;s<e.length;s+=1)n.push(t(e[s]));return n}return t(e)}const nc={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},sc=function(e,t){Array.prototype.push.apply(e,jo(t)?t:[t])};let rc;const ac={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,n,s,r)=>{if(0===e.length)return e;let a=e;if("symbol"==typeof e?a=Symbol.prototype.toString.call(e):"string"!=typeof e&&(a=String(e)),"iso-8859-1"===n)return escape(a).replace(/%u[0-9a-f]{4}/gi,function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"});let i="";for(let e=0;e<a.length;e+=ec){const t=a.length>=ec?a.slice(e,e+ec):a,n=[];for(let e=0;e<t.length;++e){let s=t.charCodeAt(e);45===s||46===s||95===s||126===s||s>=48&&s<=57||s>=65&&s<=90||s>=97&&s<=122||"RFC1738"===r&&(40===s||41===s)?n[n.length]=t.charAt(e):s<128?n[n.length]=Qo[s]:s<2048?n[n.length]=Qo[192|s>>6]+Qo[128|63&s]:s<55296||s>=57344?n[n.length]=Qo[224|s>>12]+Qo[128|s>>6&63]+Qo[128|63&s]:(e+=1,s=65536+((1023&s)<<10|1023&t.charCodeAt(e)),n[n.length]=Qo[240|s>>18]+Qo[128|s>>12&63]+Qo[128|s>>6&63]+Qo[128|63&s])}i+=n.join("")}return i},encodeValuesOnly:!1,format:Ho,formatter:Vo,indices:!1,serializeDate:e=>(rc??(rc=Function.prototype.call.bind(Date.prototype.toISOString)))(e),skipNulls:!1,strictNullHandling:!1},ic={};function oc(e,t,n,s,r,a,i,o,c,u,l,d,p,h,m,f,g,_){let y=e,v=_,w=0,b=!1;for(;void 0!==(v=v.get(ic))&&!b;){const t=v.get(e);if(w+=1,void 0!==t){if(t===w)throw new RangeError("Cyclic object value");b=!0}void 0===v.get(ic)&&(w=0)}if("function"==typeof u?y=u(t,y):y instanceof Date?y=p?.(y):"comma"===n&&jo(y)&&(y=tc(y,function(e){return e instanceof Date?p?.(e):e})),null===y){if(a)return c&&!f?c(t,ac.encoder,g,"key",h):t;y=""}if("string"==typeof(x=y)||"number"==typeof x||"boolean"==typeof x||"symbol"==typeof x||"bigint"==typeof x||function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(y)){if(c){const e=f?t:c(t,ac.encoder,g,"key",h);return[m?.(e)+"="+m?.(c(y,ac.encoder,g,"value",h))]}return[m?.(t)+"="+m?.(String(y))]}var x;const S=[];if(void 0===y)return S;let k;if("comma"===n&&jo(y))f&&c&&(y=tc(y,c)),k=[{value:y.length>0?y.join(",")||null:void 0}];else if(jo(u))k=u;else{const e=Object.keys(y);k=l?e.sort(l):e}const I=o?String(t).replace(/\./g,"%2E"):String(t),T=s&&jo(y)&&1===y.length?I+"[]":I;if(r&&jo(y)&&0===y.length)return T+"[]";for(let t=0;t<k.length;++t){const v=k[t],b="object"==typeof v&&void 0!==v.value?v.value:y[v];if(i&&null===b)continue;const x=d&&o?v.replace(/\./g,"%2E"):v,I=jo(y)?"function"==typeof n?n(T,x):T:T+(d?"."+x:"["+x+"]");_.set(e,w);const A=new WeakMap;A.set(ic,_),sc(S,oc(b,I,n,s,r,a,i,o,"comma"===n&&f&&jo(y)?null:c,u,l,d,p,h,m,f,g,A))}return S}let cc,uc;function lc(e){let t;return(cc??(t=new globalThis.TextEncoder,cc=t.encode.bind(t)))(e)}function dc(e){let t;return(uc??(t=new globalThis.TextDecoder,uc=t.decode.bind(t)))(e)}var pc,hc;class mc{constructor(){pc.set(this,void 0),hc.set(this,void 0),No(this,pc,new Uint8Array,"f"),No(this,hc,null,"f")}decode(e){if(null==e)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?lc(e):e;No(this,pc,function(e){let t=0;for(const n of e)t+=n.length;const n=new Uint8Array(t);let s=0;for(const t of e)n.set(t,s),s+=t.length;return n}([Po(this,pc,"f"),t]),"f");const n=[];let s;for(;null!=(s=fc(Po(this,pc,"f"),Po(this,hc,"f")));){if(s.carriage&&null==Po(this,hc,"f")){No(this,hc,s.index,"f");continue}if(null!=Po(this,hc,"f")&&(s.index!==Po(this,hc,"f")+1||s.carriage)){n.push(dc(Po(this,pc,"f").subarray(0,Po(this,hc,"f")-1))),No(this,pc,Po(this,pc,"f").subarray(Po(this,hc,"f")),"f"),No(this,hc,null,"f");continue}const e=null!==Po(this,hc,"f")?s.preceding-1:s.preceding,t=dc(Po(this,pc,"f").subarray(0,e));n.push(t),No(this,pc,Po(this,pc,"f").subarray(s.index),"f"),No(this,hc,null,"f")}return n}flush(){return Po(this,pc,"f").length?this.decode("\n"):[]}}function fc(e,t){for(let n=t??0;n<e.length;n++){if(10===e[n])return{preceding:n,index:n+1,carriage:!1};if(13===e[n])return{preceding:n,index:n+1,carriage:!0}}return null}function gc(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}pc=new WeakMap,hc=new WeakMap,mc.NEWLINE_CHARS=new Set(["\n","\r"]),mc.NEWLINE_REGEXP=/\r\n|[\n\r]/g;const _c={off:0,error:200,warn:300,info:400,debug:500},yc=(e,t,n)=>{var s,r;if(e)return s=_c,r=e,Object.prototype.hasOwnProperty.call(s,r)?e:void Sc(n).warn(`${t} was set to ${JSON.stringify(e)}, expected one of ${JSON.stringify(Object.keys(_c))}`)};function vc(){}function wc(e,t,n){return!t||_c[e]>_c[n]?vc:t[e].bind(t)}const bc={error:vc,warn:vc,info:vc,debug:vc};let xc=new WeakMap;function Sc(e){const t=e.logger,n=e.logLevel??"off";if(!t)return bc;const s=xc.get(t);if(s&&s[0]===n)return s[1];const r={error:wc("error",t,n),warn:wc("warn",t,n),info:wc("info",t,n),debug:wc("debug",t,n)};return xc.set(t,[n,r]),r}const kc=e=>(e.options&&(e.options={...e.options},delete e.options.headers),e.headers&&(e.headers=Object.fromEntries((e.headers instanceof Headers?[...e.headers]:Object.entries(e.headers)).map(([e,t])=>[e,"authorization"===e.toLowerCase()||"cookie"===e.toLowerCase()||"set-cookie"===e.toLowerCase()?"***":t]))),"retryOfRequestLogID"in e&&(e.retryOfRequestLogID&&(e.retryOf=e.retryOfRequestLogID),delete e.retryOfRequestLogID),e);var Ic,Tc,Ac;class Cc{constructor(e,t,n){this.iterator=e,Ic.set(this,void 0),this.controller=t,No(this,Ic,n,"f")}static fromSSEResponse(e,t,n){let s=!1;const r=n?Sc(n):console;return new Cc(async function*(){if(s)throw new l("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let n=!1;try{for await(const s of async function*(e,t){if(!e.body){if(t.abort(),void 0!==globalThis.navigator&&"ReactNative"===globalThis.navigator.product)throw new l("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new l("Attempted to iterate over a response with no body")}const n=new Oc,s=new mc,r=Go(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?lc(n):n;let s,r=new Uint8Array(t.length+e.length);for(r.set(t),r.set(e,t.length),t=r;-1!==(s=gc(t));)yield t.slice(0,s),t=t.slice(s)}t.length>0&&(yield t)}(r))for(const t of s.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of s.flush()){const t=n.decode(e);t&&(yield t)}}(e,t))if(!n)if(s.data.startsWith("[DONE]"))n=!0;else if(null===s.event||s.event.startsWith("response.")||s.event.startsWith("image_edit.")||s.event.startsWith("image_generation.")||s.event.startsWith("transcript.")){let t;try{t=JSON.parse(s.data)}catch(e){throw r.error("Could not parse message into JSON:",s.data),r.error("From chunk:",s.raw),e}if(t&&t.error)throw new d(void 0,t.error,void 0,e.headers);yield t}else{let e;try{e=JSON.parse(s.data)}catch(e){throw console.error("Could not parse message into JSON:",s.data),console.error("From chunk:",s.raw),e}if("error"==s.event)throw new d(void 0,e.error,e.message,void 0);yield{event:s.event,data:e}}n=!0}catch(e){if(c(e))return;throw e}finally{n||t.abort()}},t,n)}static fromReadableStream(e,t,n){let s=!1;return new Cc(async function*(){if(s)throw new l("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let n=!1;try{for await(const t of async function*(){const t=new mc,n=Go(e);for await(const e of n)for(const n of t.decode(e))yield n;for(const e of t.flush())yield e}())n||t&&(yield JSON.parse(t));n=!0}catch(e){if(c(e))return;throw e}finally{n||t.abort()}},t,n)}[(Ic=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),s=s=>({next:()=>{if(0===s.length){const s=n.next();e.push(s),t.push(s)}return s.shift()}});return[new Cc(()=>s(e),this.controller,Po(this,Ic,"f")),new Cc(()=>s(t),this.controller,Po(this,Ic,"f"))]}toReadableStream(){const e=this;let t;return zo({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:n,done:s}=await t.next();if(s)return e.close();const r=lc(JSON.stringify(n)+"\n");e.enqueue(r)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}class Oc{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,s]=function(e){const t=e.indexOf(":");return-1!==t?[e.substring(0,t),":",e.substring(t+1)]:[e,"",""]}(e);return s.startsWith(" ")&&(s=s.substring(1)),"event"===t?this.event=s:"data"===t&&this.data.push(s),null}}async function Rc(e,t){const{response:n,requestLogID:s,retryOfRequestLogID:r,startTime:a}=t,i=await(async()=>{if(t.options.stream)return Sc(e).debug("response",n.status,n.url,n.headers,n.body),t.options.__streamClass?t.options.__streamClass.fromSSEResponse(n,t.controller,e):Cc.fromSSEResponse(n,t.controller,e);if(204===n.status)return null;if(t.options.__binaryResponse)return n;const s=n.headers.get("content-type"),r=s?.split(";")[0]?.trim();return r?.includes("application/json")||r?.endsWith("+json")?Ec(await n.json(),n):await n.text()})();return Sc(e).debug(`[${s}] response parsed`,kc({retryOfRequestLogID:r,url:n.url,status:n.status,body:i,durationMs:Date.now()-a})),i}function Ec(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}class Nc extends Promise{constructor(e,t,n=Rc){super(e=>{e(null)}),this.responsePromise=t,this.parseResponse=n,Tc.set(this,void 0),No(this,Tc,e,"f")}_thenUnwrap(e){return new Nc(Po(this,Tc,"f"),this.responsePromise,async(t,n)=>Ec(e(await this.parseResponse(t,n),n),n.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(Po(this,Tc,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}Tc=new WeakMap;class Pc{constructor(e,t,n,s){Ac.set(this,void 0),No(this,Ac,e,"f"),this.options=s,this.response=t,this.body=n}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageRequestOptions()}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new l("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await Po(this,Ac,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Ac=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class $c extends Nc{constructor(e,t,n){super(e,t,async(e,t)=>new n(e,t.response,await Rc(e,t),t.options))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}class Dc extends Pc{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class jc extends Pc{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[],this.has_more=n.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){const e=this.getPaginatedItems(),t=e[e.length-1]?.id;return t?{...this.options,query:{...(n=this.options.query,"object"!=typeof n?{}:n??{}),after:t}}:null;var n}}const Mc=()=>{if("undefined"==typeof File){const{process:e}=globalThis,t="string"==typeof e?.versions?.node&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function Zc(e,t,n){return Mc(),new File(e,t??"unknown_file",n)}function Lc(e){return("object"==typeof e&&null!==e&&("name"in e&&e.name&&String(e.name)||"url"in e&&e.url&&String(e.url)||"filename"in e&&e.filename&&String(e.filename)||"path"in e&&e.path&&String(e.path))||"").split(/[\\/]/).pop()||void 0}const Fc=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],qc=async(e,t)=>({...e,body:await Bc(e.body,t)}),Uc=new WeakMap,Bc=async(e,t)=>{if(!await function(e){const t="function"==typeof e?e:e.fetch,n=Uc.get(t);if(n)return n;const s=(async()=>{try{const e="Response"in t?t.Response:(await t("data:,")).constructor,n=new FormData;return n.toString()!==await new e(n).text()}catch{return!0}})();return Uc.set(t,s),s}(t))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const n=new FormData;return await Promise.all(Object.entries(e||{}).map(([e,t])=>Jc(n,e,t))),n},Jc=async(e,t,n)=>{if(void 0!==n){if(null==n)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof n||"number"==typeof n||"boolean"==typeof n)e.append(t,String(n));else if(n instanceof Response)e.append(t,Zc([await n.blob()],Lc(n)));else if(Fc(n))e.append(t,Zc([await new Response(Wo(n)).blob()],Lc(n)));else if((e=>e instanceof Blob&&"name"in e)(n))e.append(t,n,Lc(n));else if(Array.isArray(n))await Promise.all(n.map(n=>Jc(e,t+"[]",n)));else{if("object"!=typeof n)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`);await Promise.all(Object.entries(n).map(([n,s])=>Jc(e,`${t}[${n}]`,s)))}}},zc=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function Wc(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(zc(e))t.push(e instanceof Blob?e:await e.arrayBuffer());else{if(!Fc(e)){const t=e?.constructor?.name;throw new Error(`Unexpected data type: ${typeof e}${t?`; constructor: ${t}`:""}${function(e){if("object"!=typeof e||null===e)return"";return`; props: [${Object.getOwnPropertyNames(e).map(e=>`"${e}"`).join(", ")}]`}(e)}`)}for await(const n of e)t.push(...await Wc(n))}return t}class Gc{constructor(e){this._client=e}}function Kc(e){return e.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const Hc=Object.freeze(Object.create(null)),Vc=(e=Kc)=>function(t,...n){if(1===t.length)return t[0];let s=!1;const r=[],a=t.reduce((t,a,i)=>{/[?#]/.test(a)&&(s=!0);const o=n[i];let c=(s?encodeURIComponent:e)(""+o);return i!==n.length&&(null==o||"object"==typeof o&&o.toString===Object.getPrototypeOf(Object.getPrototypeOf(o.hasOwnProperty??Hc)??Hc)?.toString)&&(c=o+"",r.push({start:t.length+a.length,length:c.length,error:`Value of type ${Object.prototype.toString.call(o).slice(8,-1)} is not a valid path parameter`})),t+a+(i===n.length?"":c)},""),i=a.split(/[?#]/,1)[0],o=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi;let c;for(;null!==(c=o.exec(i));)r.push({start:c.index,length:c[0].length,error:`Value "${c[0]}" can't be safely passed as a path parameter`});if(r.sort((e,t)=>e.start-t.start),r.length>0){let e=0;const t=r.reduce((t,n)=>{const s=" ".repeat(n.start-e),r="^".repeat(n.length);return e=n.start+n.length,t+s+r},"");throw new l(`Path parameters result in path with invalid segments:\n${r.map(e=>e.error).join("\n")}\n${a}\n${t}`)}return a},Xc=Vc(Kc);class Yc extends Gc{list(e,t={},n){return this._client.getAPIList(Xc`/chat/completions/${e}/messages`,jc,{query:t,...n})}}function Qc(e){return"function"==typeof e.parse}const eu=e=>"assistant"===e?.role,tu=e=>"tool"===e?.role;var nu,su,ru,au,iu,ou,cu,uu,lu,du,pu,hu,mu,fu,gu,_u,yu,vu,wu,bu,xu;class Su{constructor(){nu.add(this),this.controller=new AbortController,su.set(this,void 0),ru.set(this,()=>{}),au.set(this,()=>{}),iu.set(this,void 0),ou.set(this,()=>{}),cu.set(this,()=>{}),uu.set(this,{}),lu.set(this,!1),du.set(this,!1),pu.set(this,!1),hu.set(this,!1),No(this,su,new Promise((e,t)=>{No(this,ru,e,"f"),No(this,au,t,"f")}),"f"),No(this,iu,new Promise((e,t)=>{No(this,ou,e,"f"),No(this,cu,t,"f")}),"f"),Po(this,su,"f").catch(()=>{}),Po(this,iu,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},Po(this,nu,"m",mu).bind(this))},0)}_connected(){this.ended||(Po(this,ru,"f").call(this),this._emit("connect"))}get ended(){return Po(this,lu,"f")}get errored(){return Po(this,du,"f")}get aborted(){return Po(this,pu,"f")}abort(){this.controller.abort()}on(e,t){return(Po(this,uu,"f")[e]||(Po(this,uu,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=Po(this,uu,"f")[e];if(!n)return this;const s=n.findIndex(e=>e.listener===t);return s>=0&&n.splice(s,1),this}once(e,t){return(Po(this,uu,"f")[e]||(Po(this,uu,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{No(this,hu,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)})}async done(){No(this,hu,!0,"f"),await Po(this,iu,"f")}_emit(e,...t){if(Po(this,lu,"f"))return;"end"===e&&(No(this,lu,!0,"f"),Po(this,ou,"f").call(this));const n=Po(this,uu,"f")[e];if(n&&(Po(this,uu,"f")[e]=n.filter(e=>!e.once),n.forEach(({listener:e})=>e(...t))),"abort"===e){const e=t[0];return Po(this,hu,"f")||n?.length||Promise.reject(e),Po(this,au,"f").call(this,e),Po(this,cu,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];Po(this,hu,"f")||n?.length||Promise.reject(e),Po(this,au,"f").call(this,e),Po(this,cu,"f").call(this,e),this._emit("end")}}_emitFinal(){}}su=new WeakMap,ru=new WeakMap,au=new WeakMap,iu=new WeakMap,ou=new WeakMap,cu=new WeakMap,uu=new WeakMap,lu=new WeakMap,du=new WeakMap,pu=new WeakMap,hu=new WeakMap,nu=new WeakSet,mu=function(e){if(No(this,du,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new p),e instanceof p)return No(this,pu,!0,"f"),this._emit("abort",e);if(e instanceof l)return this._emit("error",e);if(e instanceof Error){const t=new l(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new l(String(e)))};const ku=10;class Iu extends Su{constructor(){super(...arguments),fu.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),tu(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(eu(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionToolCall",t.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new l("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),Po(this,fu,"m",gu).call(this)}async finalMessage(){return await this.done(),Po(this,fu,"m",_u).call(this)}async finalFunctionToolCall(){return await this.done(),Po(this,fu,"m",yu).call(this)}async finalFunctionToolCallResult(){return await this.done(),Po(this,fu,"m",vu).call(this)}async totalUsage(){return await this.done(),Po(this,fu,"m",wu).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=Po(this,fu,"m",_u).call(this);t&&this._emit("finalMessage",t);const n=Po(this,fu,"m",gu).call(this);n&&this._emit("finalContent",n);const s=Po(this,fu,"m",yu).call(this);s&&this._emit("finalFunctionToolCall",s);const r=Po(this,fu,"m",vu).call(this);null!=r&&this._emit("finalFunctionToolCallResult",r),this._chatCompletions.some(e=>e.usage)&&this._emit("totalUsage",Po(this,fu,"m",wu).call(this))}async _createChatCompletion(e,t,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Po(this,fu,"m",bu).call(this,t);const r=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(C(r,t))}async _runChatCompletion(e,t,n){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,n)}async _runTools(e,t,n){const s="tool",{tool_choice:r="auto",stream:a,...i}=t,o="string"!=typeof r&&r?.function?.name,{maxChatCompletions:c=ku}=n||{},u=t.tools.map(e=>{if(A(e)){if(!e.$callback)throw new l("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e}),d={};for(const e of u)"function"===e.type&&(d[e.function.name||e.function.function.name]=e.function);const p="tools"in t?u.map(e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<c;++t){const t=await this._createChatCompletion(e,{...i,tool_choice:r,tools:p,messages:[...this.messages]},n),a=t.choices[0]?.message;if(!a)throw new l("missing message in ChatCompletion response");if(!a.tool_calls?.length)return;for(const e of a.tool_calls){if("function"!==e.type)continue;const t=e.id,{name:n,arguments:r}=e.function,a=d[n];if(!a){const e=`Invalid tool_call: ${JSON.stringify(n)}. Available options are: ${Object.keys(d).map(e=>JSON.stringify(e)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:t,content:e});continue}if(o&&o!==n){const e=`Invalid tool_call: ${JSON.stringify(n)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:s,tool_call_id:t,content:e});continue}let i;try{i=Qc(a)?await a.parse(r):r}catch(e){const n=e instanceof Error?e.message:String(e);this._addMessage({role:s,tool_call_id:t,content:n});continue}const c=await a.function(i,this),u=Po(this,fu,"m",xu).call(this,c);if(this._addMessage({role:s,tool_call_id:t,content:u}),o)return}}}}fu=new WeakSet,gu=function(){return Po(this,fu,"m",_u).call(this).content??null},_u=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(eu(t))return{...t,content:t.content??null,refusal:t.refusal??null}}throw new l("stream ended without producing a ChatCompletionMessage with role=assistant")},yu=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(eu(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},vu=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(tu(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some(e=>"assistant"===e.role&&e.tool_calls?.some(e=>"function"===e.type&&e.id===t.tool_call_id)))return t.content}},wu=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},bu=function(e){if(null!=e.n&&e.n>1)throw new l("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},xu=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class Tu extends Iu{static runTools(e,t,n){const s=new Tu,r={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,r)),s}_addMessage(e,t=!0){super._addMessage(e,t),eu(e)&&e.content&&this._emit("content",e.content)}}class Au extends Error{}class Cu extends Error{}const Ou=e=>function(e,t=511){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return((e,t)=>{const n=e.length;let s=0;const r=e=>{throw new Au(`${e} at position ${s}`)},a=e=>{throw new Cu(`${e} at position ${s}`)},i=()=>(d(),s>=n&&r("Unexpected end of input"),'"'===e[s]?o():"{"===e[s]?c():"["===e[s]?u():"null"===e.substring(s,s+4)||16&t&&n-s<4&&"null".startsWith(e.substring(s))?(s+=4,null):"true"===e.substring(s,s+4)||32&t&&n-s<4&&"true".startsWith(e.substring(s))?(s+=4,!0):"false"===e.substring(s,s+5)||32&t&&n-s<5&&"false".startsWith(e.substring(s))?(s+=5,!1):"Infinity"===e.substring(s,s+8)||128&t&&n-s<8&&"Infinity".startsWith(e.substring(s))?(s+=8,1/0):"-Infinity"===e.substring(s,s+9)||256&t&&1<n-s&&n-s<9&&"-Infinity".startsWith(e.substring(s))?(s+=9,-1/0):"NaN"===e.substring(s,s+3)||64&t&&n-s<3&&"NaN".startsWith(e.substring(s))?(s+=3,NaN):l()),o=()=>{const i=s;let o=!1;for(s++;s<n&&('"'!==e[s]||o&&"\\"===e[s-1]);)o="\\"===e[s]&&!o,s++;if('"'==e.charAt(s))try{return JSON.parse(e.substring(i,++s-Number(o)))}catch(e){a(String(e))}else if(1&t)try{return JSON.parse(e.substring(i,s-Number(o))+'"')}catch(t){return JSON.parse(e.substring(i,e.lastIndexOf("\\"))+'"')}r("Unterminated string literal")},c=()=>{s++,d();const a={};try{for(;"}"!==e[s];){if(d(),s>=n&&8&t)return a;const r=o();d(),s++;try{const e=i();Object.defineProperty(a,r,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(8&t)return a;throw e}d(),","===e[s]&&s++}}catch(e){if(8&t)return a;r("Expected '}' at end of object")}return s++,a},u=()=>{s++;const n=[];try{for(;"]"!==e[s];)n.push(i()),d(),","===e[s]&&s++}catch(e){if(4&t)return n;r("Expected ']' at end of array")}return s++,n},l=()=>{if(0===s){"-"===e&&2&t&&r("Not sure what '-' is");try{return JSON.parse(e)}catch(n){if(2&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}a(String(n))}}const i=s;for("-"===e[s]&&s++;e[s]&&!",]}".includes(e[s]);)s++;s!=n||2&t||r("Unterminated number literal");try{return JSON.parse(e.substring(i,s))}catch(n){"-"===e.substring(i,s)&&2&t&&r("Not sure what '-' is");try{return JSON.parse(e.substring(i,e.lastIndexOf("e")))}catch(e){a(String(e))}}},d=()=>{for(;s<n&&" \n\r\t".includes(e[s]);)s++};return i()})(e.trim(),t)}(e,509);var Ru,Eu,Nu,Pu,$u,Du,ju,Mu,Zu,Lu,Fu,qu;class Uu extends Iu{constructor(e){super(),Ru.add(this),Eu.set(this,void 0),Nu.set(this,void 0),Pu.set(this,void 0),No(this,Eu,e,"f"),No(this,Nu,[],"f")}get currentChatCompletionSnapshot(){return Po(this,Pu,"f")}static fromReadableStream(e){const t=new Uu(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,n){const s=new Uu(t);return s._run(()=>s._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,t,n){super._createChatCompletion;const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Po(this,Ru,"m",$u).call(this);const r=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of r)Po(this,Ru,"m",ju).call(this,e);if(r.controller.signal?.aborted)throw new p;return this._addChatCompletion(Po(this,Ru,"m",Lu).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),Po(this,Ru,"m",$u).call(this),this._connected();const s=Cc.fromReadableStream(e,this.controller);let r;for await(const e of s)r&&r!==e.id&&this._addChatCompletion(Po(this,Ru,"m",Lu).call(this)),Po(this,Ru,"m",ju).call(this,e),r=e.id;if(s.controller.signal?.aborted)throw new p;return this._addChatCompletion(Po(this,Ru,"m",Lu).call(this))}[(Eu=new WeakMap,Nu=new WeakMap,Pu=new WeakMap,Ru=new WeakSet,$u=function(){this.ended||No(this,Pu,void 0,"f")},Du=function(e){let t=Po(this,Nu,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},Po(this,Nu,"f")[e.index]=t,t)},ju=function(e){if(this.ended)return;const t=Po(this,Ru,"m",qu).call(this,e);this._emit("chunk",e,t);for(const n of e.choices){const e=t.choices[n.index];null!=n.delta.content&&"assistant"===e.message?.role&&e.message?.content&&(this._emit("content",n.delta.content,e.message.content),this._emit("content.delta",{delta:n.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=n.delta.refusal&&"assistant"===e.message?.role&&e.message?.refusal&&this._emit("refusal.delta",{delta:n.delta.refusal,snapshot:e.message.refusal}),null!=n.logprobs?.content&&"assistant"===e.message?.role&&this._emit("logprobs.content.delta",{content:n.logprobs?.content,snapshot:e.logprobs?.content??[]}),null!=n.logprobs?.refusal&&"assistant"===e.message?.role&&this._emit("logprobs.refusal.delta",{refusal:n.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});const s=Po(this,Ru,"m",Du).call(this,e);e.finish_reason&&(Po(this,Ru,"m",Zu).call(this,e),null!=s.current_tool_call_index&&Po(this,Ru,"m",Mu).call(this,e,s.current_tool_call_index));for(const t of n.delta.tool_calls??[])s.current_tool_call_index!==t.index&&(Po(this,Ru,"m",Zu).call(this,e),null!=s.current_tool_call_index&&Po(this,Ru,"m",Mu).call(this,e,s.current_tool_call_index)),s.current_tool_call_index=t.index;for(const t of n.delta.tool_calls??[]){const n=e.message.tool_calls?.[t.index];n?.type&&("function"===n?.type?this._emit("tool_calls.function.arguments.delta",{name:n.function?.name,index:t.index,arguments:n.function.arguments,parsed_arguments:n.function.parsed_arguments,arguments_delta:t.function?.arguments??""}):zu())}}},Mu=function(e,t){if(Po(this,Ru,"m",Du).call(this,e).done_tool_calls.has(t))return;const n=e.message.tool_calls?.[t];if(!n)throw new Error("no tool call snapshot");if(!n.type)throw new Error("tool call snapshot missing `type`");if("function"===n.type){const e=Po(this,Eu,"f")?.tools?.find(e=>"function"===e.type&&e.function.name===n.function.name);this._emit("tool_calls.function.arguments.done",{name:n.function.name,index:t,arguments:n.function.arguments,parsed_arguments:A(e)?e.$parseRaw(n.function.arguments):e?.function.strict?JSON.parse(n.function.arguments):null})}else n.type},Zu=function(e){const t=Po(this,Ru,"m",Du).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const n=Po(this,Ru,"m",Fu).call(this);this._emit("content.done",{content:e.message.content,parsed:n?n.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},Lu=function(){if(this.ended)throw new l("stream has ended, this shouldn't happen");const e=Po(this,Pu,"f");if(!e)throw new l("request ended without sending any chunks");return No(this,Pu,void 0,"f"),No(this,Nu,[],"f"),function(e,t){const{id:n,choices:s,created:r,model:a,system_fingerprint:i,...o}=e,c={...o,id:n,choices:s.map(({message:t,finish_reason:n,index:s,logprobs:r,...a})=>{if(!n)throw new l(`missing finish_reason for choice ${s}`);const{content:i=null,function_call:o,tool_calls:c,...u}=t,d=t.role;if(!d)throw new l(`missing role for choice ${s}`);if(o){const{arguments:e,name:c}=o;if(null==e)throw new l(`missing function_call.arguments for choice ${s}`);if(!c)throw new l(`missing function_call.name for choice ${s}`);return{...a,message:{content:i,function_call:{arguments:e,name:c},role:d,refusal:t.refusal??null},finish_reason:n,index:s,logprobs:r}}return c?{...a,index:s,finish_reason:n,logprobs:r,message:{...u,role:d,content:i,refusal:t.refusal??null,tool_calls:c.map((t,n)=>{const{function:r,type:a,id:i,...o}=t,{arguments:c,name:u,...d}=r||{};if(null==i)throw new l(`missing choices[${s}].tool_calls[${n}].id\n${Bu(e)}`);if(null==a)throw new l(`missing choices[${s}].tool_calls[${n}].type\n${Bu(e)}`);if(null==u)throw new l(`missing choices[${s}].tool_calls[${n}].function.name\n${Bu(e)}`);if(null==c)throw new l(`missing choices[${s}].tool_calls[${n}].function.arguments\n${Bu(e)}`);return{...o,id:i,type:a,function:{...d,name:u,arguments:c}}})}}:{...a,message:{...u,content:i,role:d,refusal:t.refusal??null},finish_reason:n,index:s,logprobs:r}}),created:r,model:a,object:"chat.completion",...i?{system_fingerprint:i}:{}};return function(e,t){return t&&E(t)?C(e,t):{...e,choices:e.choices.map(e=>({...e,message:{...e.message,parsed:null,...e.message.tool_calls?{tool_calls:e.message.tool_calls}:void 0}}))}}(c,t)}(e,Po(this,Eu,"f"))},Fu=function(){const e=Po(this,Eu,"f")?.response_format;return T(e)?e:null},qu=function(e){var t,n,s,r;let a=Po(this,Pu,"f");const{choices:i,...o}=e;a?Object.assign(a,o):a=No(this,Pu,{...o,choices:[]},"f");for(const{delta:i,finish_reason:o,index:c,logprobs:u=null,...l}of e.choices){let e=a.choices[c];if(e||(e=a.choices[c]={finish_reason:o,index:c,message:{},logprobs:u,...l}),u)if(e.logprobs){const{content:s,refusal:r,...a}=u;Ju(),Object.assign(e.logprobs,a),s&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...s)),r&&((n=e.logprobs).refusal??(n.refusal=[]),e.logprobs.refusal.push(...r))}else e.logprobs=Object.assign({},u);if(o&&(e.finish_reason=o,Po(this,Eu,"f")&&E(Po(this,Eu,"f")))){if("length"===o)throw new S;if("content_filter"===o)throw new k}if(Object.assign(e,l),!i)continue;const{content:d,refusal:p,function_call:h,role:m,tool_calls:f,...g}=i;if(Ju(),Object.assign(e.message,g),p&&(e.message.refusal=(e.message.refusal||"")+p),m&&(e.message.role=m),h&&(e.message.function_call?(h.name&&(e.message.function_call.name=h.name),h.arguments&&((s=e.message.function_call).arguments??(s.arguments=""),e.message.function_call.arguments+=h.arguments)):e.message.function_call=h),d&&(e.message.content=(e.message.content||"")+d,!e.message.refusal&&Po(this,Ru,"m",Fu).call(this)&&(e.message.parsed=Ou(e.message.content))),f){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:n,type:s,function:a,...i}of f){const o=(r=e.message.tool_calls)[t]??(r[t]={});Object.assign(o,i),n&&(o.id=n),s&&(o.type=s),a&&(o.function??(o.function={name:a.name??"",arguments:""})),a?.name&&(o.function.name=a.name),a?.arguments&&(o.function.arguments+=a.arguments,R(Po(this,Eu,"f"),o)&&(o.function.parsed_arguments=Ou(o.function.arguments)))}}}return a},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",n=>{const s=t.shift();s?s.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Cc(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Bu(e){return JSON.stringify(e)}function Ju(e){}function zu(e){}class Wu extends Uu{static fromReadableStream(e){const t=new Wu(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,n){const s=new Wu(t),r={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,r)),s}}class Gu extends Gc{constructor(){super(...arguments),this.messages=new Yc(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(Xc`/chat/completions/${e}`,t)}update(e,t,n){return this._client.post(Xc`/chat/completions/${e}`,{body:t,...n})}list(e={},t){return this._client.getAPIList("/chat/completions",jc,{query:e,...t})}delete(e,t){return this._client.delete(Xc`/chat/completions/${e}`,t)}parse(e,t){return function(e){for(const t of e??[]){if("function"!==t.type)throw new l(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new l(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(t=>C(t,e))}runTools(e,t){return e.stream?Wu.runTools(this._client,e,t):Tu.runTools(this._client,e,t)}stream(e,t){return Uu.createChatCompletion(this._client,e,t)}}Gu.Messages=Yc;class Ku extends Gc{constructor(){super(...arguments),this.completions=new Gu(this._client)}}Ku.Completions=Gu;const Hu=Symbol("brand.privateNullableHeaders");function*Vu(e){if(!e)return;if(Hu in e){const{values:t,nulls:n}=e;yield*t.entries();for(const e of n)yield[e,null];return}let t,n=!1;e instanceof Headers?t=e.entries():Mo(e)?t=e:(n=!0,t=Object.entries(e??{}));for(let e of t){const t=e[0];if("string"!=typeof t)throw new TypeError("expected header name to be a string");const s=Mo(e[1])?e[1]:[e[1]];let r=!1;for(const e of s)void 0!==e&&(n&&!r&&(r=!0,yield[t,null]),yield[t,e])}}const Xu=e=>{const t=new Headers,n=new Set;for(const s of e){const e=new Set;for(const[r,a]of Vu(s)){const s=r.toLowerCase();e.has(s)||(t.delete(r),e.add(s)),null===a?(t.delete(r),n.add(s)):(t.append(r,a),n.delete(s))}}return{[Hu]:!0,values:t,nulls:n}};class Yu extends Gc{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:Xu([{Accept:"application/octet-stream"},t?.headers]),__binaryResponse:!0})}}class Qu extends Gc{create(e,t){return this._client.post("/audio/transcriptions",qc({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}}class el extends Gc{create(e,t){return this._client.post("/audio/translations",qc({body:e,...t,__metadata:{model:e.model}},this._client))}}class tl extends Gc{constructor(){super(...arguments),this.transcriptions=new Qu(this._client),this.translations=new el(this._client),this.speech=new Yu(this._client)}}tl.Transcriptions=Qu,tl.Translations=el,tl.Speech=Yu;class nl extends Gc{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(Xc`/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/batches",jc,{query:e,...t})}cancel(e,t){return this._client.post(Xc`/batches/${e}/cancel`,t)}}class sl extends Gc{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:Xu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(Xc`/assistants/${e}`,{...t,headers:Xu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,n){return this._client.post(Xc`/assistants/${e}`,{body:t,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e={},t){return this._client.getAPIList("/assistants",jc,{query:e,...t,headers:Xu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(Xc`/assistants/${e}`,{...t,headers:Xu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class rl extends Gc{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:Xu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class al extends Gc{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:Xu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class il extends Gc{constructor(){super(...arguments),this.sessions=new rl(this._client),this.transcriptionSessions=new al(this._client)}}il.Sessions=rl,il.TranscriptionSessions=al;class ol extends Gc{create(e,t,n){return this._client.post(Xc`/threads/${e}/messages`,{body:t,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(e,t,n){const{thread_id:s}=t;return this._client.get(Xc`/threads/${s}/messages/${e}`,{...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(e,t,n){const{thread_id:s,...r}=t;return this._client.post(Xc`/threads/${s}/messages/${e}`,{body:r,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e,t={},n){return this._client.getAPIList(Xc`/threads/${e}/messages`,jc,{query:t,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}delete(e,t,n){const{thread_id:s}=t;return this._client.delete(Xc`/threads/${s}/messages/${e}`,{...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}class cl extends Gc{retrieve(e,t,n){const{thread_id:s,run_id:r,...a}=t;return this._client.get(Xc`/threads/${s}/runs/${r}/steps/${e}`,{query:a,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e,t,n){const{thread_id:s,...r}=t;return this._client.getAPIList(Xc`/threads/${s}/runs/${e}/steps`,jc,{query:r,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}const ul=e=>void 0!==globalThis.process?globalThis.process.env?.[e]?.trim()??void 0:void 0!==globalThis.Deno?globalThis.Deno.env?.get?.(e)?.trim():void 0;var ll,dl,pl,hl,ml,fl,gl,_l,yl,vl,wl,bl,xl,Sl,kl,Il,Tl,Al,Cl,Ol,Rl,El,Nl,Pl,$l,Dl,jl,Ml,Zl,Ll,Fl,ql,Ul,Bl,Jl,zl,Wl,Gl;class Kl extends Su{constructor(){super(...arguments),ll.add(this),pl.set(this,[]),hl.set(this,{}),ml.set(this,{}),fl.set(this,void 0),gl.set(this,void 0),_l.set(this,void 0),yl.set(this,void 0),vl.set(this,void 0),wl.set(this,void 0),bl.set(this,void 0),xl.set(this,void 0),Sl.set(this,void 0)}[(pl=new WeakMap,hl=new WeakMap,ml=new WeakMap,fl=new WeakMap,gl=new WeakMap,_l=new WeakMap,yl=new WeakMap,vl=new WeakMap,wl=new WeakMap,bl=new WeakMap,xl=new WeakMap,Sl=new WeakMap,ll=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",n=>{const s=t.shift();s?s.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new dl;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();const s=Cc.fromReadableStream(e,this.controller);for await(const e of s)Po(this,ll,"m",kl).call(this,e);if(s.controller.signal?.aborted)throw new p;return this._addRun(Po(this,ll,"m",Il).call(this))}toReadableStream(){return new Cc(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,s){const r=new dl;return r._run(()=>r._runToolAssistantStream(e,t,n,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createToolAssistantStream(e,t,n,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},i=await e.submitToolOutputs(t,a,{...s,signal:this.controller.signal});this._connected();for await(const e of i)Po(this,ll,"m",kl).call(this,e);if(i.controller.signal?.aborted)throw new p;return this._addRun(Po(this,ll,"m",Il).call(this))}static createThreadAssistantStream(e,t,n){const s=new dl;return s._run(()=>s._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,t,n,s){const r=new dl;return r._run(()=>r._runAssistantStream(e,t,n,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}currentEvent(){return Po(this,bl,"f")}currentRun(){return Po(this,xl,"f")}currentMessageSnapshot(){return Po(this,fl,"f")}currentRunStepSnapshot(){return Po(this,Sl,"f")}async finalRunSteps(){return await this.done(),Object.values(Po(this,hl,"f"))}async finalMessages(){return await this.done(),Object.values(Po(this,ml,"f"))}async finalRun(){if(await this.done(),!Po(this,gl,"f"))throw Error("Final run was not received.");return Po(this,gl,"f")}async _createThreadAssistantStream(e,t,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const r={...t,stream:!0},a=await e.createAndRun(r,{...n,signal:this.controller.signal});this._connected();for await(const e of a)Po(this,ll,"m",kl).call(this,e);if(a.controller.signal?.aborted)throw new p;return this._addRun(Po(this,ll,"m",Il).call(this))}async _createAssistantStream(e,t,n,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},i=await e.create(t,a,{...s,signal:this.controller.signal});this._connected();for await(const e of i)Po(this,ll,"m",kl).call(this,e);if(i.controller.signal?.aborted)throw new p;return this._addRun(Po(this,ll,"m",Il).call(this))}static accumulateDelta(e,t){for(const[n,s]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=s;continue}let t=e[n];if(null!=t)if("index"!==n&&"type"!==n){if("string"==typeof t&&"string"==typeof s)t+=s;else if("number"==typeof t&&"number"==typeof s)t+=s;else{if(!Zo(t)||!Zo(s)){if(Array.isArray(t)&&Array.isArray(s)){if(t.every(e=>"string"==typeof e||"number"==typeof e)){t.push(...s);continue}for(const e of s){if(!Zo(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const n=e.index;if(null==n)throw console.error(e),new Error("Expected array delta entry to have an `index` property");if("number"!=typeof n)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${n}`);const s=t[n];null==s?t.push(e):t[n]=this.accumulateDelta(s,e)}continue}throw Error(`Unhandled record type: ${n}, deltaValue: ${s}, accValue: ${t}`)}t=this.accumulateDelta(t,s)}e[n]=t}else e[n]=s;else e[n]=s}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,s){return await this._createAssistantStream(t,e,n,s)}async _runToolAssistantStream(e,t,n,s){return await this._createToolAssistantStream(t,e,n,s)}}dl=Kl,kl=function(e){if(!this.ended)switch(No(this,bl,e,"f"),Po(this,ll,"m",Cl).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":Po(this,ll,"m",Nl).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Po(this,ll,"m",Al).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":Po(this,ll,"m",Tl).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Il=function(){if(this.ended)throw new l("stream has ended, this shouldn't happen");if(!Po(this,gl,"f"))throw Error("Final run has not been received");return Po(this,gl,"f")},Tl=function(e){const[t,n]=Po(this,ll,"m",Rl).call(this,e,Po(this,fl,"f"));No(this,fl,t,"f"),Po(this,ml,"f")[t.id]=t;for(const e of n){const n=t.content[e.index];"text"==n?.type&&this._emit("textCreated",n.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const n of e.data.delta.content){if("text"==n.type&&n.text){let e=n.text,s=t.content[n.index];if(!s||"text"!=s.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,s.text)}if(n.index!=Po(this,_l,"f")){if(Po(this,yl,"f"))switch(Po(this,yl,"f").type){case"text":this._emit("textDone",Po(this,yl,"f").text,Po(this,fl,"f"));break;case"image_file":this._emit("imageFileDone",Po(this,yl,"f").image_file,Po(this,fl,"f"))}No(this,_l,n.index,"f")}No(this,yl,t.content[n.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==Po(this,_l,"f")){const t=e.data.content[Po(this,_l,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,Po(this,fl,"f"));break;case"text":this._emit("textDone",t.text,Po(this,fl,"f"))}}Po(this,fl,"f")&&this._emit("messageDone",e.data),No(this,fl,void 0,"f")}},Al=function(e){const t=Po(this,ll,"m",Ol).call(this,e);switch(No(this,Sl,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&"tool_calls"==n.step_details.type&&n.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of n.step_details.tool_calls)e.index==Po(this,vl,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(Po(this,wl,"f")&&this._emit("toolCallDone",Po(this,wl,"f")),No(this,vl,e.index,"f"),No(this,wl,t.step_details.tool_calls[e.index],"f"),Po(this,wl,"f")&&this._emit("toolCallCreated",Po(this,wl,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":No(this,Sl,void 0,"f"),"tool_calls"==e.data.step_details.type&&Po(this,wl,"f")&&(this._emit("toolCallDone",Po(this,wl,"f")),No(this,wl,void 0,"f")),this._emit("runStepDone",e.data,t)}},Cl=function(e){Po(this,pl,"f").push(e),this._emit("event",e)},Ol=function(e){switch(e.event){case"thread.run.step.created":return Po(this,hl,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=Po(this,hl,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const s=dl.accumulateDelta(t,n.delta);Po(this,hl,"f")[e.data.id]=s}return Po(this,hl,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":Po(this,hl,"f")[e.data.id]=e.data}if(Po(this,hl,"f")[e.data.id])return Po(this,hl,"f")[e.data.id];throw new Error("No snapshot available")},Rl=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(const e of s.delta.content)if(e.index in t.content){let n=t.content[e.index];t.content[e.index]=Po(this,ll,"m",El).call(this,e,n)}else t.content[e.index]=e,n.push(e);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},El=function(e,t){return dl.accumulateDelta(t,e)},Nl=function(e){switch(No(this,xl,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.cancelling":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":No(this,gl,e.data,"f"),Po(this,wl,"f")&&(this._emit("toolCallDone",Po(this,wl,"f")),No(this,wl,void 0,"f"))}};class Hl extends Gc{constructor(){super(...arguments),this.steps=new cl(this._client)}create(e,t,n){const{include:s,...r}=t;return this._client.post(Xc`/threads/${e}/runs`,{query:{include:s},body:r,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers]),stream:t.stream??!1})}retrieve(e,t,n){const{thread_id:s}=t;return this._client.get(Xc`/threads/${s}/runs/${e}`,{...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(e,t,n){const{thread_id:s,...r}=t;return this._client.post(Xc`/threads/${s}/runs/${e}`,{body:r,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e,t={},n){return this._client.getAPIList(Xc`/threads/${e}/runs`,jc,{query:t,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}cancel(e,t,n){const{thread_id:s}=t;return this._client.post(Xc`/threads/${s}/runs/${e}/cancel`,{...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}async createAndPoll(e,t,n){const s=await this.create(e,t,n);return await this.poll(s.id,{thread_id:e},n)}createAndStream(e,t,n){return Kl.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const s=Xu([n?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":n?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:r,response:a}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...s}}).withResponse();switch(r.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=a.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Lo(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return r}}}stream(e,t,n){return Kl.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n){const{thread_id:s,...r}=t;return this._client.post(Xc`/threads/${s}/runs/${e}/submit_tool_outputs`,{body:r,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers]),stream:t.stream??!1})}async submitToolOutputsAndPoll(e,t,n){const s=await this.submitToolOutputs(e,t,n);return await this.poll(s.id,t,n)}submitToolOutputsStream(e,t,n){return Kl.createToolAssistantStream(e,this._client.beta.threads.runs,t,n)}}Hl.Steps=cl;class Vl extends Gc{constructor(){super(...arguments),this.runs=new Hl(this._client),this.messages=new ol(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:Xu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(Xc`/threads/${e}`,{...t,headers:Xu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,n){return this._client.post(Xc`/threads/${e}`,{body:t,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}delete(e,t){return this._client.delete(Xc`/threads/${e}`,{...t,headers:Xu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:Xu([{"OpenAI-Beta":"assistants=v2"},t?.headers]),stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.id,{thread_id:n.thread_id},t)}createAndRunStream(e,t){return Kl.createThreadAssistantStream(e,this._client.beta.threads,t)}}Vl.Runs=Hl,Vl.Messages=ol;class Xl extends Gc{constructor(){super(...arguments),this.realtime=new il(this._client),this.assistants=new sl(this._client),this.threads=new Vl(this._client)}}Xl.Realtime=il,Xl.Assistants=sl,Xl.Threads=Vl;class Yl extends Gc{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class Ql extends Gc{retrieve(e,t,n){const{container_id:s}=t;return this._client.get(Xc`/containers/${s}/files/${e}/content`,{...n,headers:Xu([{Accept:"application/binary"},n?.headers]),__binaryResponse:!0})}}class ed extends Gc{constructor(){super(...arguments),this.content=new Ql(this._client)}create(e,t,n){return this._client.post(Xc`/containers/${e}/files`,qc({body:t,...n},this._client))}retrieve(e,t,n){const{container_id:s}=t;return this._client.get(Xc`/containers/${s}/files/${e}`,n)}list(e,t={},n){return this._client.getAPIList(Xc`/containers/${e}/files`,jc,{query:t,...n})}delete(e,t,n){const{container_id:s}=t;return this._client.delete(Xc`/containers/${s}/files/${e}`,{...n,headers:Xu([{Accept:"*/*"},n?.headers])})}}ed.Content=Ql;class td extends Gc{constructor(){super(...arguments),this.files=new ed(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(Xc`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",jc,{query:e,...t})}delete(e,t){return this._client.delete(Xc`/containers/${e}`,{...t,headers:Xu([{Accept:"*/*"},t?.headers])})}}td.Files=ed;class nd extends Gc{create(e,t){const n=!!e.encoding_format;let s=n?e.encoding_format:"base64";n&&Sc(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);const r=this._client.post("/embeddings",{body:{...e,encoding_format:s},...t});return n?r:(Sc(this._client).debug("embeddings/decoding base64 embeddings from base64"),r._thenUnwrap(e=>(e&&e.data&&e.data.forEach(e=>{const t=e.embedding;e.embedding=(e=>{if("undefined"!=typeof Buffer){const t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}{const t=atob(e),n=t.length,s=new Uint8Array(n);for(let e=0;e<n;e++)s[e]=t.charCodeAt(e);return Array.from(new Float32Array(s.buffer))}})(t)}),e)))}}class sd extends Gc{retrieve(e,t,n){const{eval_id:s,run_id:r}=t;return this._client.get(Xc`/evals/${s}/runs/${r}/output_items/${e}`,n)}list(e,t,n){const{eval_id:s,...r}=t;return this._client.getAPIList(Xc`/evals/${s}/runs/${e}/output_items`,jc,{query:r,...n})}}class rd extends Gc{constructor(){super(...arguments),this.outputItems=new sd(this._client)}create(e,t,n){return this._client.post(Xc`/evals/${e}/runs`,{body:t,...n})}retrieve(e,t,n){const{eval_id:s}=t;return this._client.get(Xc`/evals/${s}/runs/${e}`,n)}list(e,t={},n){return this._client.getAPIList(Xc`/evals/${e}/runs`,jc,{query:t,...n})}delete(e,t,n){const{eval_id:s}=t;return this._client.delete(Xc`/evals/${s}/runs/${e}`,n)}cancel(e,t,n){const{eval_id:s}=t;return this._client.post(Xc`/evals/${s}/runs/${e}`,n)}}rd.OutputItems=sd;class ad extends Gc{constructor(){super(...arguments),this.runs=new rd(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(Xc`/evals/${e}`,t)}update(e,t,n){return this._client.post(Xc`/evals/${e}`,{body:t,...n})}list(e={},t){return this._client.getAPIList("/evals",jc,{query:e,...t})}delete(e,t){return this._client.delete(Xc`/evals/${e}`,t)}}ad.Runs=rd;class id extends Gc{create(e,t){return this._client.post("/files",qc({body:e,...t},this._client))}retrieve(e,t){return this._client.get(Xc`/files/${e}`,t)}list(e={},t){return this._client.getAPIList("/files",jc,{query:e,...t})}delete(e,t){return this._client.delete(Xc`/files/${e}`,t)}content(e,t){return this._client.get(Xc`/files/${e}/content`,{...t,headers:Xu([{Accept:"application/binary"},t?.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=18e5}={}){const s=new Set(["processed","error","deleted"]),r=Date.now();let a=await this.retrieve(e);for(;!a.status||!s.has(a.status);)if(await Lo(t),a=await this.retrieve(e),Date.now()-r>n)throw new m({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return a}}class od extends Gc{}class cd extends Gc{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}}class ud extends Gc{constructor(){super(...arguments),this.graders=new cd(this._client)}}ud.Graders=cd;class ld extends Gc{create(e,t,n){return this._client.getAPIList(Xc`/fine_tuning/checkpoints/${e}/permissions`,Dc,{body:t,method:"post",...n})}retrieve(e,t={},n){return this._client.get(Xc`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...n})}delete(e,t,n){const{fine_tuned_model_checkpoint:s}=t;return this._client.delete(Xc`/fine_tuning/checkpoints/${s}/permissions/${e}`,n)}}class dd extends Gc{constructor(){super(...arguments),this.permissions=new ld(this._client)}}dd.Permissions=ld;class pd extends Gc{list(e,t={},n){return this._client.getAPIList(Xc`/fine_tuning/jobs/${e}/checkpoints`,jc,{query:t,...n})}}class hd extends Gc{constructor(){super(...arguments),this.checkpoints=new pd(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(Xc`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",jc,{query:e,...t})}cancel(e,t){return this._client.post(Xc`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return this._client.getAPIList(Xc`/fine_tuning/jobs/${e}/events`,jc,{query:t,...n})}pause(e,t){return this._client.post(Xc`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(Xc`/fine_tuning/jobs/${e}/resume`,t)}}hd.Checkpoints=pd;class md extends Gc{constructor(){super(...arguments),this.methods=new od(this._client),this.jobs=new hd(this._client),this.checkpoints=new dd(this._client),this.alpha=new ud(this._client)}}md.Methods=od,md.Jobs=hd,md.Checkpoints=dd,md.Alpha=ud;class fd extends Gc{}class gd extends Gc{constructor(){super(...arguments),this.graderModels=new fd(this._client)}}gd.GraderModels=fd;class _d extends Gc{createVariation(e,t){return this._client.post("/images/variations",qc({body:e,...t},this._client))}edit(e,t){return this._client.post("/images/edits",qc({body:e,...t,stream:e.stream??!1},this._client))}generate(e,t){return this._client.post("/images/generations",{body:e,...t,stream:e.stream??!1})}}class yd extends Gc{retrieve(e,t){return this._client.get(Xc`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Dc,e)}delete(e,t){return this._client.delete(Xc`/models/${e}`,t)}}class vd extends Gc{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class wd extends Su{constructor(e){super(),Pl.add(this),$l.set(this,void 0),Dl.set(this,void 0),jl.set(this,void 0),No(this,$l,e,"f")}static createResponse(e,t,n){const s=new wd(t);return s._run(()=>s._createOrRetrieveResponse(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createOrRetrieveResponse(e,t,n){const s=n?.signal;let r;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Po(this,Pl,"m",Ml).call(this);let a=null;"response_id"in t?(r=await e.responses.retrieve(t.response_id,{stream:!0},{...n,signal:this.controller.signal,stream:!0}),a=t.starting_after??null):r=await e.responses.create({...t,stream:!0},{...n,signal:this.controller.signal}),this._connected();for await(const e of r)Po(this,Pl,"m",Zl).call(this,e,a);if(r.controller.signal?.aborted)throw new p;return Po(this,Pl,"m",Ll).call(this)}[($l=new WeakMap,Dl=new WeakMap,jl=new WeakMap,Pl=new WeakSet,Ml=function(){this.ended||No(this,Dl,void 0,"f")},Zl=function(e,t){if(this.ended)return;const n=(e,n)=>{(null==t||n.sequence_number>t)&&this._emit(e,n)},s=Po(this,Pl,"m",Fl).call(this,e);switch(n("event",e),e.type){case"response.output_text.delta":{const t=s.output[e.output_index];if(!t)throw new l(`missing output at index ${e.output_index}`);if("message"===t.type){const s=t.content[e.content_index];if(!s)throw new l(`missing content at index ${e.content_index}`);if("output_text"!==s.type)throw new l(`expected content to be 'output_text', got ${s.type}`);n("response.output_text.delta",{...e,snapshot:s.text})}break}case"response.function_call_arguments.delta":{const t=s.output[e.output_index];if(!t)throw new l(`missing output at index ${e.output_index}`);"function_call"===t.type&&n("response.function_call_arguments.delta",{...e,snapshot:t.arguments});break}default:n(e.type,e)}},Ll=function(){if(this.ended)throw new l("stream has ended, this shouldn't happen");const e=Po(this,Dl,"f");if(!e)throw new l("request ended without sending any events");No(this,Dl,void 0,"f");const t=function(e,t){return function(e,t){return t&&function(e){return!!T(e.text?.format)}(t)?Mt(e,t):{...e,output_parsed:null,output:e.output.map(e=>"function_call"===e.type?{...e,parsed_arguments:null}:"message"===e.type?{...e,content:e.content.map(e=>({...e,parsed:null}))}:e)}}(e,t)}(e,Po(this,$l,"f"));return No(this,jl,t,"f"),t},Fl=function(e){let t=Po(this,Dl,"f");if(!t){if("response.created"!==e.type)throw new l(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return t=No(this,Dl,e.response,"f"),t}switch(e.type){case"response.output_item.added":t.output.push(e.item);break;case"response.content_part.added":{const n=t.output[e.output_index];if(!n)throw new l(`missing output at index ${e.output_index}`);"message"===n.type&&n.content.push(e.part);break}case"response.output_text.delta":{const n=t.output[e.output_index];if(!n)throw new l(`missing output at index ${e.output_index}`);if("message"===n.type){const t=n.content[e.content_index];if(!t)throw new l(`missing content at index ${e.content_index}`);if("output_text"!==t.type)throw new l(`expected content to be 'output_text', got ${t.type}`);t.text+=e.delta}break}case"response.function_call_arguments.delta":{const n=t.output[e.output_index];if(!n)throw new l(`missing output at index ${e.output_index}`);"function_call"===n.type&&(n.arguments+=e.delta);break}case"response.completed":No(this,Dl,e.response,"f")}return t},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",n=>{const s=t.shift();s?s.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=Po(this,jl,"f");if(!e)throw new l("stream ended without producing a ChatCompletion");return e}}class bd extends Gc{list(e,t={},n){return this._client.getAPIList(Xc`/responses/${e}/input_items`,jc,{query:t,...n})}}class xd extends Gc{constructor(){super(...arguments),this.inputItems=new bd(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&qt(e),e))}retrieve(e,t={},n){return this._client.get(Xc`/responses/${e}`,{query:t,...n,stream:t?.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&qt(e),e))}delete(e,t){return this._client.delete(Xc`/responses/${e}`,{...t,headers:Xu([{Accept:"*/*"},t?.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(t=>Mt(t,e))}stream(e,t){return wd.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(Xc`/responses/${e}/cancel`,t)}}xd.InputItems=bd;class Sd extends Gc{create(e,t,n){return this._client.post(Xc`/uploads/${e}/parts`,qc({body:t,...n},this._client))}}class kd extends Gc{constructor(){super(...arguments),this.parts=new Sd(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(Xc`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(Xc`/uploads/${e}/complete`,{body:t,...n})}}kd.Parts=Sd;class Id extends Gc{create(e,t,n){return this._client.post(Xc`/vector_stores/${e}/file_batches`,{body:t,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(e,t,n){const{vector_store_id:s}=t;return this._client.get(Xc`/vector_stores/${s}/file_batches/${e}`,{...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}cancel(e,t,n){const{vector_store_id:s}=t;return this._client.post(Xc`/vector_stores/${s}/file_batches/${e}/cancel`,{...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}async createAndPoll(e,t,n){const s=await this.create(e,t);return await this.poll(e,s.id,n)}listFiles(e,t,n){const{vector_store_id:s,...r}=t;return this._client.getAPIList(Xc`/vector_stores/${s}/file_batches/${e}/files`,jc,{query:r,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}async poll(e,t,n){const s=Xu([n?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":n?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:r,response:a}=await this.retrieve(t,{vector_store_id:e},{...n,headers:s}).withResponse();switch(r.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=a.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Lo(e);break;case"failed":case"cancelled":case"completed":return r}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},s){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const r=s?.maxConcurrency??5,a=Math.min(r,t.length),i=this._client,o=t.values(),c=[...n],u=Array(a).fill(o).map(async function(e){for(let t of e){const e=await i.files.create({file:t,purpose:"assistants"},s);c.push(e.id)}});return await(async e=>{const t=await Promise.allSettled(e),n=t.filter(e=>"rejected"===e.status);if(n.length){for(const e of n)console.error(e.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const s=[];for(const e of t)"fulfilled"===e.status&&s.push(e.value);return s})(u),await this.createAndPoll(e,{file_ids:c})}}class Td extends Gc{create(e,t,n){return this._client.post(Xc`/vector_stores/${e}/files`,{body:t,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(e,t,n){const{vector_store_id:s}=t;return this._client.get(Xc`/vector_stores/${s}/files/${e}`,{...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(e,t,n){const{vector_store_id:s,...r}=t;return this._client.post(Xc`/vector_stores/${s}/files/${e}`,{body:r,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e,t={},n){return this._client.getAPIList(Xc`/vector_stores/${e}/files`,jc,{query:t,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}delete(e,t,n){const{vector_store_id:s}=t;return this._client.delete(Xc`/vector_stores/${s}/files/${e}`,{...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}async createAndPoll(e,t,n){const s=await this.create(e,t,n);return await this.poll(e,s.id,n)}async poll(e,t,n){const s=Xu([n?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":n?.pollIntervalMs?.toString()??void 0}]);for(;;){const r=await this.retrieve(t,{vector_store_id:e},{...n,headers:s}).withResponse(),a=r.data;switch(a.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=r.response.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Lo(e);break;case"failed":case"completed":return a}}}async upload(e,t,n){const s=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:s.id},n)}async uploadAndPoll(e,t,n){const s=await this.upload(e,t,n);return await this.poll(e,s.id,n)}content(e,t,n){const{vector_store_id:s}=t;return this._client.getAPIList(Xc`/vector_stores/${s}/files/${e}/content`,Dc,{...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}class Ad extends Gc{constructor(){super(...arguments),this.files=new Td(this._client),this.fileBatches=new Id(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:Xu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(Xc`/vector_stores/${e}`,{...t,headers:Xu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,n){return this._client.post(Xc`/vector_stores/${e}`,{body:t,...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",jc,{query:e,...t,headers:Xu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(Xc`/vector_stores/${e}`,{...t,headers:Xu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}search(e,t,n){return this._client.getAPIList(Xc`/vector_stores/${e}/search`,Dc,{body:t,method:"post",...n,headers:Xu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}Ad.Files=Td,Ad.FileBatches=Id;class Cd extends Gc{constructor(){super(...arguments),ql.add(this)}async unwrap(e,t,n=this._client.webhookSecret,s=300){return await this.verifySignature(e,t,n,s),JSON.parse(e)}async verifySignature(e,t,n=this._client.webhookSecret,s=300){if("undefined"==typeof crypto||"function"!=typeof crypto.subtle.importKey||"function"!=typeof crypto.subtle.verify)throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");Po(this,ql,"m",Ul).call(this,n);const r=Xu([t]).values,a=Po(this,ql,"m",Bl).call(this,r,"webhook-signature"),i=Po(this,ql,"m",Bl).call(this,r,"webhook-timestamp"),o=Po(this,ql,"m",Bl).call(this,r,"webhook-id"),c=parseInt(i,10);if(isNaN(c))throw new I("Invalid webhook timestamp format");const u=Math.floor(Date.now()/1e3);if(u-c>s)throw new I("Webhook timestamp is too old");if(c>u+s)throw new I("Webhook timestamp is too new");const l=a.split(" ").map(e=>e.startsWith("v1,")?e.substring(3):e),d=n.startsWith("whsec_")?Buffer.from(n.replace("whsec_",""),"base64"):Buffer.from(n,"utf-8"),p=o?`${o}.${i}.${e}`:`${i}.${e}`,h=await crypto.subtle.importKey("raw",d,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(const e of l)try{const t=Buffer.from(e,"base64");if(await crypto.subtle.verify("HMAC",h,t,(new TextEncoder).encode(p)))return}catch{continue}throw new I("The given webhook signature does not match the expected signature")}}ql=new WeakSet,Ul=function(e){if("string"!=typeof e||0===e.length)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},Bl=function(e,t){if(!e)throw new Error("Headers are required");const n=e.get(t);if(null==n)throw new Error(`Missing required header: ${t}`);return n};class Od{constructor({baseURL:e=ul("OPENAI_BASE_URL"),apiKey:t=ul("OPENAI_API_KEY"),organization:n=ul("OPENAI_ORG_ID")??null,project:s=ul("OPENAI_PROJECT_ID")??null,webhookSecret:r=ul("OPENAI_WEBHOOK_SECRET")??null,...a}={}){if(Jl.add(this),Wl.set(this,void 0),this.completions=new Yl(this),this.chat=new Ku(this),this.embeddings=new nd(this),this.files=new id(this),this.images=new _d(this),this.audio=new tl(this),this.moderations=new vd(this),this.models=new yd(this),this.fineTuning=new md(this),this.graders=new gd(this),this.vectorStores=new Ad(this),this.webhooks=new Cd(this),this.beta=new Xl(this),this.batches=new nl(this),this.uploads=new kd(this),this.responses=new xd(this),this.evals=new ad(this),this.containers=new td(this),void 0===t)throw new l("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const i={apiKey:t,organization:n,project:s,webhookSecret:r,...a,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new l("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");this.baseURL=i.baseURL,this.timeout=i.timeout??zl.DEFAULT_TIMEOUT,this.logger=i.logger??console;const o="warn";this.logLevel=o,this.logLevel=yc(i.logLevel,"ClientOptions.logLevel",this)??yc(ul("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??o,this.fetchOptions=i.fetchOptions,this.maxRetries=i.maxRetries??2,this.fetch=i.fetch??function(){if("undefined"!=typeof fetch)return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}(),No(this,Wl,Ko,"f"),this._options=i,this.apiKey=t,this.organization=n,this.project=s,this.webhookSecret=r}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){}async authHeaders(e){return Xu([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return function(e,t={}){let n=e;const s=function(e=ac){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const t=e.charset||ac.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=Ho;if(void 0!==e.format){if(!Yo(Xo,e.format))throw new TypeError("Unknown format option provided.");n=e.format}const s=Xo[n];let r,a=ac.filter;if(("function"==typeof e.filter||jo(e.filter))&&(a=e.filter),r=e.arrayFormat&&e.arrayFormat in nc?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":ac.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=void 0===e.allowDots?1==!!e.encodeDotInKeys||ac.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:ac.addQueryPrefix,allowDots:i,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:ac.allowEmptyArrays,arrayFormat:r,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:ac.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?ac.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:ac.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:ac.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:ac.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:ac.encodeValuesOnly,filter:a,format:n,formatter:s,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:ac.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:ac.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:ac.strictNullHandling}}(t);let r,a;"function"==typeof s.filter?(a=s.filter,n=a("",n)):jo(s.filter)&&(a=s.filter,r=a);const i=[];if("object"!=typeof n||null===n)return"";const o=nc[s.arrayFormat],c="comma"===o&&s.commaRoundTrip;r||(r=Object.keys(n)),s.sort&&r.sort(s.sort);const u=new WeakMap;for(let e=0;e<r.length;++e){const t=r[e];s.skipNulls&&null===n[t]||sc(i,oc(n[t],t,o,c,s.allowEmptyArrays,s.strictNullHandling,s.skipNulls,s.encodeDotInKeys,s.encode?s.encoder:null,s.filter,s.sort,s.allowDots,s.serializeDate,s.format,s.formatter,s.encodeValuesOnly,s.charset,u))}const l=i.join(s.delimiter);let d=!0===s.addQueryPrefix?"?":"";return s.charsetSentinel&&("iso-8859-1"===s.charset?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),l.length>0?d+l:""}(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${Fo}`}defaultIdempotencyKey(){return`stainless-node-retry-${$o()}`}makeStatusError(e,t,n,s){return d.generate(e,t,n,s)}buildURL(e,t,n){const s=!Po(this,Jl,"m",Gl).call(this)&&n||this.baseURL,r=(e=>Do.test(e))(e)?new URL(e):new URL(s+(s.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return function(e){if(!e)return!0;for(const t in e)return!1;return!0}(a)||(t={...a,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(n=>({method:e,path:t,...n})))}request(e,t=null){return new Nc(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,n){const s=await e,r=s.maxRetries??this.maxRetries;null==t&&(t=r),await this.prepareOptions(s);const{req:a,url:i,timeout:o}=await this.buildRequest(s,{retryCount:r-t});await this.prepareRequest(a,{url:i,options:s});const l="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),d=void 0===n?"":`, retryOf: ${n}`,f=Date.now();if(Sc(this).debug(`[${l}] sending request`,kc({retryOfRequestLogID:n,method:s.method,url:i,options:s,headers:a.headers})),s.signal?.aborted)throw new p;const g=new AbortController,_=await this.fetchWithTimeout(i,a,o,g).catch(u),y=Date.now();if(_ instanceof Error){const e=`retrying, ${t} attempts remaining`;if(s.signal?.aborted)throw new p;const r=c(_)||/timed? ?out/i.test(String(_)+("cause"in _?String(_.cause):""));if(t)return Sc(this).info(`[${l}] connection ${r?"timed out":"failed"} - ${e}`),Sc(this).debug(`[${l}] connection ${r?"timed out":"failed"} (${e})`,kc({retryOfRequestLogID:n,url:i,durationMs:y-f,message:_.message})),this.retryRequest(s,t,n??l);if(Sc(this).info(`[${l}] connection ${r?"timed out":"failed"} - error; no more retries left`),Sc(this).debug(`[${l}] connection ${r?"timed out":"failed"} (error; no more retries left)`,kc({retryOfRequestLogID:n,url:i,durationMs:y-f,message:_.message})),r)throw new m;throw new h({cause:_})}const v=`[${l}${d}${[..._.headers.entries()].filter(([e])=>"x-request-id"===e).map(([e,t])=>", "+e+": "+JSON.stringify(t)).join("")}] ${a.method} ${i} ${_.ok?"succeeded":"failed"} with status ${_.status} in ${y-f}ms`;if(!_.ok){const e=await this.shouldRetry(_);if(t&&e){const e=`retrying, ${t} attempts remaining`;return await async function(e){if(null===e||"object"!=typeof e)return;if(e[Symbol.asyncIterator])return void await(e[Symbol.asyncIterator]().return?.());const t=e.getReader(),n=t.cancel();t.releaseLock(),await n}(_.body),Sc(this).info(`${v} - ${e}`),Sc(this).debug(`[${l}] response error (${e})`,kc({retryOfRequestLogID:n,url:_.url,status:_.status,headers:_.headers,durationMs:y-f})),this.retryRequest(s,t,n??l,_.headers)}const r=e?"error; no more retries left":"error; not retryable";Sc(this).info(`${v} - ${r}`);const a=await _.text().catch(e=>u(e).message),i=(e=>{try{return JSON.parse(e)}catch(e){return}})(a),o=i?void 0:a;throw Sc(this).debug(`[${l}] response error (${r})`,kc({retryOfRequestLogID:n,url:_.url,status:_.status,headers:_.headers,message:o,durationMs:Date.now()-f})),this.makeStatusError(_.status,i,o,_.headers)}return Sc(this).info(v),Sc(this).debug(`[${l}] response start`,kc({retryOfRequestLogID:n,url:_.url,status:_.status,headers:_.headers,durationMs:y-f})),{response:_,options:s,controller:g,requestLogID:l,retryOfRequestLogID:n,startTime:f}}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}requestAPIList(e,t){const n=this.makeRequest(t,null,void 0);return new $c(this,n,e)}async fetchWithTimeout(e,t,n,s){const{signal:r,method:a,...i}=t||{};r&&r.addEventListener("abort",()=>s.abort());const o=setTimeout(()=>s.abort(),n),c=globalThis.ReadableStream&&i.body instanceof globalThis.ReadableStream||"object"==typeof i.body&&null!==i.body&&Symbol.asyncIterator in i.body,u={signal:s.signal,...c?{duplex:"half"}:{},method:"GET",...i};a&&(u.method=a.toUpperCase());try{return await this.fetch.call(void 0,e,u)}finally{clearTimeout(o)}}async shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||e.status>=500)}async retryRequest(e,t,n,s){let r;const a=s?.get("retry-after-ms");if(a){const e=parseFloat(a);Number.isNaN(e)||(r=e)}const i=s?.get("retry-after");if(i&&!r){const e=parseFloat(i);r=Number.isNaN(e)?Date.parse(i)-Date.now():1e3*e}if(!(r&&0<=r&&r<6e4)){const n=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,n)}return await Lo(r),this.makeRequest(e,t-1,n)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}async buildRequest(e,{retryCount:t=0}={}){const n={...e},{method:s,path:r,query:a,defaultBaseURL:i}=n,o=this.buildURL(r,a,i);"timeout"in n&&((e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new l(`${e} must be an integer`);if(t<0)throw new l(`${e} must be a positive integer`)})("timeout",n.timeout),n.timeout=n.timeout??this.timeout;const{bodyHeaders:c,body:u}=this.buildBody({options:n});return{req:{method:s,headers:await this.buildHeaders({options:e,method:s,bodyHeaders:c,retryCount:t}),...n.signal&&{signal:n.signal},...globalThis.ReadableStream&&u instanceof globalThis.ReadableStream&&{duplex:"half"},...u&&{body:u},...this.fetchOptions??{},...n.fetchOptions??{}},url:o,timeout:n.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:n,retryCount:s}){let r={};this.idempotencyHeader&&"get"!==t&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),r[this.idempotencyHeader]=e.idempotencyKey);const a=Xu([r,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(s),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...Jo??(Jo=qo()),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,n,e.headers]);return this.validateHeaders(a),a.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};const n=Xu([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||"string"==typeof e&&n.values.has("content-type")||e instanceof Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:"object"==typeof e&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&"function"==typeof e.next)?{bodyHeaders:void 0,body:Wo(e)}:Po(this,Wl,"f").call(this,{body:e,headers:n})}}zl=Od,Wl=new WeakMap,Jl=new WeakSet,Gl=function(){return"https://api.openai.com/v1"!==this.baseURL},Od.OpenAI=zl,Od.DEFAULT_TIMEOUT=6e5,Od.OpenAIError=l,Od.APIError=d,Od.APIConnectionError=h,Od.APIConnectionTimeoutError=m,Od.APIUserAbortError=p,Od.NotFoundError=y,Od.ConflictError=v,Od.RateLimitError=b,Od.BadRequestError=f,Od.AuthenticationError=g,Od.InternalServerError=x,Od.PermissionDeniedError=_,Od.UnprocessableEntityError=w,Od.InvalidWebhookSignatureError=I,Od.toFile=async function(e,t,n){if(Mc(),(e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&zc(e))(e=await e))return e instanceof File?e:Zc([await e.arrayBuffer()],e.name);if((e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob)(e)){const s=await e.blob();return t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()),Zc(await Wc(s),t,n)}const s=await Wc(e);if(t||(t=Lc(e)),!n?.type){const e=s.find(e=>"object"==typeof e&&"type"in e&&e.type);"string"==typeof e&&(n={...n,type:e})}return Zc(s,t,n)},Od.Completions=Yl,Od.Chat=Ku,Od.Embeddings=nd,Od.Files=id,Od.Images=_d,Od.Audio=tl,Od.Moderations=vd,Od.Models=yd,Od.FineTuning=md,Od.Graders=gd,Od.VectorStores=Ad,Od.Webhooks=Cd,Od.Beta=Xl,Od.Batches=nl,Od.Uploads=kd,Od.Responses=xd,Od.Evals=ad,Od.Containers=td,new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations","/batches","/images/edits"]);let Rd,Ed,Nd,Pd="responses";function $d(e){Nd=e}function Dd(e){Pd=e}function jd(e){Rd=e}function Md(e){Ed=e}const Zd={"User-Agent":"Agents/JavaScript 0.0.12"},Ld=ln("openai-agents:openai"),Fd=ur(["in_progress","completed","searching","failed"]).default("failed"),qd=ur(["in_progress","completed","searching","failed","incomplete"]).default("failed"),Ud=ur(["in_progress","completed","interpreting"]).default("in_progress"),Bd=ur(["in_progress","completed","generating","failed"]).default("failed");function Jd(e={}){const t={type:"web_search",name:e.name??"web_search_preview",user_location:e.userLocation,search_context_size:e.searchContextSize??"medium"};return{type:"hosted_tool",name:e.name??"web_search_preview",providerData:t}}function zd(e,t={}){const n=Array.isArray(e)?e:[e],s={type:"file_search",name:t.name??"file_search",vector_store_ids:n,max_num_results:t.maxNumResults,include_search_results:t.includeSearchResults,ranking_options:t.rankingOptions,filters:t.filters};return{type:"hosted_tool",name:t.name??"file_search",providerData:s}}function Wd(e={}){const t={type:"code_interpreter",name:e.name??"code_interpreter",container:e.container??{type:"auto"}};return{type:"hosted_tool",name:e.name??"code_interpreter",providerData:t}}function Gd(e={}){const t={type:"image_generation",name:e.name??"image_generation",background:e.background,input_fidelity:e.inputFidelity,input_image_mask:e.inputImageMask,model:e.model,moderation:e.moderation,output_compression:e.outputCompression,output_format:e.outputFormat,partial_images:e.partialImages,quality:e.quality,size:e.size};return{type:"hosted_tool",name:e.name??"image_generation",providerData:t}}function Kd(e){if(!e||"object"!=typeof e||Array.isArray(e))return e;const t={};for(const[n,s]of Object.entries(e))t[n.replace(/([A-Z])/g,"_$1").toLowerCase()]=Kd(s);return t}const Hd=ur(["file_search","web_search_preview","computer_use_preview","code_interpreter","image_generation","mcp"]),Vd=ur(["auto","required","none"]);function Xd(e){if("function"===e.type)return{tool:{type:"function",name:e.name,description:e.description,parameters:e.parameters,strict:e.strict},include:void 0};if("computer"===e.type)return{tool:{type:"computer_use_preview",environment:e.environment,display_width:e.dimensions[0],display_height:e.dimensions[1]},include:void 0};if("hosted_tool"===e.type){if("web_search"===e.providerData?.type)return{tool:{type:"web_search_preview",user_location:e.providerData.user_location,search_context_size:e.providerData.search_context_size},include:void 0};if("file_search"===e.providerData?.type)return{tool:{type:"file_search",vector_store_ids:e.providerData.vector_store_ids||("string"==typeof e.providerData.vector_store_id?[e.providerData.vector_store_id]:e.providerData.vector_store_id),max_num_results:e.providerData.max_num_results,ranking_options:e.providerData.ranking_options,filters:e.providerData.filters},include:e.providerData.include_search_results?["file_search_call.results"]:void 0};if("code_interpreter"===e.providerData?.type)return{tool:{type:"code_interpreter",container:e.providerData.container},include:void 0};if("image_generation"===e.providerData?.type)return{tool:{type:"image_generation",background:e.providerData.background,input_fidelity:e.providerData.input_fidelity,input_image_mask:e.providerData.input_image_mask,model:e.providerData.model,moderation:e.providerData.moderation,output_compression:e.providerData.output_compression,output_format:e.providerData.output_format,partial_images:e.providerData.partial_images,quality:e.providerData.quality,size:e.providerData.size},include:void 0};if("mcp"===e.providerData?.type)return{tool:{type:"mcp",server_label:e.providerData.server_label,server_url:e.providerData.server_url,allowed_tools:e.providerData.allowed_tools,headers:e.providerData.headers,require_approval:(t=e.providerData.require_approval,"never"===t||void 0===t?"never":"always"===t?"always":{never:{tool_names:t.never?.tool_names},always:{tool_names:t.always?.tool_names}})},include:void 0};if(e.providerData)return{tool:e.providerData,include:void 0}}var t;throw new Error(`Unsupported tool type: ${JSON.stringify(e)}`)}function Yd(e){return{name:e.toolName,description:e.toolDescription,parameters:e.inputJsonSchema,strict:e.strictJsonSchema,type:"function"}}function Qd(e){if("input_text"===e.type)return{type:"input_text",text:e.text,...Kd(e.providerData)};if("input_image"===e.type){const t={type:"input_image",detail:"auto"};return"string"==typeof e.image?t.image_url=e.image:t.file_id=e.image.id,{...t,...Kd(e.providerData)}}if("input_file"===e.type){const t={type:"input_file"};if("string"==typeof e.file)if(e.file.startsWith("data:"))t.file_data=e.file;else{if(!e.file.startsWith("https://"))throw new Kt("Unsupported string data for file input. If you're trying to pass an uploaded file's ID, use an object with the ID property instead.");t.file_url=e.file}else"id"in e.file?t.file_id=e.file.id:"url"in e.file&&(t.file_url=e.file.url);return{...t,...Kd(e.providerData)}}throw new Kt(`Unsupported input content type: ${JSON.stringify(e)}`)}function ep(e){if("output_text"===e.type)return{type:"output_text",text:e.text,annotations:[],...Kd(e.providerData)};if("refusal"===e.type)return{type:"refusal",refusal:e.refusal,...Kd(e.providerData)};throw new Kt(`Unsupported output content type: ${JSON.stringify(e)}`)}function tp(e){return{type:"computer_screenshot",image_url:e.output.data}}function np(e){if("output_text"===e.type){const{type:t,text:n,...s}=e;return{type:t,text:n,...s}}if("refusal"===e.type){const{type:t,refusal:n,...s}=e;return{type:t,refusal:n,...s}}throw new Error(`Unsupported message content type: ${JSON.stringify(e)}`)}function sp(e){return e.map(e=>{if("message"===e.type){const{id:t,type:n,role:s,content:r,status:a,...i}=e;return{id:t,type:n,role:s,content:r.map(np),status:a,providerData:i}}if("file_search_call"===e.type||"web_search_call"===e.type||"image_generation_call"===e.type||"code_interpreter_call"===e.type){const{status:t,...n}=e;let s;return"result"in n&&null!==n.result&&(s=n.result,delete n.result),{type:"hosted_tool_call",id:e.id,name:e.type,status:t,output:s,providerData:n}}if("function_call"===e.type){const{call_id:t,name:n,status:s,arguments:r,...a}=e;return{type:"function_call",id:e.id,callId:t,name:n,status:s,arguments:r,providerData:a}}if("computer_call"===e.type){const{call_id:t,status:n,action:s,...r}=e;return{type:"computer_call",id:e.id,callId:t,status:n,action:s,providerData:r}}if("mcp_list_tools"===e.type){const{...t}=e;return{type:"hosted_tool_call",id:e.id,name:e.type,status:"completed",output:void 0,providerData:t}}if("mcp_approval_request"===e.type){const{...t}=e;return{type:"hosted_tool_call",id:e.id,name:"mcp_approval_request",status:"completed",output:void 0,providerData:t}}if("mcp_call"===e.type){const{output:t,...n}=e;return{type:"hosted_tool_call",id:e.id,name:e.type,status:"completed",output:t||void 0,providerData:n}}if("reasoning"===e.type){const{summary:t,...n}=e;return{type:"reasoning",id:e.id,content:t.map(e=>{const{text:t,...n}=e;return{type:"input_text",text:t,providerData:n}}),providerData:n}}return{type:"unknown",providerData:e}})}class rp{#U;#B;constructor(e,t){this.#U=e,this.#B=t}async#J(e,t){const n=function(e){return"string"==typeof e?[{role:"user",content:e}]:e.map(e=>{if(function(e){return"message"===e.type||void 0===e.type&&"string"==typeof e.role}(e))return function(e){if("system"===e.role)return{id:e.id,role:"system",content:e.content,...Kd(e.providerData)};if("user"===e.role)return"string"==typeof e.content?{id:e.id,role:"user",content:e.content,...Kd(e.providerData)}:{id:e.id,role:"user",content:e.content.map(Qd),...Kd(e.providerData)};if("assistant"===e.role)return{type:"message",id:e.id,role:"assistant",content:e.content.map(ep),status:e.status,...Kd(e.providerData)};throw new Kt(`Unsupported item ${JSON.stringify(e)}`)}(e);if("function_call"===e.type)return{id:e.id,type:"function_call",name:e.name,call_id:e.callId,arguments:e.arguments,status:e.status,...Kd(e.providerData)};if("function_call_result"===e.type){if("text"!==e.output.type)throw new Kt(`Unsupported tool result type: ${JSON.stringify(e.output)}`);return{type:"function_call_output",id:e.id,call_id:e.callId,output:e.output.text,status:e.status,...Kd(e.providerData)}}if("reasoning"===e.type)return{id:e.id,type:"reasoning",summary:e.content.map(e=>({type:"summary_text",text:e.text,...Kd(e.providerData)})),encrypted_content:e.providerData?.encryptedContent,...Kd(e.providerData)};if("computer_call"===e.type)return{type:"computer_call",call_id:e.callId,id:e.id,action:e.action,status:e.status,pending_safety_checks:[],...Kd(e.providerData)};if("computer_call_result"===e.type)return{type:"computer_call_output",id:e.id,call_id:e.callId,output:tp(e),status:e.providerData?.status,acknowledged_safety_checks:e.providerData?.acknowledgedSafetyChecks,...Kd(e.providerData)};if("hosted_tool_call"===e.type){if("web_search_call"===e.providerData?.type||"web_search"===e.providerData?.type)return{...Kd(e.providerData),type:"web_search_call",id:e.id,status:Fd.parse(e.status??"failed")};if("file_search_call"===e.providerData?.type||"file_search"===e.providerData?.type)return{...Kd(e.providerData),type:"file_search_call",id:e.id,status:qd.parse(e.status??"failed"),queries:e.providerData?.queries??[],results:e.providerData?.results};if("code_interpreter_call"===e.providerData?.type||"code_interpreter"===e.providerData?.type)return{...Kd(e.providerData),type:"code_interpreter_call",id:e.id,code:e.providerData?.code??"",outputs:e.providerData?.outputs??e.providerData?.results??[],status:Ud.parse(e.status??"failed"),container_id:e.providerData?.containerId};if("image_generation_call"===e.providerData?.type||"image_generation"===e.providerData?.type)return{...Kd(e.providerData),type:"image_generation_call",id:e.id,result:e.providerData?.result??null,status:Bd.parse(e.status??"failed")};if("mcp_list_tools"===e.providerData?.type||"mcp_list_tools"===e.name){const t=e.providerData;return{...Kd(e.providerData),type:"mcp_list_tools",id:e.id,tools:Kd(t.tools),server_label:t.server_label,error:t.error}}if("mcp_approval_request"===e.providerData?.type||"mcp_approval_request"===e.name){const t=e.providerData;return{...Kd(e.providerData),type:"mcp_approval_request",id:t.id??e.id,name:t.name,arguments:t.arguments,server_label:t.server_label}}if("mcp_approval_response"===e.providerData?.type||"mcp_approval_response"===e.name){const t=e.providerData;return{...Kd(t),type:"mcp_approval_response",id:t.id,approve:t.approve,approval_request_id:t.approval_request_id,reason:t.reason}}if("mcp_call"===e.providerData?.type||"mcp_call"===e.name){const t=e.providerData;return{...Kd(t),type:"mcp_call",id:t.id??e.id,name:t.name,arguments:t.arguments,server_label:t.server_label,error:t.error}}throw new Kt(`Unsupported built-in tool call type: ${JSON.stringify(e)}`)}if("unknown"===e.type)return{...Kd(e.providerData),id:e.id};const t=e;throw new Kt(`Unsupported item ${JSON.stringify(t)}`)})}(e.input),{tools:s,include:r}=function(e,t){const n=[],s=[];for(const t of e){const{tool:e,include:r}=Xd(t);if(n.push(e),r&&r.length>0)for(const e of r)s.push(e)}return{tools:[...n,...t.map(Yd)],include:s}}(e.tools,e.handoffs),a=function(e){if(void 0===e)return;const t=Vd.safeParse(e);if(t.success)return t.data;const n=Hd.safeParse(e);return n.success?{type:n.data}:{type:"function",name:e}}(e.modelSettings.toolChoice),i=function(e){if("text"!==e)return{format:e}}(e.outputType),o=function(e){if(!e)return;const t={};for(const[n,s]of Object.entries(e.variables??{}))"string"==typeof s?t[n]=s:"object"==typeof s&&(t[n]=Qd(s));return{id:e.promptId,version:e.version,variables:t}}(e.prompt);let c;if("boolean"==typeof e.modelSettings.parallelToolCalls){if(e.modelSettings.parallelToolCalls&&0===s.length)throw new Error("Parallel tool calls are not supported without tools");c=e.modelSettings.parallelToolCalls}const u={instructions:e.systemInstructions,model:this.#B,input:n,include:r,tools:s,previous_response_id:e.previousResponseId,prompt:o,temperature:e.modelSettings.temperature,top_p:e.modelSettings.topP,truncation:e.modelSettings.truncation,max_output_tokens:e.modelSettings.maxTokens,tool_choice:a,parallel_tool_calls:c,stream:t,text:i,store:e.modelSettings.store,...e.modelSettings.providerData};Ld.dontLogModelData?Ld.debug("Calling LLM"):Ld.debug(`Calling LLM. Request data: ${JSON.stringify(u,null,2)}`);const l=await this.#U.responses.create(u,{headers:Zd,signal:e.signal});return Ld.dontLogModelData?Ld.debug("Response received"):Ld.debug(`Response received: ${JSON.stringify(l,null,2)}`),l}async getResponse(e){const t=await aa(async t=>{const n=await this.#J(e,!1);return e.tracing&&(t.spanData.response_id=n.id,t.spanData._input=e.input,t.spanData._response=n),n});return{usage:new ki({inputTokens:t.usage?.input_tokens??0,outputTokens:t.usage?.output_tokens??0,totalTokens:t.usage?.total_tokens??0,inputTokensDetails:{...t.usage?.input_tokens_details},outputTokensDetails:{...t.usage?.output_tokens_details}}),output:sp(t.output),responseId:t.id,providerData:t}}async*getStreamedResponse(e){const t=e.tracing?ra():void 0;try{t&&(t.start(),Dr(t),!0===e.tracing&&(t.spanData._input=e.input));const n=await this.#J(e,!0);let s;for await(const e of n){if("response.created"===e.type)yield{type:"response_started",providerData:{...e}};else if("response.completed"===e.type){s=e.response;const{response:t,...n}=e,{output:r,usage:a,id:i,...o}=t;yield{type:"response_done",response:{id:i,output:sp(r),usage:{inputTokens:a?.input_tokens??0,outputTokens:a?.output_tokens??0,totalTokens:a?.total_tokens??0,inputTokensDetails:{...a?.input_tokens_details},outputTokensDetails:{...a?.output_tokens_details}},providerData:o},providerData:n},yield{type:"model",event:e}}else if("response.output_text.delta"===e.type){const{delta:t,...n}=e;yield{type:"output_text_delta",delta:t,providerData:n}}yield{type:"model",event:e}}e.tracing&&t&&s&&(t.spanData.response_id=s.id,t.spanData._response=s)}catch(n){throw t&&t.setError({message:"Error streaming response",data:{error:e.tracing?String(n):n instanceof Error?n.name:void 0}}),n}finally{t&&(t.end(),jr())}}}function ap(e){if(null!=e&&null!=e)return"auto"===e||"required"===e||"none"===e?e:{type:"function",function:{name:e}}}function ip(e){if("string"==typeof e)return e;const t=[];for(const n of e)if("output_text"===n.type||"input_text"===n.type)t.push({type:"text",text:n.text,...n.providerData});else{if("refusal"!==n.type){if("audio"===n.type||"image"===n.type)continue;{const e=n;throw new Error(`Unknown content: ${JSON.stringify(e)}`)}}t.push({type:"refusal",refusal:n.refusal,...n.providerData})}return t}function op(e){if("string"==typeof e)return e;const t=[];for(const n of e)if("input_text"===n.type)t.push({type:"text",text:n.text,...n.providerData});else if("input_image"===n.type){if("string"!=typeof n.image)throw new Error(`Only image URLs are supported for input_image: ${JSON.stringify(n)}`);const{image_url:e,...s}=n.providerData||{};t.push({type:"image_url",image_url:{url:n.image,...e},...s})}else{if("input_file"===n.type)throw new Error(`File uploads are not supported for chat completions: ${JSON.stringify(n)}`);if("audio"!==n.type){const e=n;throw new Error(`Unknown content: ${JSON.stringify(e)}`)}{const{input_audio:e,...s}=n.providerData||{};t.push({type:"input_audio",input_audio:{data:n.audio,...e},...s})}}return t}function cp(e){return"message"===e.type||void 0===e.type&&"string"==typeof e.role}function up(e){if("function"===e.type)return{type:"function",function:{name:e.name,description:e.description||"",parameters:e.parameters}};throw new Error(`Hosted tools are not supported with the ChatCompletions API. Got tool type: ${e.type}, tool: ${JSON.stringify(e)}`)}function lp(e){return{type:"function",function:{name:e.toolName,description:e.toolDescription||"",parameters:e.inputJsonSchema}}}const dp="FAKE_ID";class pp{#U;#B;constructor(e,t){this.#U=e,this.#B=t}async getResponse(e){const t=await ha(async t=>{t.spanData.model=this.#B,t.spanData.model_config=e.modelSettings?{temperature:e.modelSettings.temperature,top_p:e.modelSettings.topP,frequency_penalty:e.modelSettings.frequencyPenalty,presence_penalty:e.modelSettings.presencePenalty}:{base_url:this.#U.baseURL};const n=await this.#J(e,t,!1);return t&&!0===e.tracing&&(t.spanData.output=[n]),n}),n=[];if(t.choices&&t.choices[0]){const e=t.choices[0].message;if(void 0===e.content||null===e.content||e.tool_calls&&""===e.content){if(e.refusal){const{refusal:s,...r}=e;n.push({id:t.id,type:"message",role:"assistant",content:[{type:"refusal",refusal:s||"",providerData:r}],status:"completed"})}else if(e.audio){const{data:s,...r}=e.audio;n.push({id:t.id,type:"message",role:"assistant",content:[{type:"audio",audio:s,providerData:r}],status:"completed"})}else if(e.tool_calls)for(const s of e.tool_calls){const{id:e,...r}=s,{arguments:a,name:i,...o}=s.function;n.push({id:t.id,type:"function_call",arguments:a,name:i,callId:e,status:"completed",providerData:{...r,...o}})}}else{const{content:s,...r}=e;n.push({id:t.id,type:"message",role:"assistant",content:[{type:"output_text",text:s||"",providerData:r}],status:"completed"})}}var s;return{usage:t.usage?new ki((s=t.usage,{requests:1,input_tokens:s.prompt_tokens,output_tokens:s.completion_tokens,total_tokens:s.total_tokens,input_tokens_details:{cached_tokens:s.prompt_tokens_details?.cached_tokens||0},output_tokens_details:{reasoning_tokens:s.completion_tokens_details?.reasoning_tokens||0}})):new ki,output:n,responseId:t.id,providerData:t}}async*getStreamedResponse(e){const t=e.tracing?pa():void 0;try{t&&(t.start(),Dr(t));const n=await this.#J(e,t,!0),s={id:dp,created:Math.floor(Date.now()/1e3),model:this.#B,object:"chat.completion",choices:[],usage:{prompt_tokens:0,completion_tokens:0,total_tokens:0}};for await(const e of async function*(e,t){let n;const s={started:!1,text_content_index_and_output:null,refusal_content_index_and_output:null,function_calls:{}};for await(const e of t){if(s.started||(s.started=!0,yield{type:"response_started",providerData:{...e}}),yield{type:"model",event:e},n=e.usage||void 0,!e.choices?.[0]?.delta)continue;const t=e.choices[0].delta;if(t.content&&(s.text_content_index_and_output||(s.text_content_index_and_output=[s.refusal_content_index_and_output?1:0,{text:"",type:"output_text",providerData:{annotations:[]}}]),yield{type:"output_text_delta",delta:t.content,providerData:{...e}},s.text_content_index_and_output[1].text+=t.content),"refusal"in t&&t.refusal&&(s.refusal_content_index_and_output||(s.refusal_content_index_and_output=[s.text_content_index_and_output?1:0,{refusal:"",type:"refusal"}]),s.refusal_content_index_and_output[1].refusal+=t.refusal),t.tool_calls)for(const e of t.tool_calls){e.index in s.function_calls||(s.function_calls[e.index]={id:dp,arguments:"",name:"",type:"function_call",callId:""});const t=e.function;s.function_calls[e.index].arguments+=t?.arguments||"",s.function_calls[e.index].name+=t?.name||"",s.function_calls[e.index].callId+=e.id||""}}const r=[];if(s.text_content_index_and_output||s.refusal_content_index_and_output){const e={id:dp,content:[],role:"assistant",type:"message",status:"completed"};s.text_content_index_and_output&&e.content.push(s.text_content_index_and_output[1]),s.refusal_content_index_and_output&&e.content.push(s.refusal_content_index_and_output[1]),r.push(e)}for(const e of Object.values(s.function_calls))r.push(e);const a={type:"response_done",response:{id:e.id,usage:{inputTokens:n?.prompt_tokens??0,outputTokens:n?.completion_tokens??0,totalTokens:n?.total_tokens??0,inputTokensDetails:{cached_tokens:n?.prompt_tokens_details?.cached_tokens??0},outputTokensDetails:{reasoning_tokens:n?.completion_tokens_details?.reasoning_tokens??0}},output:r}};yield a}(s,n))yield e;t&&s&&!0===e.tracing&&(t.spanData.output=[s])}catch(n){throw t&&t.setError({message:"Error streaming response",data:{error:!0===e.tracing?String(n):n instanceof Error?n.name:void 0}}),n}finally{t&&(t.end(),jr())}}async#J(e,t,n){const s=[];if(e.tools)for(const t of e.tools)s.push(up(t));if(e.handoffs)for(const t of e.handoffs)s.push(lp(t));const r="text"===(a=e.outputType)?{type:"text"}:"json_schema"===a.type?{type:"json_schema",json_schema:{name:a.name,strict:a.strict,schema:a.schema}}:{type:"json_object"};var a;let i;if("boolean"==typeof e.modelSettings.parallelToolCalls){if(e.modelSettings.parallelToolCalls&&0===s.length)throw new Error("Parallel tool calls are not supported without tools");i=e.modelSettings.parallelToolCalls}const o=function(e){if("string"==typeof e)return[{role:"user",content:e}];const t=[];let n=null;const s=()=>{n&&(n.tool_calls&&0!==n.tool_calls.length||delete n.tool_calls,t.push(n),n=null)},r=()=>(n||(n={role:"assistant",tool_calls:[]}),n);for(const n of e)if(cp(n)){const{content:e,role:r,providerData:a}=n;if(s(),"assistant"===r){const n={role:"assistant",content:ip(e),...a},s=e.find(e=>"audio"===e.type);s&&(n.audio={id:"",...s.providerData}),t.push(n)}else"user"===r?t.push({role:r,content:op(e),...a}):"system"===r&&t.push({role:"system",content:e,...a})}else{if("reasoning"===n.type)throw new Kt("Reasoning is not supported for chat completions. Got item: "+JSON.stringify(n));if("hosted_tool_call"===n.type){if("file_search_call"===n.name){const e=r(),t=e.tool_calls??[],s=n,{function:a,...i}=s.providerData??{},{arguments:o,...c}=a??{};t.push({id:s.id||"",type:"function",function:{name:"file_search_call",arguments:JSON.stringify({queries:s.providerData?.queries??[],status:s.status,...o}),...c},...i}),e.tool_calls=t;continue}throw new Kt("Hosted tool calls are not supported for chat completions. Got item: "+JSON.stringify(n))}if("computer_call"===n.type||"computer_call_result"===n.type)throw new Kt("Computer use calls are not supported for chat completions. Got item: "+JSON.stringify(n));if("function_call"===n.type){const e=r(),t=e.tool_calls??[],s=n;t.push({id:s.callId,type:"function",function:{name:s.name,arguments:s.arguments??"{}"}}),e.tool_calls=t}else if("function_call_result"===n.type){s();const e=n;if("text"!==e.output.type)throw new Kt("Only text output is supported for chat completions. Got item: "+JSON.stringify(n));t.push({role:"tool",tool_call_id:e.callId,content:e.output.text,...e.providerData})}else{if("unknown"!==n.type){const e=n;throw new Error(`Unknown item type: ${JSON.stringify(e)}`)}t.push({...n.providerData})}}return s(),t}(e.input);e.systemInstructions&&o.unshift({content:e.systemInstructions,role:"system"}),t&&!0===e.tracing&&(t.spanData.input=o);const c={model:this.#B,messages:o,tools:s.length?s:void 0,temperature:e.modelSettings.temperature,top_p:e.modelSettings.topP,frequency_penalty:e.modelSettings.frequencyPenalty,presence_penalty:e.modelSettings.presencePenalty,max_tokens:e.modelSettings.maxTokens,tool_choice:ap(e.modelSettings.toolChoice),response_format:r,parallel_tool_calls:i,stream:n,store:e.modelSettings.store,...e.modelSettings.providerData};Ld.dontLogModelData?Ld.debug("Calling LLM"):Ld.debug(`Calling LLM. Request data: ${JSON.stringify(c,null,2)}`);const u=await this.#U.chat.completions.create(c,{headers:Zd,signal:e.signal});return Ld.dontLogModelData?Ld.debug("Response received"):Ld.debug(`Response received: ${JSON.stringify(u,null,2)}`),u}}class hp{#U;#z;#W;constructor(e={}){if(this.#W=e,this.#W.openAIClient){if(this.#W.apiKey)throw new Error("Cannot provide both apiKey and openAIClient");if(this.#W.baseURL)throw new Error("Cannot provide both baseURL and openAIClient");this.#U=this.#W.openAIClient}this.#z=this.#W.useResponses}#G(){return this.#U||(this.#U=Rd??new Od({apiKey:this.#W.apiKey??Ed??{}.OPENAI_API_KEY,baseURL:this.#W.baseURL,organization:this.#W.organization,project:this.#W.project})),this.#U}async getModel(e){const t=e||"gpt-4.1";return this.#z??"responses"===Pd?new rp(this.#G(),t):new pp(this.#G(),t)}}class mp{#W;constructor(e={}){this.#W={apiKey:e.apiKey??void 0,organization:e.organization??"",project:e.project??"",endpoint:e.endpoint??"https://api.openai.com/v1/traces/ingest",maxRetries:e.maxRetries??3,baseDelay:e.baseDelay??1e3,maxDelay:e.maxDelay??3e4}}async export(e,t){const n=this.#W.apiKey??Nd??{}.OPENAI_API_KEY;if(!n)return void Ld.error("No API key provided for OpenAI tracing exporter. Exports will be skipped");const s={data:e.map(e=>e.toJSON()).filter(e=>!!e)};let r=0,a=this.#W.baseDelay;for(;r<this.#W.maxRetries;){try{const e=await fetch(this.#W.endpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`,"OpenAI-Beta":"traces=v1",...Zd},body:JSON.stringify(s),signal:t});if(e.ok)return void Ld.debug(`Exported ${s.data.length} items`);if(e.status>=400&&e.status<500)return void Ld.error(`[non-fatal] Tracing client error ${e.status}: ${await e.text()}`);Ld.warn(`[non-fatal] Tracing: server error ${e.status}, retrying.`)}catch(e){Ld.error("[non-fatal] Tracing: request failed: ",e)}if(t?.aborted)return void Ld.error("Tracing: request aborted");const e=a+.1*Math.random()*a;await new Promise(t=>setTimeout(t,e)),a=Math.min(2*a,this.#W.maxDelay),r++}Ld.error(`Tracing: failed to export traces after ${this.#W.maxRetries} attempts`)}}function fp(){const e=new mp;Aa([new Fr(e)])}const gp="0.0.12";function _p(e){const t=atob(e),n=t.length,s=new Uint8Array(n);for(let e=0;e<n;e++)s[e]=t.charCodeAt(e);return s.buffer}function yp(e){const t=String.fromCharCode(...new Uint8Array(e));return btoa(t)}function vp(e){if(null==e||"object"!=typeof e||!("type"in e)||"string"!=typeof e.type||!e.type)return;if("message"!==e.type)return;if(!("content"in e)||!Array.isArray(e.content)||e.content.length<1)return;const t=e.content[e.content.length-1];return"type"in t&&"string"==typeof t.type?"text"===t.type?"string"==typeof t.text?t.text:void 0:"audio"===t.type&&"string"==typeof t.transcript?t.transcript:void 0:void 0}function wp(e){return"system"===e.role?e:"assistant"===e.role?{...e,content:e.content.map(e=>"audio"===e.type?{...e,audio:null}:e)}:"user"===e.role?{...e,content:e.content.map(e=>"input_audio"===e.type?{...e,audio:null}:e)}:e}function bp(e,t,n){if("conversation.item.input_audio_transcription.completed"===t.type)return e.map(e=>{if(e.itemId===t.item_id&&"message"===e.type&&"role"in e&&"user"===e.role){const n=e.content.map(e=>"input_audio"===e.type?{...e,transcript:t.transcript}:e);return{...e,content:n,status:"completed"}}return e});const s=n||"message"!==t.type?t:wp(t),r=e.findIndex(e=>e.itemId===t.itemId);if(-1!==r)return e.map((e,t)=>t===r?s:n||"message"!==e.type?e:wp(e));if(t.previousItemId){const n=e.findIndex(e=>e.itemId===t.previousItemId);return-1!==n?[...e.slice(0,n+1),s,...e.slice(n+1)]:[...e,s]}return[...e,s]}const xp={"User-Agent":`Agents/JavaScript ${gp}`,"X-OpenAI-Agents-SDK":`openai-agents-sdk.${gp}`},Sp=`openai-agents-sdk.${gp}`;class kp extends Co{voice;constructor(e){super(e),this.voice=e.voice??"ash"}}function Ip({policyHint:e,...t}){const n=$a(t),s=e??n.name;return{...n,policyHint:s,run:async e=>{const t=await n.run(e);return{...t,guardrail:{...t.guardrail,policyHint:s}}}}}const Tp=ln("openai-agents:realtime"),Ap=(sr({itemId:Ys()}),ar("role",[sr({itemId:Ys(),previousItemId:Ys().nullable().optional(),type:cr("message"),role:cr("system"),content:nr(sr({type:cr("input_text"),text:Ys()}))}),sr({itemId:Ys(),previousItemId:Ys().nullable().optional(),type:cr("message"),role:cr("user"),status:ur(["in_progress","completed"]),content:nr(sr({type:cr("input_text"),text:Ys()}).or(sr({type:cr("input_audio"),audio:Ys().nullable().optional(),transcript:Ys().nullable()})))}),sr({itemId:Ys(),previousItemId:Ys().nullable().optional(),type:cr("message"),role:cr("assistant"),status:ur(["in_progress","completed","incomplete"]),content:nr(sr({type:cr("text"),text:Ys()}).or(sr({type:cr("audio"),audio:Ys().nullable().optional(),transcript:Ys().nullable().optional()})))})])),Cp=sr({itemId:Ys(),previousItemId:Ys().nullable().optional(),type:cr("function_call"),status:ur(["in_progress","completed"]),arguments:Ys(),name:Ys(),output:Ys().nullable()}),Op=sr({id:Ys().optional().nullable(),conversation_id:Ys().optional().nullable(),max_output_tokens:Qs().or(cr("inf")).optional().nullable(),metadata:ir(Ys(),tr()).optional().nullable(),modalities:nr(Ys()).optional().nullable(),object:cr("realtime.response").optional().nullable(),output:nr(tr()).optional().nullable(),output_audio_format:Ys().optional().nullable(),status:ur(["completed","incomplete","failed","cancelled","in_progress"]).optional().nullable(),status_details:ir(Ys(),tr()).optional().nullable(),usage:sr({input_tokens:Qs().optional(),input_tokens_details:ir(Ys(),tr()).optional().nullable(),output_tokens:Qs().optional(),output_tokens_details:ir(Ys(),tr()).optional().nullable()}).optional().nullable(),voice:Ys().optional().nullable()}),Rp=sr({id:Ys().optional(),audio:Ys().nullable().optional(),text:Ys().nullable().optional(),transcript:Ys().nullable().optional(),type:rr([cr("input_text"),cr("input_audio"),cr("item_reference"),cr("text"),cr("audio")])}),Ep=sr({id:Ys().optional(),arguments:Ys().optional(),call_id:Ys().optional(),content:nr(Rp).optional(),name:Ys().optional(),object:cr("realtime.item").optional(),output:Ys().optional(),role:ur(["user","assistant","system"]).optional(),status:ur(["completed","incomplete","in_progress"]).optional(),type:ur(["message","function_call","function_call_output"]).optional()}),Np=sr({type:cr("conversation.created"),event_id:Ys(),conversation:sr({id:Ys().optional(),object:cr("realtime.conversation").optional()})}),Pp=sr({type:cr("conversation.item.created"),event_id:Ys(),item:Ep,previous_item_id:Ys().nullable().optional()}),$p=sr({type:cr("conversation.item.deleted"),event_id:Ys(),item_id:Ys()}),Dp=sr({type:cr("conversation.item.input_audio_transcription.completed"),event_id:Ys(),item_id:Ys(),content_index:Qs(),transcript:Ys(),logprobs:nr(tr()).nullable().optional()}),jp=sr({type:cr("conversation.item.input_audio_transcription.delta"),event_id:Ys(),item_id:Ys(),content_index:Qs().optional(),delta:Ys().optional(),logprobs:nr(tr()).nullable().optional()}),Mp=sr({type:cr("conversation.item.input_audio_transcription.failed"),event_id:Ys(),item_id:Ys(),content_index:Qs(),error:sr({code:Ys().optional(),message:Ys().optional(),param:Ys().optional(),type:Ys().optional()})}),Zp=sr({type:cr("conversation.item.retrieved"),event_id:Ys(),item:Ep}),Lp=sr({type:cr("conversation.item.truncated"),event_id:Ys(),item_id:Ys(),audio_end_ms:Qs(),content_index:Qs()}),Fp=sr({type:cr("conversation.item.create"),item:Ep,event_id:Ys().optional(),previous_item_id:Ys().nullable().optional()}),qp=sr({type:cr("conversation.item.delete"),item_id:Ys(),event_id:Ys().optional()}),Up=sr({type:cr("conversation.item.retrieve"),item_id:Ys(),event_id:Ys().optional()}),Bp=sr({type:cr("conversation.item.truncate"),item_id:Ys(),audio_end_ms:Qs(),content_index:Qs(),event_id:Ys().optional()}),Jp=sr({type:cr("error"),event_id:Ys().optional(),error:tr().optional()}),zp=sr({type:cr("input_audio_buffer.cleared"),event_id:Ys()}),Wp=sr({type:cr("input_audio_buffer.append"),audio:Ys(),event_id:Ys().optional()}),Gp=sr({type:cr("input_audio_buffer.clear"),event_id:Ys().optional()}),Kp=sr({type:cr("input_audio_buffer.commit"),event_id:Ys().optional()}),Hp=sr({type:cr("input_audio_buffer.committed"),event_id:Ys(),item_id:Ys(),previous_item_id:Ys().nullable().optional()}),Vp=sr({type:cr("input_audio_buffer.speech_started"),event_id:Ys(),item_id:Ys(),audio_start_ms:Qs()}),Xp=sr({type:cr("input_audio_buffer.speech_stopped"),event_id:Ys(),item_id:Ys(),audio_end_ms:Qs()}),Yp=sr({type:cr("output_audio_buffer.started"),event_id:Ys()}).passthrough(),Qp=sr({type:cr("output_audio_buffer.stopped"),event_id:Ys()}).passthrough(),eh=sr({type:cr("output_audio_buffer.cleared"),event_id:Ys()}),th=sr({type:cr("rate_limits.updated"),event_id:Ys(),rate_limits:nr(sr({limit:Qs().optional(),name:ur(["requests","tokens"]).optional(),remaining:Qs().optional(),reset_seconds:Qs().optional()}))}),nh=sr({type:cr("response.audio.delta"),event_id:Ys(),item_id:Ys(),content_index:Qs(),delta:Ys(),output_index:Qs(),response_id:Ys()}),sh=sr({type:cr("response.audio.done"),event_id:Ys(),item_id:Ys(),content_index:Qs(),output_index:Qs(),response_id:Ys()}),rh=sr({type:cr("response.audio_transcript.delta"),event_id:Ys(),item_id:Ys(),content_index:Qs(),delta:Ys(),output_index:Qs(),response_id:Ys()}),ah=sr({type:cr("response.audio_transcript.done"),event_id:Ys(),item_id:Ys(),content_index:Qs(),transcript:Ys(),output_index:Qs(),response_id:Ys()}),ih=sr({type:cr("response.content_part.added"),event_id:Ys(),item_id:Ys(),content_index:Qs(),output_index:Qs(),response_id:Ys(),part:sr({audio:Ys().optional(),text:Ys().optional(),transcript:Ys().optional(),type:ur(["text","audio"]).optional()})}),oh=sr({type:cr("response.content_part.done"),event_id:Ys(),item_id:Ys(),content_index:Qs(),output_index:Qs(),response_id:Ys(),part:sr({audio:Ys().optional(),text:Ys().optional(),transcript:Ys().optional(),type:ur(["text","audio"]).optional()})}),ch=sr({type:cr("response.created"),event_id:Ys(),response:Op}),uh=sr({type:cr("response.done"),event_id:Ys(),response:Op}),lh=sr({type:cr("response.function_call_arguments.delta"),event_id:Ys(),item_id:Ys(),call_id:Ys(),delta:Ys(),output_index:Qs(),response_id:Ys()}),dh=sr({type:cr("response.function_call_arguments.done"),event_id:Ys(),item_id:Ys(),call_id:Ys(),arguments:Ys(),output_index:Qs(),response_id:Ys()}),ph=sr({type:cr("response.output_item.added"),event_id:Ys(),item:Ep,output_index:Qs(),response_id:Ys()}),hh=sr({type:cr("response.output_item.done"),event_id:Ys(),item:Ep,output_index:Qs(),response_id:Ys()}),mh=sr({type:cr("response.text.delta"),event_id:Ys(),item_id:Ys(),content_index:Qs(),delta:Ys(),output_index:Qs(),response_id:Ys()}),fh=sr({type:cr("response.text.done"),event_id:Ys(),item_id:Ys(),content_index:Qs(),text:Ys(),output_index:Qs(),response_id:Ys()}),gh=sr({type:cr("session.created"),event_id:Ys(),session:tr()}),_h=sr({type:cr("session.updated"),event_id:Ys(),session:tr()}),yh=sr({type:cr("response.cancel"),event_id:Ys().optional(),response_id:Ys().optional()}),vh=sr({type:cr("response.create"),event_id:Ys().optional(),response:tr().optional()}),wh=sr({type:cr("session.update"),event_id:Ys().optional(),session:tr()}),bh=sr({type:cr("transcription_session.update"),event_id:Ys().optional(),session:tr()}),xh=sr({type:cr("transcription_session.updated"),event_id:Ys(),session:tr()}),Sh=sr({type:Ys(),event_id:Ys().optional().nullable()}).passthrough(),kh=ar("type",[Np,Pp,$p,Dp,jp,Mp,Zp,Lp,Jp,zp,Hp,Vp,Xp,Yp,Qp,eh,th,nh,sh,rh,ah,ih,oh,ch,uh,lh,dh,ph,hh,mh,fh,gh,_h,xh]);function Ih(e){const t=JSON.parse(e.data.toString()),n=kh.safeParse(t);if(!n.success){const e=Sh.safeParse(t);return e.success?{data:e.data,isGeneric:!0}:{data:null,isGeneric:!0}}return{data:n.data,isGeneric:!1}}ar("type",[Fp,qp,Up,Bp,Wp,Gp,Kp,yh,vh,wh,bh]);const Th="gpt-4o-realtime-preview",Ah={voice:"ash",modalities:["text","audio"],inputAudioFormat:"pcm16",outputAudioFormat:"pcm16",inputAudioTranscription:{model:"gpt-4o-mini-transcribe"},turnDetection:{type:"semantic_vad"},inputAudioNoiseReduction:null,speed:1};class Ch extends Ra{#B;#K;#H=null;#V=null;eventEmitter=new br;constructor(e={}){super(),this.#B=e.model??Th,this.#K=e.apiKey}get currentModel(){return this.#B}set currentModel(e){this.#B=e}get _rawSessionConfig(){return this.#V??null}async _getApiKey(e){const t=e.apiKey??this.#K;return"function"==typeof t?await t():t}_onMessage(e){const{data:t,isGeneric:n}=Ih(e);if(null!==t&&(this.emit("*",t),!n))if("error"===t.type?this.emit("error",{type:"error",error:t}):this.emit(t.type,t),"response.created"!==t.type){if("session.updated"===t.type&&(this.#V=t.session),"response.done"===t.type){const e=uh.safeParse(t);if(!e.success)return void Tp.error("Error parsing response done event",e.error);const n=e.data.response.usage?.input_tokens??0,s=e.data.response.usage?.output_tokens??0,r=n+s,a=new ki({inputTokens:n,inputTokensDetails:e.data.response.usage?.input_tokens_details??{},outputTokens:s,outputTokensDetails:e.data.response.usage?.output_tokens_details??{},totalTokens:r});return this.emit("usage_update",a),void this.emit("turn_done",{type:"response_done",response:{id:e.data.response.id??"",output:e.data.response.output??[],usage:{inputTokens:n,inputTokensDetails:e.data.response.usage?.input_tokens_details??{},outputTokens:s,outputTokensDetails:e.data.response.usage?.output_tokens_details??{},totalTokens:r}}})}if("response.audio.done"!==t.type)if("conversation.item.deleted"!==t.type)if("conversation.item.input_audio_transcription.completed"!==t.type&&"conversation.item.truncated"!==t.type)if("conversation.item.input_audio_transcription.delta"!==t.type&&"response.text.delta"!==t.type&&"response.audio_transcript.delta"!==t.type&&"response.function_call_arguments.delta"!==t.type){if(("conversation.item.created"===t.type||"conversation.item.retrieved"===t.type)&&"message"===t.item.type){const e="conversation.item.created"===t.type?t.previous_item_id:null,n=Ap.parse({itemId:t.item.id,previousItemId:e,type:t.item.type,role:t.item.role,content:t.item.content,status:t.item.status});return void this.emit("item_update",n)}if("response.output_item.done"===t.type||"response.output_item.added"===t.type){const e=t.item;if("function_call"===e.type&&"completed"===e.status){const t=Cp.parse({itemId:e.id,type:e.type,status:"in_progress",arguments:e.arguments,name:e.name,output:null});return this.emit("item_update",t),void this.emit("function_call",{id:e.id,type:"function_call",callId:e.call_id??"",arguments:e.arguments??"",name:e.name??""})}if("message"===e.type){const e=Ap.parse({itemId:t.item.id,type:t.item.type,role:t.item.role,content:t.item.content,status:"in_progress"});return void this.emit("item_update",e)}}}else"response.audio_transcript.delta"===t.type&&this.emit("audio_transcript_delta",{type:"transcript_delta",delta:t.delta,itemId:t.item_id,responseId:t.response_id});else this.sendEvent({type:"conversation.item.retrieve",item_id:t.item_id});else this.emit("item_deleted",{itemId:t.item_id});else this.emit("audio_done")}else this.emit("turn_started",{type:"response_started",providerData:{...t}})}_onError(e){this.emit("error",{type:"error",error:e})}_onOpen(){this.emit("connected")}_onClose(){this.emit("disconnected")}sendMessage(e,t){this.sendEvent({type:"conversation.item.create",item:"string"==typeof e?{type:"message",role:"user",content:[{type:"input_text",text:e}]}:e,...t}),this.sendEvent({type:"response.create"})}_getMergedSessionConfig(e){const t={instructions:e.instructions,model:e.model??this.#B??Ah.model,voice:e.voice??Ah.voice,speed:e.speed??Ah.speed,modalities:e.modalities??Ah.modalities,input_audio_format:e.inputAudioFormat??Ah.inputAudioFormat,output_audio_format:e.outputAudioFormat??Ah.outputAudioFormat,input_audio_transcription:e.inputAudioTranscription??Ah.inputAudioTranscription,input_audio_noise_reduction:e.inputAudioNoiseReduction??Ah.inputAudioNoiseReduction,turn_detection:Ch.buildTurnDetectionConfig(e.turnDetection)??Ah.turnDetection,tool_choice:e.toolChoice??Ah.toolChoice,tools:e.tools?.map(e=>({...e,strict:void 0})),...e.providerData??{}};return t}static buildTurnDetectionConfig(e){if(void 0===e)return;const{type:t,createResponse:n,create_response:s,eagerness:r,interruptResponse:a,interrupt_response:i,prefixPaddingMs:o,prefix_padding_ms:c,silenceDurationMs:u,silence_duration_ms:l,threshold:d,...p}=e,h={type:t,create_response:n||s,eagerness:r,interrupt_response:a||i,prefix_padding_ms:o||c,silence_duration_ms:u||l,threshold:d,...p};return Object.keys(h).forEach(e=>{void 0===h[e]&&delete h[e]}),Object.keys(h).length>0?h:void 0}set _tracingConfig(e){this.#H=e}_updateTracingConfig(e){if(void 0===this.#H&&(this.#H=null),"auto"!==e){if("string"==typeof this.#H||"string"==typeof e)return null===e?(Tp.debug("Disabling tracing for this session. It cannot be turned on for this session from this point on."),void this.sendEvent({type:"session.update",session:{tracing:null}})):void(null!==this.#H&&"string"!=typeof this.#H?e?.group_id===this.#H?.group_id&&e?.metadata===this.#H?.metadata&&e?.workflow_name===this.#H?.workflow_name?this.sendEvent({type:"session.update",session:{tracing:e}}):Tp.warn("Mismatch in tracing config. Ignoring the new tracing config. This likely happens when you already set a tracing config on session creation. Current tracing config: %s, new tracing config: %s",JSON.stringify(this.#H),JSON.stringify(e)):this.sendEvent({type:"session.update",session:{tracing:e}}));Tp.warn("Tracing config is already set, skipping setting it again. This likely happens when you already set a tracing config on session creation.")}else this.sendEvent({type:"session.update",session:{tracing:"auto"}})}updateSessionConfig(e){const t=this._getMergedSessionConfig(e);this.sendEvent({type:"session.update",session:t})}sendFunctionCallOutput(e,t,n=!0){this.sendEvent({type:"conversation.item.create",item:{type:"function_call_output",output:t,call_id:e.callId}});try{const n=Cp.parse({itemId:e.id,previousItemId:e.previousItemId,type:"function_call",status:"completed",arguments:e.arguments,name:e.name,output:t});this.emit("item_update",n)}catch(t){Tp.error("Error parsing tool call item",t,e)}n&&this.sendEvent({type:"response.create"})}sendAudio(e,{commit:t=!1}={}){this.sendEvent({type:"input_audio_buffer.append",audio:yp(e)}),t&&this.sendEvent({type:"input_audio_buffer.commit"})}resetHistory(e,t){const{removals:n,additions:s,updates:r}=function(e,t){return{removals:e.filter(e=>!t.some(t=>t.itemId===e.itemId)),additions:t.filter(t=>!e.some(e=>e.itemId===t.itemId)),updates:t.filter(t=>e.some(e=>e.itemId===t.itemId&&JSON.stringify(e)!==JSON.stringify(t)))}}(e,t),a=new Set(n.map(e=>e.itemId));for(const e of r)a.add(e.itemId);if(a.size>0)for(const e of a)this.sendEvent({type:"conversation.item.delete",item_id:e});const i=[...s,...r];for(const e of i)if("message"===e.type){const t={type:"message",role:e.role,content:e.content,id:e.itemId};"system"!==e.role&&e.status&&(t.status=e.status),this.sendEvent({type:"conversation.item.create",item:t})}else"function_call"===e.type&&Tp.warn("Function calls cannot be manually added or updated at the moment. Ignoring.")}}class Oh extends Ch{options;#X;#Y={status:"disconnected",peerConnection:void 0,dataChannel:void 0};#Q;#ee=!1;#te=!1;constructor(e={}){if("undefined"==typeof RTCPeerConnection)throw new Error("WebRTC is not supported in this environment");super(e),this.options=e,this.#X=e.baseUrl??"https://api.openai.com/v1/realtime",this.#Q=e.useInsecureApiKey??!1}get status(){return this.#Y.status}get connectionState(){return this.#Y}get muted(){return this.#te}async connect(e){if("connected"===this.#Y.status)return;"connecting"===this.#Y.status&&Tp.warn("Realtime connection already in progress. Please await original promise");const t=e.model??this.currentModel;this.currentModel=t;const n=e.url??this.#X,s=await this._getApiKey(e),r="string"==typeof s&&s.startsWith("ek_");if(!this.#Q&&!r)throw new Kt("Using the WebRTC connection in a browser environment requires an insecure API key. Please use a WebSocket connection instead or set the useInsecureApiKey option to true.");return new Promise(async(t,r)=>{try{const a={...e.initialSessionConfig||{},model:this.currentModel},i=new URL(n);let o=new RTCPeerConnection;const c=o.createDataChannel("oai-events");this.#Y={status:"connecting",peerConnection:o,dataChannel:c},this.emit("connection_change",this.#Y.status),c.addEventListener("open",()=>{this.#Y={status:"connected",peerConnection:o,dataChannel:c},this.updateSessionConfig(a),this.emit("connection_change",this.#Y.status),this._onOpen(),t()}),c.addEventListener("error",e=>{this.close(),this._onError(e),r(e)}),c.addEventListener("message",e=>{this._onMessage(e);const{data:t,isGeneric:n}=Ih(e);t&&!n&&("response.created"===t.type?this.#ee=!0:"response.done"===t.type&&(this.#ee=!1),"session.created"===t.type&&(this._tracingConfig=t.session.tracing,this._updateTracingConfig(a.tracing??"auto")))});const u=this.options.audioElement??document.createElement("audio");u.autoplay=!0,o.ontrack=e=>{u.srcObject=e.streams[0]};const l=this.options.mediaStream??await navigator.mediaDevices.getUserMedia({audio:!0});o.addTrack(l.getAudioTracks()[0]),this.options.changePeerConnection&&(o=await this.options.changePeerConnection(o),this.#Y={...this.#Y,peerConnection:o});const d=await o.createOffer();if(await o.setLocalDescription(d),!d.sdp)throw new Error("Failed to create offer");const p={...this._getMergedSessionConfig(a),model:this.currentModel},h=new FormData;h.append("sdp",d.sdp),h.append("session",JSON.stringify(p));const m=await fetch(i,{method:"POST",body:h,headers:{Authorization:`Bearer ${s}`,"X-OpenAI-Agents-SDK":xp["X-OpenAI-Agents-SDK"]}}),f={type:"answer",sdp:await m.text()};await o.setRemoteDescription(f)}catch(e){this.close(),this._onError(e),r(e)}})}sendEvent(e){if(!this.#Y.dataChannel||"open"!==this.#Y.dataChannel.readyState)throw new Error("WebRTC data channel is not connected. Make sure you call `connect()` before sending events.");this.#Y.dataChannel.send(JSON.stringify(e))}mute(e){this.#te=e,this.#Y.peerConnection&&this.#Y.peerConnection.getSenders().forEach(t=>{t.track&&(t.track.enabled=!e)})}close(){if(this.#Y.dataChannel&&this.#Y.dataChannel.close(),this.#Y.peerConnection){const e=this.#Y.peerConnection;e.getSenders().forEach(e=>{e.track?.stop()}),e.close()}"disconnected"!==this.#Y.status&&(this.#Y={status:"disconnected",peerConnection:void 0,dataChannel:void 0},this.emit("connection_change",this.#Y.status),this._onClose())}interrupt(){this.#ee&&(this.sendEvent({type:"response.cancel"}),this.#ee=!1),this.sendEvent({type:"output_audio_buffer.clear"})}}const Rh=globalThis.WebSocket;class Eh extends Ch{#K;#X;#Y={status:"disconnected",websocket:void 0};#Q;#ne;#se;_firstAudioTimestamp;_audioLengthMs=0;#ee=!1;constructor(e={}){super(e),this.#X=`wss://api.openai.com/v1/realtime?model=${this.currentModel}`,this.#Q=e.useInsecureApiKey??!1}get status(){return this.#Y.status}get connectionState(){return this.#Y}get muted(){return null}get currentItemId(){return this.#ne}_onAudio(e){this.emit("audio",e)}#re(e,t,n){if(this.#Y.websocket)return void e();if(!this.#K)throw new Kt("API key is not set. Please call `connect()` with an API key first.");if(!this.#K.startsWith("ek_")&&!this.#Q)throw new Kt("Using the WebSocket connection in a browser environment requires an ephemeral client key. If you have to use a regular API key, set the `useInsecureApiKey` option to true.");const s=["realtime","openai-insecure-api-key."+this.#K,"openai-beta.realtime-v1",Sp],r=new Rh(this.#X,s);this.#Y={status:"connecting",websocket:r},this.emit("connection_change",this.#Y.status),r.addEventListener("open",()=>{this.#Y={status:"connected",websocket:r},this.emit("connection_change",this.#Y.status),this._onOpen(),e()}),r.addEventListener("error",e=>{this._onError(e),this.#Y={status:"disconnected",websocket:void 0},this.emit("connection_change",this.#Y.status),t(e)}),r.addEventListener("message",e=>{this._onMessage(e);const{data:t,isGeneric:s}=Ih(e);if(t&&!s)if("response.audio.delta"===t.type){this.#se=t.content_index,this.#ne=t.item_id,void 0===this._firstAudioTimestamp&&(this._firstAudioTimestamp=Date.now(),this._audioLengthMs=0);const e=_p(t.delta);(this._rawSessionConfig?.output_audio_format??"pcm16").startsWith("g711_")?this._audioLengthMs+=e.byteLength/8:this._audioLengthMs+=e.byteLength/24/2;const n={type:"audio",data:e,responseId:t.response_id};this._onAudio(n)}else if("input_audio_buffer.speech_started"===t.type){const e=this._rawSessionConfig?.turn_detection?.interrupt_response??!1;this.interrupt(!e)}else"response.created"===t.type?this.#ee=!0:"response.done"===t.type?this.#ee=!1:"session.created"===t.type&&(this._tracingConfig=t.session.tracing,this._updateTracingConfig(n.tracing??"auto"))}),r.addEventListener("close",()=>{this.#Y={status:"disconnected",websocket:void 0},this.emit("connection_change",this.#Y.status),this._onClose()})}async connect(e){const t=e.model??this.currentModel;this.currentModel=t,this.#K=await this._getApiKey(e),this.#X=e.url??`wss://api.openai.com/v1/realtime?model=${this.currentModel}`;const n={...e.initialSessionConfig||{},model:this.currentModel};await new Promise((e,t)=>{try{this.#re(e,t,n)}catch(e){t(e)}}),await this.updateSessionConfig(n)}sendEvent(e){if(!this.#Y.websocket)throw new Error("WebSocket is not connected. Make sure you call `connect()` before sending events.");this.#Y.websocket.send(JSON.stringify(e))}close(){this.#Y.websocket?.close(),this.#ne=void 0,this._firstAudioTimestamp=void 0,this._audioLengthMs=0,this.#se=void 0}mute(e){throw new Error("Mute is not supported for the WebSocket transport. You have to mute the audio input yourself.")}sendAudio(e,t={}){"connected"===this.#Y.status&&super.sendAudio(e,t)}_cancelResponse(){this.#ee&&(this.sendEvent({type:"response.cancel"}),this.#ee=!1)}_interrupt(e,t=!0){e<0||e>this._audioLengthMs||(t&&this._cancelResponse(),this.emit("audio_interrupted"),this.sendEvent({type:"conversation.item.truncate",item_id:this.#ne,content_index:this.#se,audio_end_ms:e}))}interrupt(e=!0){if(!this.#ne||"number"!=typeof this._firstAudioTimestamp)return;const t=Date.now()-this._firstAudioTimestamp;t>=0&&this._interrupt(t,e),this.#ne=void 0,this._firstAudioTimestamp=void 0,this._audioLengthMs=0,this.#se=void 0}}class Nh extends br{initialAgent;options;#ae;#ie;#oe=[];#ce;#ue=[];#le;#de={};#pe=[];#he;#me={};constructor(e,t={}){super(),this.initialAgent=e,this.options=t,void 0===t.transport&&"undefined"!=typeof window&&void 0!==window.RTCPeerConnection||"webrtc"===t.transport?this.#ae=new Oh:"websocket"===t.transport||void 0===t.transport?this.#ae=new Eh:this.#ae=t.transport,this.#ie=e,this.#ce=new Ii({...t.context??{},history:this.#pe}),this.#ue=(t.outputGuardrails??[]).map(Ip),this.#le={debounceTextLength:(t.outputGuardrailSettings??{}).debounceTextLength??100},this.#he=t.historyStoreAudio??!1}get transport(){return this.#ae}get currentAgent(){return this.#ie}get usage(){return this.#ce.usage}get context(){return this.#ce}get muted(){return this.#ae.muted}get history(){return this.#pe}async#fe(e){this.#ie=e;const t=this.#ie.handoffs.map(Za).map(e=>e.getHandoffAsFunctionTool());this.#oe=[...(await this.#ie.getAllTools()).filter(e=>"function"===e.type),...t]}async#ge(e={}){const t=await this.#ie.getSystemPrompt(this.#ce),n=this.options.tracingDisabled?null:this.options.workflowName?{workflow_name:this.options.workflowName}:"auto";return null!==n&&"auto"!==n?(this.options.groupId&&(n.group_id=this.options.groupId),this.options.traceMetadata&&(n.metadata=this.options.traceMetadata)):(this.options.groupId||this.options.traceMetadata)&&Tp.warn("In order to set traceMetadata or a groupId you need to specify a workflowName."),{instructions:t,voice:this.#ie.voice,model:this.options.model,tools:this.#oe,tracing:n,...e}}async updateAgent(e){return this.#ie.emit("agent_handoff",this.#ce,e),this.emit("agent_handoff",this.#ce,this.#ie,e),await this.#fe(e),await this.#ae.updateSessionConfig(await this.#ge()),e}async#_e(e,t){const n=await t.onInvokeHandoff(this.#ce,e.arguments);this.#ie.emit("agent_handoff",this.#ce,n),this.emit("agent_handoff",this.#ce,this.#ie,n),await this.#fe(n),await this.#ae.updateSessionConfig(await this.#ge());const s=Da(n);return this.#ae.sendFunctionCallOutput(e,s,!0),n}async#ye(e,t){this.#ce.context.history=JSON.parse(JSON.stringify(this.#pe));let n=e.arguments;if(t.parameters&&(n=Qt(t.parameters)?t.parameters.parse(n):JSON.parse(n)),await t.needsApproval(this.#ce,n,e.callId)){const n=this.context.isToolApproved({toolName:t.name,callId:e.callId});if(!1===n){this.emit("agent_tool_start",this.#ce,this.#ie,t,{toolCall:e}),this.#ie.emit("agent_tool_start",this.#ce,t,{toolCall:e});const n="Tool execution was not approved.";return this.#ae.sendFunctionCallOutput(e,n,!0),this.emit("agent_tool_end",this.#ce,this.#ie,t,n,{toolCall:e}),void this.#ie.emit("agent_tool_end",this.#ce,t,n,{toolCall:e})}if(void 0===n)return void this.emit("tool_approval_requested",this.#ce,this.#ie,{type:"function_approval",tool:t,approvalItem:new Zi(e,this.#ie)})}this.emit("agent_tool_start",this.#ce,this.#ie,t,{toolCall:e}),this.#ie.emit("agent_tool_start",this.#ce,t,{toolCall:e}),this.#ce.context.history=JSON.parse(JSON.stringify(this.#pe));const s=hn(await t.invoke(this.#ce,e.arguments));this.#ae.sendFunctionCallOutput(e,s,!0),this.emit("agent_tool_end",this.#ce,this.#ie,t,s,{toolCall:e}),this.#ie.emit("agent_tool_end",this.#ce,t,s,{toolCall:e})}async#ve(e){const t=new Map(this.#ie.handoffs.map(Za).map(e=>[e.toolName,e])),n=new Map((await this.#ie.getAllTools()).map(e=>[e.name,e])),s=t.get(e.name);if(s)await this.#_e(e,s);else{const t=n.get(e.name);if(!t||"function"!==t.type)throw new Gt(`Tool ${e.name} not found`);await this.#ye(e,t)}}async#L(e,t,n){if(0===this.#ue.length)return;const s={agent:this.#ie,agentOutput:e,context:this.#ce},r=(await Promise.all(this.#ue.map(e=>e.run(s)))).find(e=>e.output.tripwireTriggered);if(r){if(this.#me[t])return;this.#me[t]=!0;const e=new Yt(`Output guardrail triggered: ${JSON.stringify(r.output.outputInfo)}`,r);this.emit("guardrail_tripped",this.#ce,this.#ie,e,{itemId:n}),this.interrupt();const s=`\n⚠️ Your last answer was blocked. \nFailed Guardrail Reason: ${(a=r).guardrail.policyHint}. \nFailure Details: ${JSON.stringify(a.output.outputInfo??{})}. \nPlease respond again following policy. Apologize for not being able to answer the question (while avoiding the specific reason) and divert discussion back to an approved topic immediately and not invite more discussion.\n`.trim();return void this.sendMessage(s)}var a}#we(){this.#ae.on("*",e=>{if(this.emit("transport_event",e),"conversation.item.input_audio_transcription.completed"===e.type)try{const t=e;this.#pe=bp(this.#pe,t,this.#he),this.#ce.context.history=this.#pe,this.emit("history_updated",this.#pe)}catch(e){this.emit("error",{type:"error",error:e})}}),this.#ae.on("audio",e=>{this.emit("audio",e)}),this.#ae.on("turn_started",()=>{this.emit("agent_start",this.#ce,this.#ie),this.#ie.emit("agent_start",this.#ce,this.#ie)}),this.#ae.on("turn_done",e=>{const t=e.response.output[e.response.output.length-1],n=vp(t)??"",s=t?.id??"";this.emit("agent_end",this.#ce,this.#ie,n),this.#ie.emit("agent_end",this.#ce,n),this.#L(n,e.response.id,s)}),this.#ae.on("audio_done",()=>{this.emit("audio_stopped",this.#ce,this.#ie)});let e,t=0;this.#ae.on("audio_transcript_delta",n=>{try{const s=n.delta,r=n.itemId,a=n.responseId;e!==r&&(e=r,t=0);const i=(this.#de[r]??"")+s;if(this.#de[r]=i,this.#le.debounceTextLength<0)return;const o=Math.floor(i.length/this.#le.debounceTextLength);o>t&&(t=o,this.#L(i,a,r))}catch(e){this.emit("error",{type:"error",error:e})}}),this.#ae.on("item_update",e=>{try{const t=!this.#pe.some(t=>t.itemId===e.itemId);if(this.#pe=bp(this.#pe,e,this.#he),this.#ce.context.history=this.#pe,t){const t=this.#pe.find(t=>t.itemId===e.itemId);t&&this.emit("history_added",t)}this.emit("history_updated",this.#pe)}catch(e){this.emit("error",{type:"error",error:e})}}),this.#ae.on("item_deleted",e=>{try{this.#pe=this.#pe.filter(t=>t.itemId!==e.itemId),this.#ce.context.history=this.#pe,this.emit("history_updated",this.#pe)}catch(e){this.emit("error",{type:"error",error:e})}}),this.#ae.on("function_call",async e=>{try{await this.#ve(e)}catch(e){Tp.error("Error handling function call",e),this.emit("error",{type:"error",error:e})}}),this.#ae.on("usage_update",e=>{this.#ce.usage.add(e)}),this.#ae.on("audio_interrupted",()=>{this.emit("audio_interrupted",this.#ce,this.#ie)}),this.#ae.on("error",e=>{this.emit("error",e)})}async connect(e){await this.#fe(this.initialAgent),this.#we(),await this.#ae.connect({apiKey:e.apiKey??this.options.apiKey,model:this.options.model,initialSessionConfig:await this.#ge(this.options.config)}),this.#pe=[],this.emit("history_updated",this.#pe)}updateHistory(e){let t;t="function"==typeof e?e(this.#pe):e,this.#ae.resetHistory(this.#pe,t)}sendMessage(e,t={}){this.#ae.sendMessage(e,t)}mute(e){this.#ae.mute(e)}close(){this.#me={},this.#ae.close()}sendAudio(e,t={}){this.#ae.sendAudio(e,t)}interrupt(){this.#ae.interrupt()}async approve(e,t={alwaysApprove:!1}){this.#ce.approveTool(e,t);const n=this.#ie.tools.find(t=>t.name===e.rawItem.name);if(!n||"function"!==n.type||"function_call"!==e.rawItem.type)throw new Gt(`Tool ${e.rawItem.name} not found`);await this.#ye(e.rawItem,n)}async reject(e,t={alwaysReject:!1}){this.#ce.rejectTool(e,t);const n=this.#ie.tools.find(t=>t.name===e.rawItem.name);if(!n||"function"!==n.type||"function_call"!==e.rawItem.type)throw new Gt(`Tool ${e.rawItem.name} not found`);await this.#ye(e.rawItem,n)}}const Ph={base64ToArrayBuffer:_p,arrayBufferToBase64:yp,getLastTextFromAudioOutputMessage:vp};Fa(new hp),fp()})(),s})());